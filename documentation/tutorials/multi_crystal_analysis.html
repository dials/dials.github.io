

<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Multi-crystal analysis with DIALS and BLEND: individual vs joint refinement &#8212; DIALS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" href="../../_static/dials-styles.css" type="text/css" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Multi-crystal analysis with DIALS and xia2.multiplex" href="br_lyso_multi.html" />
    <link rel="prev" title="Refining multi-tile detector metrology with DIALS" href="metrology_corrections.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="logoheader container">
  <a href="../../index.html">
  <img class="logoheader" alt="DIALS" src="../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <a href="https://dials.github.io/dials-2.2/documentation/tutorials/multi_crystal_analysis.html" class="new-documentation">
This tutorial requires a DIALS 3 installation.<br/>
Please click here to go to the tutorial for DIALS 2.2.
</a><section id="multi-crystal-analysis-with-dials-and-blend-individual-vs-joint-refinement">
<h1>Multi-crystal analysis with DIALS and BLEND: individual vs joint refinement<a class="headerlink" href="#multi-crystal-analysis-with-dials-and-blend-individual-vs-joint-refinement" title="Link to this heading">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="http://www.ccp4.ac.uk/html/blend.html">BLEND</a> is a CCP4 program for analysis of multiple data sets. It attempts to
identify isomorphous clusters that may be scaled and merged together to form a
more complete multi-crystal dataset. Clustering in blend is based on the refined
cell parameters from integration, so it is important that these are determined
accurately. Unfortunately, for narrow wedges of data (where BLEND is most
useful) cell refinement may be complicated by issues such as the high
correlation between e.g. the detector distance and the cell volume.</p>
<p>One solution is to fix detector parameters during cell refinement so that the
detector is the same for every dataset processed. However, this is only feasible
if an accurate detector model is determined ahead of time, which might require
the use of a well-diffracting sacrificial crystal. If we only have the narrow
wedges of data available then it is more complicated to determine what the best
detector model would be to fix.</p>
<p>If we can make the assumption that the beam and detector <em>did not move</em> during
and between all of the datasets we collected then we can use DIALS joint
refinement to refine all of the crystal cells <em>at the same time</em>, simultaneously
with shared detector and beam models.</p>
<p>In this tutorial, we will attempt to do that for 73 sequences of data collected
from crystals of TehA, a well-diffracting integral membrane protein measured
using <em>in situ</em> diffraction from crystallisation plates at room temperature.
Each sequence provides between 4 and 10 degrees of data.</p>
<p>This tutorial is relatively advanced in that it requires high level scripting
of the DIALS command line programs, however candidate scripts are provided and
the tutorial will hopefully be easy enough to follow.</p>
</section>
<section id="individual-processing">
<h2>Individual processing<a class="headerlink" href="#individual-processing" title="Link to this heading">¶</a></h2>
<p>We start with a directory full of images. It is easy enough to figure out
which files belong with which sequence from the filename templates, however note
that the pattern between templates is not totally consistent. Most of the sequences
start with the prefix <code class="samp docutils literal notranslate"><span class="pre">xtal</span></code>, but some have just <code class="samp docutils literal notranslate"><span class="pre">xta</span></code>. One way of
getting around this annoyance would be to use the fact that each dataset has
a single <code class="samp docutils literal notranslate"><span class="pre">*.log</span></code> file associated with it and identify the different
datasets that way. However, we would prefer to come up with a protocol that
would work more generally, not just for the TehA data. Happily we  can just
let DIALS figure it out for us:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dials.import /path/to/TehA/*.cbf

The following parameters have been modified:

input {
  experiments = &lt;image files&gt;
}

--------------------------------------------------------------------------------
  format: &lt;class &#39;dxtbx.format.FormatCBFMiniPilatus.FormatCBFMiniPilatus&#39;&gt;
  num images: 2711
  sequences:
    still:    0
    sweep:    73
  num stills: 0
--------------------------------------------------------------------------------
Writing experiments to imported.expt
</pre></div>
</div>
<p>With a single command we have determined that there are 73 individual sequences
comprising 2711 total images. Running the following command will give us
information about each one of these datasets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">show</span> <span class="n">imported</span><span class="o">.</span><span class="n">expt</span>
</pre></div>
</div>
<p>That was a smooth start, but now things get abruptly more difficult.
Before we perform the joint analysis, we want to do the individual analysis
to compare to. This will also give us intermediate files so that we don’t have
to start from scratch when setting up the joint refinement job. Essentially
we just want to run a sequence of DIALS commands to process each recorded sequence.
However we can’t (currently) split the experimentlist into individual sequences with
a single command. We will have to start again with <strong class="program">dials.import</strong> for
each sequence individually - but we really don’t want to run this manually 73
times.</p>
<p>The solution is to write a script that will take the <code class="samp docutils literal notranslate"><span class="pre">imported.expt</span></code> as
input, extract the filename templates, and run the same processing commands
for each dataset. This script could be written in BASH, tcsh, perl,
ruby - whatever you feel most comfortable with. However here we will use Python,
or more specifically <strong class="program">dials.python</strong> because we will take advantage of
features in the cctbx to make it easy to write scripts that take advantage
of <a class="reference external" href="https://cctbx.github.io/libtbx/libtbx.easy_mp.html">parallel execution</a>.
Also we would like to read <code class="samp docutils literal notranslate"><span class="pre">imported.expt</span></code> with the DIALS API rather than
extracting the sequence templates using something like <strong class="program">grep</strong>.</p>
<p>The script we used to do this is reproduced below. You can copy this into a file,
save it as <code class="samp docutils literal notranslate"><span class="pre">process_TehA.py</span></code> and then run it as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="n">dials</span><span class="o">.</span><span class="n">python</span> <span class="n">process_TehA</span><span class="o">.</span><span class="n">py</span> <span class="n">imported</span><span class="o">.</span><span class="n">expt</span>
</pre></div>
</div>
<p>On a Linux desktop with a Core i7 CPU running at 3.07GHz the script took about 8
minutes to run (though file i/o is a significant factor)
and successfully processed 58 datasets. If time is short, you
might like to start running it now before reading the description of what the
script does. If time is <em>really</em> short then try uncommenting the line
<code class="samp docutils literal notranslate"><span class="pre">tasklist</span> <span class="pre">=</span> <span class="pre">tasklist[0:35]</span></code> to reduce the number of datasets processed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/env dials.python</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libtbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">easy_run</span><span class="p">,</span> <span class="n">easy_mp</span><span class="p">,</span> <span class="n">Auto</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dxtbx.serialize</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process_sequence</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Process a single sequence of data. The parameter &#39;task&#39; will be a</span>
<span class="sd">  tuple, the first element of which is an integer job number and the</span>
<span class="sd">  second is the filename template of the images to process&quot;&quot;&quot;</span>

  <span class="n">num</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">template</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

  <span class="c1"># create directory</span>
  <span class="n">newdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/sequence_</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num</span>
  <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newdir</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">newdir</span><span class="p">)</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dials.import template=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s2">&quot;dials.find_spots imported.expt&quot;</span><span class="p">)</span>

  <span class="c1"># initial indexing in P 1</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dials.index imported.expt strong.refl &quot;</span> <span class="o">+</span>\
    <span class="s2">&quot;output.experiments=P1_models.expt&quot;</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;P1_models.expt&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Job </span><span class="si">%02d</span><span class="s2"> failed in initial indexing&quot;</span> <span class="o">%</span> <span class="n">num</span>
    <span class="k">return</span>

  <span class="c1"># bootstrap from the refined P 1 cell</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dials.index P1_models.expt strong.refl space_group=&#39;H 3&#39;&quot;</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;indexed.expt&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Job </span><span class="si">%02d</span><span class="s2"> failed in indexing&quot;</span> <span class="o">%</span> <span class="n">num</span>
    <span class="k">return</span>

  <span class="c1"># static model refinement</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dials.refine indexed.expt indexed.refl scan_varying=false &quot;</span> <span class="o">+</span> \
    <span class="s2">&quot;outlier.algorithm=tukey&quot;</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;refined.expt&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Job </span><span class="si">%02d</span><span class="s2"> failed in refinement&quot;</span> <span class="o">%</span> <span class="n">num</span>
    <span class="k">return</span>

  <span class="c1"># WARNING! Fast and dirty integration.</span>
  <span class="c1"># Do not use the result for scaling/merging!</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dials.integrate refined.expt indexed.refl &quot;</span> <span class="o">+</span> \
    <span class="s2">&quot;profile.fitting=False prediction.d_min=7.0 prediction.d_max=8.1&quot;</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;integrated.refl&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Job </span><span class="si">%02d</span><span class="s2"> failed during integration&quot;</span> <span class="o">%</span> <span class="n">num</span>
    <span class="k">return</span>

  <span class="c1"># create MTZ</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dials.export refined.expt integrated.refl &quot;</span> <span class="o">+</span>\
    <span class="s2">&quot;intensity=sum mtz.hklout=integrated.mtz&quot;</span>
  <span class="n">easy_run</span><span class="o">.</span><span class="n">fully_buffered</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;integrated.mtz&quot;</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Job </span><span class="si">%02d</span><span class="s2"> failed during MTZ export&quot;</span> <span class="o">%</span> <span class="n">num</span>
    <span class="k">return</span>

  <span class="c1"># if we got this far, return the path to the MTZ</span>
  <span class="k">return</span> <span class="s2">&quot;sequence_</span><span class="si">%02d</span><span class="s2">/integrated.mtz&quot;</span> <span class="o">%</span> <span class="n">num</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Usage: dials.python process_TehA.py imported.expt&quot;</span><span class="p">)</span>

  <span class="n">expt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">experiment_list</span><span class="p">(</span><span class="n">expt_path</span><span class="p">,</span> <span class="n">check_format</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">templates</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">experiments</span><span class="o">.</span><span class="n">imagesets</span><span class="p">()]</span>
  <span class="n">tasklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">templates</span><span class="p">)))</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">tasklist</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No images found!&quot;</span><span class="p">)</span>

  <span class="c1"># uncomment the following line if short on time!</span>
  <span class="c1">#tasklist = tasklist[0:35]</span>

  <span class="n">nproc</span> <span class="o">=</span> <span class="n">easy_mp</span><span class="o">.</span><span class="n">get_processes</span><span class="p">(</span><span class="n">Auto</span><span class="p">)</span>

  <span class="nb">print</span> <span class="s2">&quot;Attempting to process the following datasets, with </span><span class="si">{}</span><span class="s2"> processes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasklist</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span>

  <span class="n">results</span> <span class="o">=</span> <span class="n">easy_mp</span><span class="o">.</span><span class="n">parallel_map</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="n">process_sequence</span><span class="p">,</span>
    <span class="n">iterable</span><span class="o">=</span><span class="n">tasklist</span><span class="p">,</span>
    <span class="n">processes</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span>
    <span class="n">preserve_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">good_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
  <span class="nb">print</span> <span class="s2">&quot;Successfully created the following MTZs:&quot;</span>
  <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">good_results</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">result</span>
</pre></div>
</div>
<p>We will now describe what is in this script. The first lines are
just imports to bring in modules from the Python standard library as well as
<code class="samp docutils literal notranslate"><span class="pre">easy_run</span></code> and <code class="samp docutils literal notranslate"><span class="pre">easy_mp</span></code> from <code class="samp docutils literal notranslate"><span class="pre">libtbx</span></code> (part of cctbx),
<code class="samp docutils literal notranslate"><span class="pre">serlialize.load</span></code> from <code class="samp docutils literal notranslate"><span class="pre">dxtbx</span></code> to read in the ExperimentList.
Following that is a definition for the function
<code class="samp docutils literal notranslate"><span class="pre">process_sequence</span></code> which will perform all the steps required to process one
dataset from images to unmerged MTZ. The code block under:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</pre></div>
</div>
<p>are the lines that are executed when the script starts. First we check that the
script has been passed a path to an experiments file. We then extract the 73 sequences
from this into a list, then get the filename templates from each element in the
list. We associate each of these templates with a number to form a list of
‘tasks’ to pass into <code class="samp docutils literal notranslate"><span class="pre">process_sequence</span></code>, but instead
of doing this in serial we can use <code class="samp docutils literal notranslate"><span class="pre">easy_mp</span></code> to run in parallel. This will
be okay because inside <code class="samp docutils literal notranslate"><span class="pre">process_sequence</span></code>, we ensure that all results are
written into a new directory. First we use a facility of the <code class="samp docutils literal notranslate"><span class="pre">easy_mp</span></code>
module to determine the number of processes to run in parallel and then we submit
the job with <code class="samp docutils literal notranslate"><span class="pre">parallel_map</span></code>.</p>
<p>The commands that are inside the function are usual dials commands,
familiar from other tutorials. There are a couple of interesting points
to note though. We know that the correct space group is <em>H</em> 3, but it turns out
that if we ask <strong class="program">dials.index</strong> to find an <em>H</em> 3 cell right from the start
then many of the sequences fail to index. This is simply because the initial models
contained in <code class="samp docutils literal notranslate"><span class="pre">imported.expt</span></code> are too poor to locate a cell with the
symmetry constraints. However, for many of the sequences the indexing program will
refine the <em>P</em> 1 solution to the correct cell. For this reason we first run
indexing in <em>P</em> 1:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">index</span> <span class="n">imported</span><span class="o">.</span><span class="n">expt</span> <span class="n">strong</span><span class="o">.</span><span class="n">refl</span> <span class="n">output</span><span class="o">.</span><span class="n">experiments</span><span class="o">=</span><span class="n">P1_models</span><span class="o">.</span><span class="n">expt</span>
</pre></div>
</div>
<p>and then we feed the refined <code class="file docutils literal notranslate"><span class="pre">P1_models.expt</span></code> back into
<strong class="program">dials.index</strong> specifying the correct symmetry:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">index</span> <span class="n">P1_models</span><span class="o">.</span><span class="n">expt</span> <span class="n">strong</span><span class="o">.</span><span class="n">refl</span> <span class="n">space_group</span><span class="o">=</span><span class="s1">&#39;H 3&#39;</span>
</pre></div>
</div>
<p>When <strong class="program">dials.index</strong> is passed a <code class="file docutils literal notranslate"><span class="pre">models.expt</span></code> containing
a crystal model rather than just a <code class="file docutils literal notranslate"><span class="pre">imported.expt</span></code> then it automatically
uses a <code class="samp docutils literal notranslate"><span class="pre">known_orientation</span></code> indexer, which avoids doing the basis vector
search again. It uses the basis of the refined <em>P</em> 1 cell and just assigns
indices under the assumption of <em>H</em> 3 symmetry. The symmetry constraints are
then enforced during the refinement steps carried out by <strong class="program">dials.index</strong>.
This procedure gives us a greater success rate of indexing in <em>H</em> 3, and required
no manual intervention.</p>
<p>Following indexing we do scan-static cell refinement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">refine</span> <span class="n">indexed</span><span class="o">.</span><span class="n">expt</span> <span class="n">indexed</span><span class="o">.</span><span class="n">refl</span> <span class="n">scan_varying</span><span class="o">=</span><span class="n">false</span> <span class="n">outlier</span><span class="o">.</span><span class="n">algorithm</span><span class="o">=</span><span class="n">tukey</span>
</pre></div>
</div>
<p>Outlier rejection was switched on in an attempt to avoid any zingers or other
errant spots from affecting our refined cells. Without analysing the data closer
it is not clear whether there are any particularly bad outliers here. We could repeat
the whole analysis with this switched off if we want to investigate more closely,
or look through all the <code class="file docutils literal notranslate"><span class="pre">dials.refine.log</span></code> files to see results of the
outlier rejection step.</p>
<p>We don’t bother with the time-consuming step of scan-varying refinement, because
it is the scan-static cell that will be written into the MTZ header. Scan-
varying refinement would give us better models for integration but as we will
only be running blend in ‘analysis’ mode we are in the unusual situation of not
actually caring what the intensities are. In this case, the MTZ file is just a
carrier for the globally refined unit cell!</p>
<p>Following refinement we integrate the data in a very quick and dirty way, simply
to get an MTZ file as fast as possible. This is a terrible way to integrate
data usually!:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">integrate</span> <span class="n">refined</span><span class="o">.</span><span class="n">expt</span> <span class="n">indexed</span><span class="o">.</span><span class="n">refl</span> <span class="n">profile</span><span class="o">.</span><span class="n">fitting</span><span class="o">=</span><span class="kc">False</span> <span class="n">prediction</span><span class="o">.</span><span class="n">d_min</span><span class="o">=</span><span class="mf">7.0</span> <span class="n">prediction</span><span class="o">.</span><span class="n">d_max</span><span class="o">=</span><span class="mf">8.1</span>
</pre></div>
</div>
<p>The <code class="samp docutils literal notranslate"><span class="pre">profile.fitting=False</span></code> option ensures we only do summation integration,
no profile fitting, while the <code class="samp docutils literal notranslate"><span class="pre">prediction.dmin=7.0</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">prediction.dmax=8.1</span></code> options only integrate data between 7.0 and 8.1 Angstroms.
As a result few reflections will be integrated. The MTZ file here is just
being used as a carrier of the cell information into blend. By restricting the
resolution range this way we are making it obvious that the content of the file
is useless for any other purpose.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not use the data produced by this script for scaling and merging. More
careful processing should be done first!</p>
</div>
<p>Finally we use <strong class="program">dials.export</strong> to create an MTZ file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">export</span> <span class="n">refined</span><span class="o">.</span><span class="n">expt</span> <span class="n">integrated</span><span class="o">.</span><span class="n">refl</span> <span class="n">intensity</span><span class="o">=</span><span class="nb">sum</span> <span class="n">mtz</span><span class="o">.</span><span class="n">hklout</span><span class="o">=</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
</pre></div>
</div>
<p>After each of these major steps we check whether the last command ran successfully
by checking for the existence of an expected output file. If the file does not
exist we make no effort to rescue the dataset, we just return early from the
<code class="samp docutils literal notranslate"><span class="pre">process_sequence</span></code> function, freeing up a process so that
<code class="samp docutils literal notranslate"><span class="pre">parallel_map</span></code> can start up the next.</p>
<p>Here is the output of a run of the script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Attempting</span> <span class="n">to</span> <span class="n">process</span> <span class="n">the</span> <span class="n">following</span> <span class="n">datasets</span><span class="p">,</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">processes</span>
<span class="mi">0</span><span class="p">:</span> <span class="o">/</span><span class="n">joint</span><span class="o">-</span><span class="n">refinement</span><span class="o">-</span><span class="n">img</span><span class="o">/</span><span class="n">xta30_1_</span><span class="c1">####.cbf</span>
<span class="mi">1</span><span class="p">:</span> <span class="o">/</span><span class="n">joint</span><span class="o">-</span><span class="n">refinement</span><span class="o">-</span><span class="n">img</span><span class="o">/</span><span class="n">xta31_1_</span><span class="c1">####.cbf</span>

<span class="o">...</span>

<span class="mi">71</span><span class="p">:</span> <span class="o">/</span><span class="n">joint</span><span class="o">-</span><span class="n">refinement</span><span class="o">-</span><span class="n">img</span><span class="o">/</span><span class="n">xtal7_1_</span><span class="c1">####.cbf</span>
<span class="mi">72</span><span class="p">:</span> <span class="o">/</span><span class="n">joint</span><span class="o">-</span><span class="n">refinement</span><span class="o">-</span><span class="n">img</span><span class="o">/</span><span class="n">xtal8_1_</span><span class="c1">####.cbf</span>
<span class="n">Job</span> <span class="mi">06</span> <span class="n">failed</span> <span class="ow">in</span> <span class="n">initial</span> <span class="n">indexing</span>
<span class="n">Job</span> <span class="mi">05</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">07</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">10</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">15</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">18</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">30</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">34</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">37</span> <span class="n">failed</span> <span class="ow">in</span> <span class="n">initial</span> <span class="n">indexing</span>
<span class="n">Job</span> <span class="mi">36</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">52</span> <span class="n">failed</span> <span class="ow">in</span> <span class="n">initial</span> <span class="n">indexing</span>
<span class="n">Job</span> <span class="mi">51</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">49</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">56</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Job</span> <span class="mi">72</span> <span class="n">failed</span> <span class="n">during</span> <span class="n">integration</span>
<span class="n">Successfully</span> <span class="n">created</span> <span class="n">the</span> <span class="n">following</span> <span class="n">MTZs</span><span class="p">:</span>
<span class="n">sequence_00</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_01</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_02</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_03</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_04</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_08</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_09</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_11</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_12</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_13</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_14</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_16</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_17</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_19</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_20</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_21</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_22</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_23</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_24</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_25</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_26</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_27</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_28</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_29</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_31</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_32</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_33</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_35</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_38</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_39</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_40</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_41</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_42</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_43</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_44</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_45</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_46</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_47</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_48</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_50</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_53</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_54</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_55</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_57</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_58</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_59</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_60</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_61</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_62</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_63</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_64</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_65</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_66</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_67</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_68</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_69</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_70</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>
<span class="n">sequence_71</span><span class="o">/</span><span class="n">integrated</span><span class="o">.</span><span class="n">mtz</span>

<span class="n">real</span>  <span class="mi">9</span><span class="n">m56</span><span class="mf">.401</span><span class="n">s</span>
<span class="n">user</span>  <span class="mi">29</span><span class="n">m36</span><span class="mf">.650</span><span class="n">s</span>
<span class="n">sys</span>     <span class="mi">8</span><span class="n">m3</span><span class="mf">.996</span><span class="n">s</span>
</pre></div>
</div>
</section>
<section id="analysis-of-individually-processed-datasets">
<h2>Analysis of individually processed datasets<a class="headerlink" href="#analysis-of-individually-processed-datasets" title="Link to this heading">¶</a></h2>
<p>The paths to <code class="file docutils literal notranslate"><span class="pre">integrated.mtz</span></code> files can be copied directly into a file,
say <code class="file docutils literal notranslate"><span class="pre">individual_mtzs.dat</span></code>, and passed to BLEND for analysis:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;END&quot;</span> <span class="o">|</span> <span class="n">blend</span> <span class="o">-</span><span class="n">a</span> <span class="n">individual_mtzs</span><span class="o">.</span><span class="n">dat</span>
</pre></div>
</div>
<p>The dendrogram resulting from clustering is shown here:</p>
<blockquote>
<div><img alt="https://dials.github.io/images/multi_crystal_analysis/tree.png" src="https://dials.github.io/images/multi_crystal_analysis/tree.png" />
</div></blockquote>
<p>As we can see, the linear cell variation is less than 1%, with an absolute
value of 0.79 Angstroms, indicating good isomorphism amongst the datasets.
If any extreme outliers had been shown by the plot, one can inspect the
file <code class="file docutils literal notranslate"><span class="pre">FINAL_list_of_files.dat</span></code> to see which sequence the blend numbering
relates to. These files could then be removed from <code class="file docutils literal notranslate"><span class="pre">individual_mtzs.dat</span></code>
before rerunning BLEND.</p>
</section>
<section id="joint-refinement">
<h2>Joint refinement<a class="headerlink" href="#joint-refinement" title="Link to this heading">¶</a></h2>
<p>Now that we have done the BLEND analysis for individually processed datasets,
we would like to do joint refinement of the crystals to reduce correlations
between the detector or beam parameters with individual crystals. As motivation
we may look at these correlations for one of these datasets. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sequence_00</span>
<span class="n">dials</span><span class="o">.</span><span class="n">refine</span> <span class="n">indexed</span><span class="o">.</span><span class="n">expt</span> <span class="n">indexed</span><span class="o">.</span><span class="n">refl</span> <span class="n">scan_varying</span><span class="o">=</span><span class="n">false</span> \
  <span class="n">track_parameter_correlation</span><span class="o">=</span><span class="n">true</span> <span class="n">correlation_plot</span><span class="o">.</span><span class="n">filename</span><span class="o">=</span><span class="n">corrplot</span><span class="o">.</span><span class="n">png</span>
<span class="n">cd</span> <span class="o">..</span>
</pre></div>
</div>
<p>The new file <code class="file docutils literal notranslate"><span class="pre">sequence_00/corrplot_X.png</span></code> shows correlations between parameters
refined with this single 8 degree dataset (see also correlations in Y and Phi).
Clearly parameters like the detector distance and the crystal metrical matrix
parameters are highly correlated.</p>
<blockquote>
<div><img alt="https://dials.github.io/images/multi_crystal_analysis/corrplot_X.png" src="https://dials.github.io/images/multi_crystal_analysis/corrplot_X.png" />
</div></blockquote>
<p>Although the DIALS toolkit has a sophisticated mechanism for modelling
multi-experiment data, the user interface for handling such data is somewhat
limited. In order to do joint refinement of the sequences we need to combine them
into a single multi-experiment <code class="file docutils literal notranslate"><span class="pre">combined.expt</span></code> and corresponding
<code class="file docutils literal notranslate"><span class="pre">combined.refl</span></code>. Whilst doing this we want to reduce the separate
detector, beam and goniometer models for each experiment into a single shared
model of each type. The program <strong class="program">dials.combine_experiments</strong> can
be used for this, but first we have to prepare an input file with a text editor
listing the individual sequences in order. We can use
<code class="file docutils literal notranslate"><span class="pre">individual_mtzs.dat</span></code> as a template to start with. In our case the final
file looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="p">{</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_00</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_01</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_02</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_03</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_04</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_08</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_09</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_11</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_12</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_13</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_14</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_16</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_17</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_19</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_20</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_21</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_22</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_23</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_24</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_25</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_26</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_27</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_28</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_29</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_31</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_32</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_33</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_35</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_38</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_39</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_40</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_41</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_42</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_43</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_44</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_45</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_46</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_47</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_48</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_50</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_53</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_54</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_55</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_57</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_58</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_59</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_60</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_61</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_62</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_63</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_64</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_65</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_66</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_67</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_68</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_69</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_70</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">sequence_71</span><span class="o">/</span><span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_00</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_01</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_02</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_03</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_04</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_08</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_09</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_11</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_12</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_13</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_14</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_16</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_17</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_19</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_20</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_21</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_22</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_23</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_24</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_25</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_26</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_27</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_28</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_29</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_31</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_32</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_33</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_35</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_38</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_39</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_40</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_41</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_42</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_43</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_44</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_45</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_46</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_47</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_48</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_50</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_53</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_54</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_55</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_57</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_58</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_59</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_60</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_61</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_62</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_63</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_64</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_65</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_66</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_67</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_68</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_69</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_70</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">sequence_71</span><span class="o">/</span><span class="n">indexed</span><span class="o">.</span><span class="n">refl</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We called this file <code class="file docutils literal notranslate"><span class="pre">experiments_and_reflections.phil</span></code> then run
<strong class="program">dials.combine_experiments</strong> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">combine_experiments</span> <span class="n">experiments_and_reflections</span><span class="o">.</span><span class="n">phil</span> \
  <span class="n">reference_from_experiment</span><span class="o">.</span><span class="n">beam</span><span class="o">=</span><span class="mi">0</span> \
  <span class="n">reference_from_experiment</span><span class="o">.</span><span class="n">goniometer</span><span class="o">=</span><span class="mi">0</span> \
  <span class="n">reference_from_experiment</span><span class="o">.</span><span class="n">detector</span><span class="o">=</span><span class="mi">0</span> \
  <span class="n">compare_models</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
<p>The <code class="samp docutils literal notranslate"><span class="pre">reference_from_experiment</span></code> options tell the program to replace all
beam, goniometer and detector models in the input experiments with those
models taken from the first experiment, i.e. experiment ‘0’ using 0-based
indexing. If you run without <code class="samp docutils literal notranslate"><span class="pre">compare_models=False</span></code>, you’ll see that the beam
models are not similar enough to pass the tolerance tests in combine_experiments.
The output lists the number of reflections in each sequence contributing
to the final <code class="file docutils literal notranslate"><span class="pre">combined.refl</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">--------------------------------------</span>
<span class="o">|</span> <span class="n">Experiment</span> <span class="o">|</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">reflections</span> <span class="o">|</span>
<span class="o">--------------------------------------</span>
<span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span> <span class="mi">1471</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span>          <span class="o">|</span> <span class="mi">1464</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>          <span class="o">|</span> <span class="mi">1232</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>          <span class="o">|</span> <span class="mi">1381</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">4</span>          <span class="o">|</span> <span class="mi">1588</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">5</span>          <span class="o">|</span> <span class="mi">616</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mi">6</span>          <span class="o">|</span> <span class="mi">1642</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">7</span>          <span class="o">|</span> <span class="mi">1083</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">8</span>          <span class="o">|</span> <span class="mi">1210</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">9</span>          <span class="o">|</span> <span class="mi">1000</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">10</span>         <span class="o">|</span> <span class="mi">1529</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">11</span>         <span class="o">|</span> <span class="mi">1430</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">12</span>         <span class="o">|</span> <span class="mi">1261</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">13</span>         <span class="o">|</span> <span class="mi">1587</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">14</span>         <span class="o">|</span> <span class="mi">1727</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">15</span>         <span class="o">|</span> <span class="mi">1358</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">16</span>         <span class="o">|</span> <span class="mi">1049</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">17</span>         <span class="o">|</span> <span class="mi">1830</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">18</span>         <span class="o">|</span> <span class="mi">1477</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">19</span>         <span class="o">|</span> <span class="mi">2033</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">20</span>         <span class="o">|</span> <span class="mi">1308</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">21</span>         <span class="o">|</span> <span class="mi">1856</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">22</span>         <span class="o">|</span> <span class="mi">1830</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">23</span>         <span class="o">|</span> <span class="mi">1654</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">24</span>         <span class="o">|</span> <span class="mi">1048</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">25</span>         <span class="o">|</span> <span class="mi">1695</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">26</span>         <span class="o">|</span> <span class="mi">2398</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">27</span>         <span class="o">|</span> <span class="mi">2173</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">28</span>         <span class="o">|</span> <span class="mi">2869</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">29</span>         <span class="o">|</span> <span class="mi">3181</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">30</span>         <span class="o">|</span> <span class="mi">2810</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">31</span>         <span class="o">|</span> <span class="mi">1563</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">32</span>         <span class="o">|</span> <span class="mi">3508</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">33</span>         <span class="o">|</span> <span class="mi">2985</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">34</span>         <span class="o">|</span> <span class="mi">2526</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">35</span>         <span class="o">|</span> <span class="mi">2453</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">36</span>         <span class="o">|</span> <span class="mi">1738</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">37</span>         <span class="o">|</span> <span class="mi">1152</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">38</span>         <span class="o">|</span> <span class="mi">981</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mi">39</span>         <span class="o">|</span> <span class="mi">1336</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">40</span>         <span class="o">|</span> <span class="mi">1331</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">41</span>         <span class="o">|</span> <span class="mi">641</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mi">42</span>         <span class="o">|</span> <span class="mi">1052</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">43</span>         <span class="o">|</span> <span class="mi">1364</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">44</span>         <span class="o">|</span> <span class="mi">2114</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">45</span>         <span class="o">|</span> <span class="mi">2063</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">46</span>         <span class="o">|</span> <span class="mi">2139</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">47</span>         <span class="o">|</span> <span class="mi">1570</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">48</span>         <span class="o">|</span> <span class="mi">2334</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">49</span>         <span class="o">|</span> <span class="mi">1645</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">50</span>         <span class="o">|</span> <span class="mi">2499</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">51</span>         <span class="o">|</span> <span class="mi">2227</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">52</span>         <span class="o">|</span> <span class="mi">971</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mi">53</span>         <span class="o">|</span> <span class="mi">1130</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">54</span>         <span class="o">|</span> <span class="mi">2376</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">55</span>         <span class="o">|</span> <span class="mi">1211</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">56</span>         <span class="o">|</span> <span class="mi">1190</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">57</span>         <span class="o">|</span> <span class="mi">652</span>                   <span class="o">|</span>
<span class="o">--------------------------------------</span>
<span class="n">Saving</span> <span class="n">combined</span> <span class="n">experiments</span> <span class="n">to</span> <span class="n">combined</span><span class="o">.</span><span class="n">expt</span>
<span class="n">Saving</span> <span class="n">combined</span> <span class="n">reflections</span> <span class="n">to</span> <span class="n">combined</span><span class="o">.</span><span class="n">refl</span>
</pre></div>
</div>
<p>We may also inspect the contents of <code class="file docutils literal notranslate"><span class="pre">combined.expt</span></code>, by using
<strong class="program">dials.show</strong>, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">show</span> <span class="n">combined</span><span class="o">.</span><span class="n">expt</span>
</pre></div>
</div>
<p>Useful though this is, it is clear how this could become unwieldy as the number
of experiments increases. Work on better interfaces to multi-crystal (or
generally, multi-experiment) data is ongoing within the DIALS project.
Suggestions are always welcome!</p>
<p>Now we have the joint experiments and reflections files we can run our multi-
crystal refinement job:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">refine</span> <span class="n">combined</span><span class="o">.</span><span class="n">expt</span> <span class="n">combined</span><span class="o">.</span><span class="n">refl</span> \
  <span class="n">scan_varying</span><span class="o">=</span><span class="n">false</span> <span class="n">outlier</span><span class="o">.</span><span class="n">algorithm</span><span class="o">=</span><span class="n">tukey</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">following</span> <span class="n">parameters</span> <span class="n">have</span> <span class="n">been</span> <span class="n">modified</span><span class="p">:</span>

<span class="n">refinement</span> <span class="p">{</span>
  <span class="n">parameterisation</span> <span class="p">{</span>
    <span class="n">scan_varying</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="p">}</span>
  <span class="n">reflections</span> <span class="p">{</span>
    <span class="n">outlier</span> <span class="p">{</span>
      <span class="n">algorithm</span> <span class="o">=</span> <span class="n">null</span> <span class="n">auto</span> <span class="n">mcd</span> <span class="o">*</span><span class="n">tukey</span> <span class="n">sauter_poon</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nb">input</span> <span class="p">{</span>
  <span class="n">experiments</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">expt</span>
  <span class="n">reflections</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">refl</span>
<span class="p">}</span>

<span class="n">Configuring</span> <span class="n">refiner</span>

<span class="n">Summary</span> <span class="n">statistics</span> <span class="k">for</span> <span class="mi">96848</span> <span class="n">observations</span> <span class="n">matched</span> <span class="n">to</span> <span class="n">predictions</span><span class="p">:</span>
<span class="o">--------------------------------------------------------------------</span>
<span class="o">|</span>                   <span class="o">|</span> <span class="n">Min</span>    <span class="o">|</span> <span class="n">Q1</span>      <span class="o">|</span> <span class="n">Med</span>      <span class="o">|</span> <span class="n">Q3</span>     <span class="o">|</span> <span class="n">Max</span>   <span class="o">|</span>
<span class="o">--------------------------------------------------------------------</span>
<span class="o">|</span> <span class="n">Xc</span> <span class="o">-</span> <span class="n">Xo</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>      <span class="o">|</span> <span class="o">-</span><span class="mf">9.637</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.8559</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.04029</span> <span class="o">|</span> <span class="mf">0.8264</span> <span class="o">|</span> <span class="mf">13.31</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Yc</span> <span class="o">-</span> <span class="n">Yo</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>      <span class="o">|</span> <span class="o">-</span><span class="mf">27.99</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.5649</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.02585</span> <span class="o">|</span> <span class="mf">0.4819</span> <span class="o">|</span> <span class="mf">27.1</span>  <span class="o">|</span>
<span class="o">|</span> <span class="n">Phic</span> <span class="o">-</span> <span class="n">Phio</span> <span class="p">(</span><span class="n">deg</span><span class="p">)</span> <span class="o">|</span> <span class="o">-</span><span class="mf">37.46</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.1734</span> <span class="o">|</span> <span class="mf">0.001499</span> <span class="o">|</span> <span class="mf">0.1756</span> <span class="o">|</span> <span class="mf">39.32</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">X</span> <span class="n">weights</span>         <span class="o">|</span> <span class="mf">232.3</span>  <span class="o">|</span> <span class="mf">359.5</span>   <span class="o">|</span> <span class="mf">378.5</span>    <span class="o">|</span> <span class="mf">392.9</span>  <span class="o">|</span> <span class="mf">405.6</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Y</span> <span class="n">weights</span>         <span class="o">|</span> <span class="mf">246.2</span>  <span class="o">|</span> <span class="mf">390.2</span>   <span class="o">|</span> <span class="mi">399</span>      <span class="o">|</span> <span class="mf">403.2</span>  <span class="o">|</span> <span class="mf">405.6</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Phi</span> <span class="n">weights</span>       <span class="o">|</span> <span class="mf">262.1</span>  <span class="o">|</span> <span class="mf">299.8</span>   <span class="o">|</span> <span class="mi">300</span>      <span class="o">|</span> <span class="mi">300</span>    <span class="o">|</span> <span class="mi">300</span>   <span class="o">|</span>
<span class="o">--------------------------------------------------------------------</span>

<span class="n">Detecting</span> <span class="n">centroid</span> <span class="n">outliers</span> <span class="n">using</span> <span class="n">the</span> <span class="n">Tukey</span> <span class="n">algorithm</span>
<span class="mi">9352</span> <span class="n">reflections</span> <span class="n">have</span> <span class="n">been</span> <span class="n">flagged</span> <span class="k">as</span> <span class="n">outliers</span>

<span class="n">Summary</span> <span class="n">statistics</span> <span class="k">for</span> <span class="mi">87496</span> <span class="n">observations</span> <span class="n">matched</span> <span class="n">to</span> <span class="n">predictions</span><span class="p">:</span>
<span class="o">--------------------------------------------------------------------</span>
<span class="o">|</span>                   <span class="o">|</span> <span class="n">Min</span>    <span class="o">|</span> <span class="n">Q1</span>      <span class="o">|</span> <span class="n">Med</span>      <span class="o">|</span> <span class="n">Q3</span>     <span class="o">|</span> <span class="n">Max</span>   <span class="o">|</span>
<span class="o">--------------------------------------------------------------------</span>
<span class="o">|</span> <span class="n">Xc</span> <span class="o">-</span> <span class="n">Xo</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>      <span class="o">|</span> <span class="o">-</span><span class="mf">9.637</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.89</span>   <span class="o">|</span> <span class="o">-</span><span class="mf">0.02594</span> <span class="o">|</span> <span class="mf">0.8807</span> <span class="o">|</span> <span class="mf">13.31</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Yc</span> <span class="o">-</span> <span class="n">Yo</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>      <span class="o">|</span> <span class="o">-</span><span class="mf">11.78</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.5064</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.02297</span> <span class="o">|</span> <span class="mf">0.4352</span> <span class="o">|</span> <span class="mf">11.87</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Phic</span> <span class="o">-</span> <span class="n">Phio</span> <span class="p">(</span><span class="n">deg</span><span class="p">)</span> <span class="o">|</span> <span class="o">-</span><span class="mf">8.19</span>  <span class="o">|</span> <span class="o">-</span><span class="mf">0.1399</span> <span class="o">|</span> <span class="mf">0.001485</span> <span class="o">|</span> <span class="mf">0.1429</span> <span class="o">|</span> <span class="mf">8.693</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">X</span> <span class="n">weights</span>         <span class="o">|</span> <span class="mf">232.3</span>  <span class="o">|</span> <span class="mf">359.3</span>   <span class="o">|</span> <span class="mf">378.3</span>    <span class="o">|</span> <span class="mf">392.6</span>  <span class="o">|</span> <span class="mf">405.6</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Y</span> <span class="n">weights</span>         <span class="o">|</span> <span class="mf">246.2</span>  <span class="o">|</span> <span class="mf">390.6</span>   <span class="o">|</span> <span class="mf">399.1</span>    <span class="o">|</span> <span class="mf">403.2</span>  <span class="o">|</span> <span class="mf">405.6</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Phi</span> <span class="n">weights</span>       <span class="o">|</span> <span class="mf">262.1</span>  <span class="o">|</span> <span class="mi">300</span>     <span class="o">|</span> <span class="mi">300</span>      <span class="o">|</span> <span class="mi">300</span>    <span class="o">|</span> <span class="mi">300</span>   <span class="o">|</span>
<span class="o">--------------------------------------------------------------------</span>

<span class="n">There</span> <span class="n">are</span> <span class="mi">297</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">refine</span> <span class="n">against</span> <span class="mi">87496</span> <span class="n">reflections</span> <span class="ow">in</span> <span class="mi">3</span> <span class="n">dimensions</span>
<span class="n">Performing</span> <span class="n">refinement</span> <span class="n">of</span> <span class="mi">58</span> <span class="n">Experiments</span><span class="o">...</span>

<span class="n">Refinement</span> <span class="n">steps</span><span class="p">:</span>
<span class="o">-----------------------------------------------</span>
<span class="o">|</span> <span class="n">Step</span> <span class="o">|</span> <span class="n">Nref</span>  <span class="o">|</span> <span class="n">RMSD_X</span>  <span class="o">|</span> <span class="n">RMSD_Y</span>  <span class="o">|</span> <span class="n">RMSD_Phi</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">|</span>       <span class="o">|</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>    <span class="o">|</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>    <span class="o">|</span> <span class="p">(</span><span class="n">deg</span><span class="p">)</span>    <span class="o">|</span>
<span class="o">-----------------------------------------------</span>
<span class="o">|</span> <span class="mi">0</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">1.6408</span>  <span class="o">|</span> <span class="mf">1.1569</span>  <span class="o">|</span> <span class="mf">0.79118</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">1.0856</span>  <span class="o">|</span> <span class="mf">0.83106</span> <span class="o">|</span> <span class="mf">0.52798</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.91236</span> <span class="o">|</span> <span class="mf">0.7085</span>  <span class="o">|</span> <span class="mf">0.50131</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.70048</span> <span class="o">|</span> <span class="mf">0.54736</span> <span class="o">|</span> <span class="mf">0.46902</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">4</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.46951</span> <span class="o">|</span> <span class="mf">0.36137</span> <span class="o">|</span> <span class="mf">0.40123</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">5</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.29632</span> <span class="o">|</span> <span class="mf">0.21747</span> <span class="o">|</span> <span class="mf">0.28785</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">6</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.20347</span> <span class="o">|</span> <span class="mf">0.15376</span> <span class="o">|</span> <span class="mf">0.17079</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">7</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16762</span> <span class="o">|</span> <span class="mf">0.13534</span> <span class="o">|</span> <span class="mf">0.11626</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">8</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16252</span> <span class="o">|</span> <span class="mf">0.13282</span> <span class="o">|</span> <span class="mf">0.10889</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">9</span>    <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16223</span> <span class="o">|</span> <span class="mf">0.13265</span> <span class="o">|</span> <span class="mf">0.1086</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">10</span>   <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16213</span> <span class="o">|</span> <span class="mf">0.13258</span> <span class="o">|</span> <span class="mf">0.1086</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">11</span>   <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16204</span> <span class="o">|</span> <span class="mf">0.13254</span> <span class="o">|</span> <span class="mf">0.10869</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">12</span>   <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.162</span>   <span class="o">|</span> <span class="mf">0.13252</span> <span class="o">|</span> <span class="mf">0.10877</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">13</span>   <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16199</span> <span class="o">|</span> <span class="mf">0.13252</span> <span class="o">|</span> <span class="mf">0.10879</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">14</span>   <span class="o">|</span> <span class="mi">87496</span> <span class="o">|</span> <span class="mf">0.16199</span> <span class="o">|</span> <span class="mf">0.13252</span> <span class="o">|</span> <span class="mf">0.10879</span>  <span class="o">|</span>
<span class="o">-----------------------------------------------</span>
<span class="n">RMSD</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">decreasing</span>

<span class="n">RMSDs</span> <span class="n">by</span> <span class="n">experiment</span><span class="p">:</span>
<span class="o">---------------------------------------------</span>
<span class="o">|</span> <span class="n">Exp</span> <span class="o">|</span> <span class="n">Nref</span> <span class="o">|</span> <span class="n">RMSD_X</span>  <span class="o">|</span> <span class="n">RMSD_Y</span>  <span class="o">|</span> <span class="n">RMSD_Z</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nb">id</span>  <span class="o">|</span>      <span class="o">|</span> <span class="p">(</span><span class="n">px</span><span class="p">)</span>    <span class="o">|</span> <span class="p">(</span><span class="n">px</span><span class="p">)</span>    <span class="o">|</span> <span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">|</span>
<span class="o">---------------------------------------------</span>
<span class="o">|</span> <span class="mi">0</span>   <span class="o">|</span> <span class="mi">1438</span> <span class="o">|</span> <span class="mf">0.55006</span> <span class="o">|</span> <span class="mf">0.36386</span> <span class="o">|</span> <span class="mf">0.39245</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span>   <span class="o">|</span> <span class="mi">1377</span> <span class="o">|</span> <span class="mf">0.60375</span> <span class="o">|</span> <span class="mf">0.35395</span> <span class="o">|</span> <span class="mf">0.37074</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>   <span class="o">|</span> <span class="mi">1046</span> <span class="o">|</span> <span class="mf">0.81377</span> <span class="o">|</span> <span class="mf">0.55378</span> <span class="o">|</span> <span class="mf">0.74578</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>   <span class="o">|</span> <span class="mi">1042</span> <span class="o">|</span> <span class="mf">0.71331</span> <span class="o">|</span> <span class="mf">0.50699</span> <span class="o">|</span> <span class="mf">0.29662</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">4</span>   <span class="o">|</span> <span class="mi">1430</span> <span class="o">|</span> <span class="mf">1.7057</span>  <span class="o">|</span> <span class="mf">2.0768</span>  <span class="o">|</span> <span class="mf">0.70272</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">5</span>   <span class="o">|</span> <span class="mi">562</span>  <span class="o">|</span> <span class="mf">0.76136</span> <span class="o">|</span> <span class="mf">0.54465</span> <span class="o">|</span> <span class="mf">0.444</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">6</span>   <span class="o">|</span> <span class="mi">1473</span> <span class="o">|</span> <span class="mf">0.91579</span> <span class="o">|</span> <span class="mf">1.2153</span>  <span class="o">|</span> <span class="mf">0.38596</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">7</span>   <span class="o">|</span> <span class="mi">1033</span> <span class="o">|</span> <span class="mf">0.50161</span> <span class="o">|</span> <span class="mf">0.37586</span> <span class="o">|</span> <span class="mf">0.24255</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">8</span>   <span class="o">|</span> <span class="mi">1097</span> <span class="o">|</span> <span class="mf">0.49387</span> <span class="o">|</span> <span class="mf">0.35304</span> <span class="o">|</span> <span class="mf">0.27443</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">9</span>   <span class="o">|</span> <span class="mi">871</span>  <span class="o">|</span> <span class="mf">0.8339</span>  <span class="o">|</span> <span class="mf">0.58238</span> <span class="o">|</span> <span class="mf">0.27862</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">10</span>  <span class="o">|</span> <span class="mi">1462</span> <span class="o">|</span> <span class="mf">0.51758</span> <span class="o">|</span> <span class="mf">0.29764</span> <span class="o">|</span> <span class="mf">0.26121</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">11</span>  <span class="o">|</span> <span class="mi">1297</span> <span class="o">|</span> <span class="mf">1.0496</span>  <span class="o">|</span> <span class="mf">1.0934</span>  <span class="o">|</span> <span class="mf">0.62916</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">12</span>  <span class="o">|</span> <span class="mi">1060</span> <span class="o">|</span> <span class="mf">0.56529</span> <span class="o">|</span> <span class="mf">0.41568</span> <span class="o">|</span> <span class="mf">0.35943</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">13</span>  <span class="o">|</span> <span class="mi">1508</span> <span class="o">|</span> <span class="mf">0.52573</span> <span class="o">|</span> <span class="mf">0.34911</span> <span class="o">|</span> <span class="mf">0.2364</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">14</span>  <span class="o">|</span> <span class="mi">1581</span> <span class="o">|</span> <span class="mf">0.64887</span> <span class="o">|</span> <span class="mf">0.3499</span>  <span class="o">|</span> <span class="mf">0.27855</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">15</span>  <span class="o">|</span> <span class="mi">1142</span> <span class="o">|</span> <span class="mf">1.3555</span>  <span class="o">|</span> <span class="mf">1.0016</span>  <span class="o">|</span> <span class="mf">0.81589</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">16</span>  <span class="o">|</span> <span class="mi">987</span>  <span class="o">|</span> <span class="mf">0.57376</span> <span class="o">|</span> <span class="mf">0.46291</span> <span class="o">|</span> <span class="mf">0.30225</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">17</span>  <span class="o">|</span> <span class="mi">1642</span> <span class="o">|</span> <span class="mf">0.68198</span> <span class="o">|</span> <span class="mf">0.55891</span> <span class="o">|</span> <span class="mf">0.48053</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">18</span>  <span class="o">|</span> <span class="mi">1334</span> <span class="o">|</span> <span class="mf">0.62128</span> <span class="o">|</span> <span class="mf">0.55331</span> <span class="o">|</span> <span class="mf">0.34444</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">19</span>  <span class="o">|</span> <span class="mi">1814</span> <span class="o">|</span> <span class="mf">0.97204</span> <span class="o">|</span> <span class="mf">0.80027</span> <span class="o">|</span> <span class="mf">0.48625</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">20</span>  <span class="o">|</span> <span class="mi">1172</span> <span class="o">|</span> <span class="mf">0.82146</span> <span class="o">|</span> <span class="mf">0.47213</span> <span class="o">|</span> <span class="mf">0.41469</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">21</span>  <span class="o">|</span> <span class="mi">1696</span> <span class="o">|</span> <span class="mf">0.65721</span> <span class="o">|</span> <span class="mf">0.34464</span> <span class="o">|</span> <span class="mf">0.28293</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">22</span>  <span class="o">|</span> <span class="mi">1700</span> <span class="o">|</span> <span class="mf">0.59074</span> <span class="o">|</span> <span class="mf">0.37139</span> <span class="o">|</span> <span class="mf">0.28981</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">23</span>  <span class="o">|</span> <span class="mi">1472</span> <span class="o">|</span> <span class="mf">0.72438</span> <span class="o">|</span> <span class="mf">0.69007</span> <span class="o">|</span> <span class="mf">0.39294</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">24</span>  <span class="o">|</span> <span class="mi">886</span>  <span class="o">|</span> <span class="mf">0.81814</span> <span class="o">|</span> <span class="mf">0.64633</span> <span class="o">|</span> <span class="mf">0.39922</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">25</span>  <span class="o">|</span> <span class="mi">1413</span> <span class="o">|</span> <span class="mf">1.5227</span>  <span class="o">|</span> <span class="mf">1.839</span>   <span class="o">|</span> <span class="mf">0.90807</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">26</span>  <span class="o">|</span> <span class="mi">2374</span> <span class="o">|</span> <span class="mf">0.52255</span> <span class="o">|</span> <span class="mf">0.2912</span>  <span class="o">|</span> <span class="mf">0.24541</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">27</span>  <span class="o">|</span> <span class="mi">1998</span> <span class="o">|</span> <span class="mf">0.494</span>   <span class="o">|</span> <span class="mf">0.29952</span> <span class="o">|</span> <span class="mf">0.23895</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">28</span>  <span class="o">|</span> <span class="mi">2620</span> <span class="o">|</span> <span class="mf">0.5181</span>  <span class="o">|</span> <span class="mf">0.30387</span> <span class="o">|</span> <span class="mf">0.25139</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">29</span>  <span class="o">|</span> <span class="mi">2928</span> <span class="o">|</span> <span class="mf">0.51628</span> <span class="o">|</span> <span class="mf">0.29307</span> <span class="o">|</span> <span class="mf">0.27191</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">30</span>  <span class="o">|</span> <span class="mi">2510</span> <span class="o">|</span> <span class="mf">0.51078</span> <span class="o">|</span> <span class="mf">0.3342</span>  <span class="o">|</span> <span class="mf">0.29667</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">31</span>  <span class="o">|</span> <span class="mi">1334</span> <span class="o">|</span> <span class="mf">0.68191</span> <span class="o">|</span> <span class="mf">0.38606</span> <span class="o">|</span> <span class="mf">0.2856</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">32</span>  <span class="o">|</span> <span class="mi">3240</span> <span class="o">|</span> <span class="mf">0.80437</span> <span class="o">|</span> <span class="mf">0.50846</span> <span class="o">|</span> <span class="mf">0.5801</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">33</span>  <span class="o">|</span> <span class="mi">2330</span> <span class="o">|</span> <span class="mf">1.5782</span>  <span class="o">|</span> <span class="mf">1.0468</span>  <span class="o">|</span> <span class="mf">0.59145</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">34</span>  <span class="o">|</span> <span class="mi">2409</span> <span class="o">|</span> <span class="mf">0.64632</span> <span class="o">|</span> <span class="mf">0.28538</span> <span class="o">|</span> <span class="mf">0.26755</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">35</span>  <span class="o">|</span> <span class="mi">2226</span> <span class="o">|</span> <span class="mf">1.944</span>   <span class="o">|</span> <span class="mf">1.6115</span>  <span class="o">|</span> <span class="mf">0.86348</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">36</span>  <span class="o">|</span> <span class="mi">1551</span> <span class="o">|</span> <span class="mf">0.91913</span> <span class="o">|</span> <span class="mf">0.90458</span> <span class="o">|</span> <span class="mf">0.64259</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">37</span>  <span class="o">|</span> <span class="mi">1047</span> <span class="o">|</span> <span class="mf">0.75458</span> <span class="o">|</span> <span class="mf">0.54531</span> <span class="o">|</span> <span class="mf">0.30649</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">38</span>  <span class="o">|</span> <span class="mi">742</span>  <span class="o">|</span> <span class="mf">1.6069</span>  <span class="o">|</span> <span class="mf">1.0673</span>  <span class="o">|</span> <span class="mf">1.3176</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">39</span>  <span class="o">|</span> <span class="mi">1205</span> <span class="o">|</span> <span class="mf">1.2038</span>  <span class="o">|</span> <span class="mf">0.94187</span> <span class="o">|</span> <span class="mf">1.0289</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">40</span>  <span class="o">|</span> <span class="mi">1200</span> <span class="o">|</span> <span class="mf">1.3346</span>  <span class="o">|</span> <span class="mf">0.98056</span> <span class="o">|</span> <span class="mf">0.46257</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">41</span>  <span class="o">|</span> <span class="mi">502</span>  <span class="o">|</span> <span class="mf">1.6651</span>  <span class="o">|</span> <span class="mf">1.159</span>   <span class="o">|</span> <span class="mf">1.7142</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">42</span>  <span class="o">|</span> <span class="mi">939</span>  <span class="o">|</span> <span class="mf">2.2596</span>  <span class="o">|</span> <span class="mf">1.5491</span>  <span class="o">|</span> <span class="mf">2.0847</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">43</span>  <span class="o">|</span> <span class="mi">1105</span> <span class="o">|</span> <span class="mf">1.1467</span>  <span class="o">|</span> <span class="mf">0.86945</span> <span class="o">|</span> <span class="mf">1.0626</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">44</span>  <span class="o">|</span> <span class="mi">1929</span> <span class="o">|</span> <span class="mf">0.55025</span> <span class="o">|</span> <span class="mf">0.2708</span>  <span class="o">|</span> <span class="mf">0.25013</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">45</span>  <span class="o">|</span> <span class="mi">1786</span> <span class="o">|</span> <span class="mf">0.60951</span> <span class="o">|</span> <span class="mf">0.27533</span> <span class="o">|</span> <span class="mf">0.27842</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">46</span>  <span class="o">|</span> <span class="mi">1738</span> <span class="o">|</span> <span class="mf">0.56749</span> <span class="o">|</span> <span class="mf">0.35204</span> <span class="o">|</span> <span class="mf">0.33809</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">47</span>  <span class="o">|</span> <span class="mi">1454</span> <span class="o">|</span> <span class="mf">0.53203</span> <span class="o">|</span> <span class="mf">0.31578</span> <span class="o">|</span> <span class="mf">0.27452</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">48</span>  <span class="o">|</span> <span class="mi">2016</span> <span class="o">|</span> <span class="mf">1.1326</span>  <span class="o">|</span> <span class="mf">1.2978</span>  <span class="o">|</span> <span class="mf">0.59713</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">49</span>  <span class="o">|</span> <span class="mi">1481</span> <span class="o">|</span> <span class="mf">0.97476</span> <span class="o">|</span> <span class="mf">1.0774</span>  <span class="o">|</span> <span class="mf">0.32288</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">50</span>  <span class="o">|</span> <span class="mi">2412</span> <span class="o">|</span> <span class="mf">0.54143</span> <span class="o">|</span> <span class="mf">0.47678</span> <span class="o">|</span> <span class="mf">0.25686</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">51</span>  <span class="o">|</span> <span class="mi">2005</span> <span class="o">|</span> <span class="mf">1.0293</span>  <span class="o">|</span> <span class="mf">0.77775</span> <span class="o">|</span> <span class="mf">0.46855</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">52</span>  <span class="o">|</span> <span class="mi">924</span>  <span class="o">|</span> <span class="mf">0.97306</span> <span class="o">|</span> <span class="mf">0.64495</span> <span class="o">|</span> <span class="mf">0.28243</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">53</span>  <span class="o">|</span> <span class="mi">1046</span> <span class="o">|</span> <span class="mf">0.63827</span> <span class="o">|</span> <span class="mf">0.42478</span> <span class="o">|</span> <span class="mf">0.58041</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">54</span>  <span class="o">|</span> <span class="mi">2180</span> <span class="o">|</span> <span class="mf">0.58521</span> <span class="o">|</span> <span class="mf">0.32623</span> <span class="o">|</span> <span class="mf">0.31898</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">55</span>  <span class="o">|</span> <span class="mi">1094</span> <span class="o">|</span> <span class="mf">0.63002</span> <span class="o">|</span> <span class="mf">0.40298</span> <span class="o">|</span> <span class="mf">0.26934</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">56</span>  <span class="o">|</span> <span class="mi">1070</span> <span class="o">|</span> <span class="mf">1.3311</span>  <span class="o">|</span> <span class="mf">1.0275</span>  <span class="o">|</span> <span class="mf">0.73719</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">57</span>  <span class="o">|</span> <span class="mi">566</span>  <span class="o">|</span> <span class="mf">2.3765</span>  <span class="o">|</span> <span class="mf">1.2727</span>  <span class="o">|</span> <span class="mf">0.78839</span>  <span class="o">|</span>
<span class="o">---------------------------------------------</span>
<span class="n">Updating</span> <span class="n">predictions</span> <span class="k">for</span> <span class="n">indexed</span> <span class="n">reflections</span>
<span class="n">Saving</span> <span class="n">refined</span> <span class="n">experiments</span> <span class="n">to</span> <span class="n">refined</span><span class="o">.</span><span class="n">expt</span>
<span class="n">Saving</span> <span class="n">reflections</span> <span class="k">with</span> <span class="n">updated</span> <span class="n">predictions</span> <span class="n">to</span> <span class="n">refined</span><span class="o">.</span><span class="n">refl</span>
</pre></div>
</div>
<p>The overall final RMSDs are 0.16 mm in X, 0.13 mm in Y and 0.11 degrees in
<span class="math notranslate nohighlight">\(\phi\)</span>. The RMSDs per experiment are also shown, which exhibit significant
variation between datasets.</p>
<p>We can compare the RMSDs from individually refined experiments to those from
the joint experiments. For example, look at the RSMDs for experiment 1, in the
logfile <code class="file docutils literal notranslate"><span class="pre">sequence_01/dials.refine.log</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RMSDs</span> <span class="n">by</span> <span class="n">experiment</span><span class="p">:</span>
<span class="o">---------------------------------------------</span>
<span class="o">|</span> <span class="n">Exp</span> <span class="o">|</span> <span class="n">Nref</span> <span class="o">|</span> <span class="n">RMSD_X</span>  <span class="o">|</span> <span class="n">RMSD_Y</span>  <span class="o">|</span> <span class="n">RMSD_Z</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nb">id</span>  <span class="o">|</span>      <span class="o">|</span> <span class="p">(</span><span class="n">px</span><span class="p">)</span>    <span class="o">|</span> <span class="p">(</span><span class="n">px</span><span class="p">)</span>    <span class="o">|</span> <span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">|</span>
<span class="o">---------------------------------------------</span>
<span class="o">|</span> <span class="mi">0</span>   <span class="o">|</span> <span class="mi">1422</span> <span class="o">|</span> <span class="mf">0.54278</span> <span class="o">|</span> <span class="mf">0.30358</span> <span class="o">|</span> <span class="mf">0.2555</span>   <span class="o">|</span>
<span class="o">---------------------------------------------</span>
</pre></div>
</div>
<p>Clearly allowing the detector and beam to refine only against this data lets
the model better fit the observations, but is it a more accurate description of
reality? Given that we <em>know</em> or can comfortably assume that the detector and
beam did not move between data collections, then the constraints applied by
joint refinement seem appropriate. The RMSDs for experiment 1 are not so much
worse than from the individual refinement job. We are happy with this result
and move on to re-integrating the data to create MTZs for BLEND.</p>
<p>It is worth noting that including/excluding outlier rejection can have a
significant effect on the stability of the refinement (although not in this
case). If issues are encountered processing your own data, try without
outlier rejection to see if the result is improved.</p>
</section>
<section id="analysis-of-jointly-refined-datasets">
<h2>Analysis of jointly refined datasets<a class="headerlink" href="#analysis-of-jointly-refined-datasets" title="Link to this heading">¶</a></h2>
<p>We can run <strong class="program">dials.integrate</strong> on the combined datafiles. We’ll do
a ‘quick and dirty’ integration like before, to enable a fair comparison
to be made for the BLEND results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">integrate</span> <span class="n">combined</span><span class="o">.</span><span class="n">refl</span> <span class="n">refined</span><span class="o">.</span><span class="n">expt</span> \
  <span class="n">prediction</span><span class="o">.</span><span class="n">d_min</span><span class="o">=</span><span class="mf">7.0</span> <span class="n">prediction</span><span class="o">.</span><span class="n">d_max</span><span class="o">=</span><span class="mf">8.1</span> \
  <span class="n">profile</span><span class="o">.</span><span class="n">fitting</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
<p>This will integrate each dataset without profile fitting, using multiple
processors, but only between 7.0 and 8.1 Angstrom to produce a quick result
for the purpose of creating the MTZ files for BLEND. Next, we want to
generate mtz files, however <strong class="program">dials.export</strong> can
only export one dataset at a time, so we will first need to separate the
dataset into individual files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">split_experiments</span> <span class="n">integrated</span><span class="o">.</span><span class="n">refl</span> <span class="n">integrated</span><span class="o">.</span><span class="n">expt</span>
</pre></div>
</div>
<p>This will create a series of datafiles from
<code class="file docutils literal notranslate"><span class="pre">split_00.refl</span></code>, <code class="file docutils literal notranslate"><span class="pre">split_00.expt</span></code> up to
<code class="file docutils literal notranslate"><span class="pre">split_57.refl</span></code>, <code class="file docutils literal notranslate"><span class="pre">split_57.expt</span></code>.</p>
<p>To export the 58 datasets, we should write a script to avoid having to work
manually. Currently, many DIALS programs such as <strong class="program">dials.export</strong>
can be imported into python scripts as functions to be called directly.
Therefore the script we need is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/env dials.python</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dxtbx.serialize</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.array_family</span><span class="w"> </span><span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.command_line.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">phil_scope</span><span class="p">,</span> <span class="n">export_mtz</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;dials.command_line.export&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

  <span class="n">log</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">logfile</span><span class="o">=</span><span class="s2">&quot;export_all.log&quot;</span><span class="p">)</span>

  <span class="n">params</span> <span class="o">=</span> <span class="n">phil_scope</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
  <span class="n">params</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">58</span><span class="p">):</span>
      <span class="n">params</span><span class="o">.</span><span class="n">mtz</span><span class="o">.</span><span class="n">hklout</span> <span class="o">=</span> <span class="s2">&quot;integrated_</span><span class="si">%02d</span><span class="s2">.mtz&quot;</span> <span class="o">%</span> <span class="n">i</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to export to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">mtz</span><span class="o">.</span><span class="n">hklout</span><span class="p">)</span>
      <span class="n">refl</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">reflection_table</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">&quot;split_</span><span class="si">%02d</span><span class="s2">.refl&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
      <span class="n">expts</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">experiment_list</span><span class="p">(</span><span class="s2">&quot;split_</span><span class="si">%02d</span><span class="s2">.expt&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">check_format</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="n">export_mtz</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">expts</span><span class="p">,</span> <span class="p">[</span><span class="n">refl</span><span class="p">])</span>
</pre></div>
</div>
<p>This, if saved as <code class="file docutils literal notranslate"><span class="pre">joint_export.py</span></code>, can be run as simply:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dials</span><span class="o">.</span><span class="n">python</span> <span class="n">joint_export</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This simple script has several key components. The ‘phil_scope’ contains the
command-line program parameters, which we extract to a ‘params’ object for the
export_mtz function call. We can override parameters in the params object, in
this example we set the intensity type to export and set a new mtz filename for
each iteration in the loop.
We also need to provide a reflection table and experiment list for each dataset,
which are loaded within the loop and passed to export_mtz. We also create a logger
to capture any output from the export_mtz function, which we have to configure
in the program. For this simple task, where we don’t need to take advantage of
parallel processing, this script is sufficient.</p>
<p>As expected this creates all 58 MTZs for the jointly refined sequences without any
problem. We can copy the paths to these into a new file, say
<code class="file docutils literal notranslate"><span class="pre">joint_mtzs.dat</span></code>, and run blend:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;END&quot;</span> <span class="o">|</span> <span class="n">blend</span> <span class="o">-</span><span class="n">a</span> <span class="n">joint_mtzs</span><span class="o">.</span><span class="n">dat</span>
</pre></div>
</div>
<p>The <code class="file docutils literal notranslate"><span class="pre">tree.png</span></code> resulting from this is very interesting.</p>
<blockquote>
<div><img alt="https://dials.github.io/images/multi_crystal_analysis/tree_joint.png" src="https://dials.github.io/images/multi_crystal_analysis/tree_joint.png" />
</div></blockquote>
<p>The LCV is now as low as 0.35% (aLCV 0.58 Angstroms). This indicates an even
higher degree of isomorphism than detected during after individual processing.
So although joint refinement leads to slightly higher RMSDs for each experiment
(as we expected) the resulting unit cells are more similar. It is worth
remembering that no restraints were applied between unit cells in refinement.
Given that we know that the detector and beam did not move between the data
collections we might like to think that the joint refinement analysis is a more
accurate depiction of reality, and thus the unit cells are closer to the truth.</p>
</section>
<section id="what-to-do-next">
<h2>What to do next?<a class="headerlink" href="#what-to-do-next" title="Link to this heading">¶</a></h2>
<p>This has given us a good starting point for analysis with BLEND. However, because
of the shortcuts we took with integration we are not yet ready to continue with
BLEND’s synthesis mode. At this point we might assess where we are and try a few
things:</p>
<ul class="simple">
<li><p>Go back and fix datasets that didn’t index properly. We could edit our processing
script to attempt <code class="samp docutils literal notranslate"><span class="pre">method=fft1d</span></code> for example if the 3D FFT indexing was
unsuccessful.</p></li>
<li><p>Integrate data properly for BLEND’s synthesis mode. We should remove the resolution
limits and allow <strong class="program">dials.integrate</strong> to do profile fitting as well as
summation integration.</p></li>
</ul>
</section>
<section id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Link to this heading">¶</a></h2>
<p>The TehA project and original BLEND analysis was performed by scientists at Diamond
Light Source and the Membrane Protein Laboratory. We thank the following for
access to the data: Danny Axford, Nien-Jen Hu, James Foadi, Hassanul Ghani Choudhury, So Iwata,
Konstantinos Beis, Pierre Aller, Gwyndaf Evans &amp; Yilmaz Alguel</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../national_resource.html">US National Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &#169;2025, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>