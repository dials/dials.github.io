

<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Extending DIALS &#8212; DIALS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" href="../../_static/dials-styles.css" type="text/css" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Reading experiment and data" href="read_experiment_and_data.html" />
    <link rel="prev" title="Developer Examples" href="index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="logoheader container">
  <a href="../../index.html">
  <img class="logoheader" alt="DIALS" src="../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="extending-dials">
<h1><a class="toc-backref" href="#id2" role="doc-backlink">Extending DIALS</a><a class="headerlink" href="#extending-dials" title="Link to this heading">¶</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#extending-dials" id="id2">Extending DIALS</a></p>
<ul>
<li><p><a class="reference internal" href="#entry-points" id="id3">Entry points</a></p></li>
<li><p><a class="reference internal" href="#adding-new-format-classes" id="id4">Adding new format classes</a></p></li>
<li><p><a class="reference internal" href="#extending-dials-index" id="id5">Extending dials.index</a></p></li>
<li><p><a class="reference internal" href="#extending-profile-models" id="id6">Extending profile models</a></p></li>
<li><p><a class="reference internal" href="#extending-dials-scale" id="id7">Extending dials.scale</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="entry-points">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Entry points</a><a class="headerlink" href="#entry-points" title="Link to this heading">¶</a></h2>
<p>DIALS uses <a class="reference external" href="https://packaging.python.org/specifications/entry-points/">entry points</a>
to define points in the code that can be extended by external developers. These entry
points are defined in the <code class="docutils literal notranslate"><span class="pre">dials</span></code> and <code class="docutils literal notranslate"><span class="pre">dxtbx</span></code> <code class="docutils literal notranslate"><span class="pre">libtbx_refresh.py</span></code> files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">libtbx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">libtbx.pkg_utils</span>

<span class="c1"># So that we can import DIALS within this script, work out where the</span>
<span class="c1"># sources are and make them importable</span>
<span class="n">_src_path_root</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">libtbx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">dist_path</span><span class="p">(</span><span class="s2">&quot;dials&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">_src_path_root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_src_path_root</span><span class="p">)</span>

<span class="c1"># Other packages, configured first, might have attempted to import dials, which</span>
<span class="c1"># would only get a namespace package, if the modules/ folder is configured as a</span>
<span class="c1"># repository. This means just setting the path wouldn&#39;t work. So, check to see</span>
<span class="c1"># if we have a namespace package imported, remove it (and any sub-packages),</span>
<span class="c1"># set the __path__, then import the real copy of DIALS.</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>Developers implementing their own extensions can register their extensions either in
their package <code class="docutils literal notranslate"><span class="pre">libtbx.refresh.py</span></code> if writing a cctbx-style package, or in their
package <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> if using the
<a class="reference external" href="https://setuptools.readthedocs.io/en/latest/">setuptools</a> framework.</p>
<p>The list of installed plugins can be obtained by running the <code class="docutils literal notranslate"><span class="pre">dials.plugins</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dials.plugins
dials.index.basis_vector_search_strategy  Basis vector search strategies
 fft1d (dials.algorithms.indexing.basis_vector_search.strategies via libtbx.dials 0.0.0)
 fft3d (dials.algorithms.indexing.basis_vector_search.strategies via libtbx.dials 0.0.0)
 real_space_grid_search (dials.algorithms.indexing.basis_vector_search.strategies via libtbx.dials 0.0.0)

dxtbx.scaling_model_ext  scaling models
 KB (dials.algorithms.scaling.model.scaling_model_ext via libtbx.dials 0.0.0)
 array (dials.algorithms.scaling.model.scaling_model_ext via libtbx.dials 0.0.0)
 physical (dials.algorithms.scaling.model.scaling_model_ext via libtbx.dials 0.0.0)

dxtbx.profile_model  profile models
 gaussian_rs (dials.extensions.gaussian_rs_profile_model_ext via libtbx.dials 0.0.0)

dials.index.lattice_search_strategy  Lattice search strategies
 low_res_spot_match (dials.algorithms.indexing.lattice_search_strategies via libtbx.dials 0.0.0)
</pre></div>
</div>
</section>
<section id="adding-new-format-classes">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Adding new format classes</a><a class="headerlink" href="#adding-new-format-classes" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">dxtbx</span></code> now discovers format classes during configuration time instead of
at runtime. New format classes can either be added into the dxtbx/format
directory, registered by other python packages using the
‘dxtbx.format’ entry point, or installed by the user via the
‘dxtbx.install_format’ command.</p>
<p>To add a new format class to be distributed with <code class="docutils literal notranslate"><span class="pre">dials</span></code>, please submit a pull request
to the <a class="reference external" href="https://github.com/cctbx/dxtbx">dxtbx repository</a>.</p>
<p>To register format classes stored in ~/.dxtbx you need to run
‘dxtbx.install_format -u’ whenever you add or remove format classes.</p>
<section id="writing-a-new-format-class">
<h3>Writing a new format class<a class="headerlink" href="#writing-a-new-format-class" title="Link to this heading">¶</a></h3>
<p>The <cite>dxtbx</cite> format class framework enables beamline staff and users to easily add
support for new detector types and beamlines. In essence all that is needed is to
implement a Python class which extends the Format class to add some specific details
about this detector and the associated beamline/experimental environment.</p>
<p>In particular there are two groups of things which need to be
implemented - a static method named <cite>understand</cite> which will take a
look at the image and return True if it understands it, and a number of
class methods which need to override the construction of the <cite>dxtbx</cite> models.</p>
</section>
<section id="understand-static-method">
<h3><cite>understand</cite> Static Method<a class="headerlink" href="#understand-static-method" title="Link to this heading">¶</a></h3>
<p>This method is the key to how the whole framework operates - you write code
which looks at the image to decide whether it is right for this class. If it is
not you must return False - i.e. if you are making a custom class for a given
detector serial number and it is given an image from a different detector.</p>
<p>Ideally your implementation will inherit from a similar Format class
and just apply further customizations.  Your implementation will be
chosen to read the image if it is the most customized, i.e. it derives
from the longest chain of ancestors, all of which claim to understand
the image.</p>
</section>
<section id="class-methods">
<h3>Class Methods<a class="headerlink" href="#class-methods" title="Link to this heading">¶</a></h3>
<p>The class methods need to use the built in factories to construct descriptions
of the experimental apparatus from the image, namely the goniometer, detector,
beam and scan. In many cases the “simple” model will be the best which is
often trivial. In other cases it may be more complex but will hopefully
correspond to an already existing factory method.</p>
<p>As an example, let’s pretend your beamline has a “reversed” rotation axis. We can create
a new format class that correctly understands images from your beamline and instantiates
a goniometer model with a reversed direction goniometer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dxtbx.format.FormatCBFMiniPilatus</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormatCBFMiniPilatus</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FormatCBFMiniPilatusMyBeamline</span><span class="p">(</span><span class="n">FormatCBFMiniPilatus</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for reading mini CBF format Pilatus images for MyBeamline.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">understand</span><span class="p">(</span><span class="n">image_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the detector serial number to check it is from MyBeamline.&quot;&quot;&quot;</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">FormatCBFMiniPilatus</span><span class="o">.</span><span class="n">get_cbf_header</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;# Detector&quot;</span> <span class="ow">in</span> <span class="n">record</span>
                <span class="ow">and</span> <span class="s2">&quot;PILATUS&quot;</span> <span class="ow">in</span> <span class="n">record</span>
                <span class="ow">and</span> <span class="s2">&quot;S/N 42-4242&quot;</span> <span class="ow">in</span> <span class="n">header</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_goniometer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a model for a simple single-axis reversed direction goniometer.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goniometer_factory</span><span class="o">.</span><span class="n">single_axis_reverse</span><span class="p">()</span>
</pre></div>
</div>
<p>We can then register this format class in the <code class="docutils literal notranslate"><span class="pre">libtbx_refresh.py</span></code> file of our local
<code class="docutils literal notranslate"><span class="pre">myproject</span></code> <code class="docutils literal notranslate"><span class="pre">cctbx</span></code> package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">libtbx.pkg_utils</span>
<span class="n">libtbx</span><span class="o">.</span><span class="n">pkg_utils</span><span class="o">.</span><span class="n">define_entry_points</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;dxtbx.format&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;FormatCBFMiniPilatusMyBeamline:FormatCBFMiniPilatus = myproject.my_format_module:FormatCBFMiniPilatusMyBeamline&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>More generally, the format of an entry point for dxtbx.format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;FormatMyClass:FormatBaseClass1,FormatBaseClass2 = myproject.myformat:FormatMyClass&quot;</span>
</pre></div>
</div>
<p>Format classes must be named ‘Format*’, and must inherit either from
other format classes or from the top-level format class, ‘Format’.
Base classes must be given as their original name and must therefore not
contain ‘.’s.</p>
<p>To view the full hierarchy of registered format classes, run the command
<code class="docutils literal notranslate"><span class="pre">dxtbx.show_registry</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dxtbx.show_registry
Showing hierarchy of classes in the dxtbx registry. The root classes are shown with depth of 1, and subclasses are shown indented and with a higher depth number.

Depth  Class name
    0  Format
    1    FormatBruker
    2      FormatBrukerFixedChi
    2      FormatBrukerPhotonII
    ...
</pre></div>
</div>
</section>
</section>
<section id="extending-dials-index">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Extending dials.index</a><a class="headerlink" href="#extending-dials-index" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">dials.index</span></code> defines two possible entry points,
<code class="docutils literal notranslate"><span class="pre">dials.index.basis_vector_search_strategy</span></code> and
<code class="docutils literal notranslate"><span class="pre">dials.index.lattice_search_strategy</span></code>.</p>
<section id="basis-vector-search-strategies">
<h3>Basis vector search strategies<a class="headerlink" href="#basis-vector-search-strategies" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">dials.index.basis_vector_search_strategy</span></code> entry point can be used to extend the
list of possible basis vector search strategies available in DIALS, by delegating the
search for a list of possible real space basis vectors to a strategy. DIALS currently
includes the <cite>fft1d</cite>, <cite>fft3d</cite> and <cite>real_space_grid_search</cite> strategies. A basis vector
search strategy should inherit from the class
<code class="xref py py-class docutils literal notranslate"><span class="pre">dials.algorithms.indexing.basis_vector_search.strategies.Strategy</span></code> and provide
an implementation of the <code class="docutils literal notranslate"><span class="pre">find_basis_vectors</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libtbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">phil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.basis_vector_search.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">Strategy</span>

<span class="n">mystrategy_phil_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">magic_parameter = 42</span>
<span class="s2">    .help = &quot;This is a magic parameter.&quot;</span>
<span class="s2">    .type = float</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">mystrategy_phil_str</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basis vector search using my magic algorithm.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_basis_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reciprocal_lattice_vectors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a list of likely basis vectors.</span>

<span class="sd">        Args:</span>
<span class="sd">            reciprocal_lattice_vectors (scitbx.array_family.flex.vec3_double):</span>
<span class="sd">                The list of reciprocal lattice vectors to search for periodicity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the list of basis vectors and a flex.bool array</span>
<span class="sd">            identifying which reflections were used in indexing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">used_in_indexing</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">reciprocal_lattice_vectors</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># determine the list of candidate_basis_vectors</span>
        <span class="o">...</span>
    <span class="k">return</span> <span class="n">candidate_basis_vectors</span><span class="p">,</span> <span class="n">used_in_indexing</span>
</pre></div>
</div>
<p>We can now register this new basis vector search strategy in the <code class="docutils literal notranslate"><span class="pre">libtbx_refresh.py</span></code>
file of our local <code class="docutils literal notranslate"><span class="pre">myproject</span></code> package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">libtbx.pkg_utils</span>
<span class="n">libtbx</span><span class="o">.</span><span class="n">pkg_utils</span><span class="o">.</span><span class="n">define_entry_points</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;dials.index.basis_vector_search_strategy&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;mystrategy = myproject.mystrategy:MyStrategy&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="lattice-search-strategies">
<h3>Lattice search strategies<a class="headerlink" href="#lattice-search-strategies" title="Link to this heading">¶</a></h3>
<p>An alternative entry point into dials.index is
<code class="docutils literal notranslate"><span class="pre">dials.index.lattice_search_strategy</span></code>, where the entire crystal model search is
delegated to the strategy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libtbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">phil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.lattice_search_strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">Strategy</span>

<span class="n">mystrategy_phil_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">magic_parameter = 42</span>
<span class="s2">    .help = &quot;This is a magic parameter.&quot;</span>
<span class="s2">    .type = float</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyLatticeSearch</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;My magic lattice search strategy.&quot;&quot;&quot;</span>

    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">mystrategy_phil_str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_crystal_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a list of candidate crystal models.</span>

<span class="sd">        Args:</span>
<span class="sd">            reflections (dials.array_family.flex.reflection_table):</span>
<span class="sd">                The found spots centroids and associated data</span>

<span class="sd">            experiments (dxtbx.model.experiment_list.ExperimentList):</span>
<span class="sd">                The experimental geometry models</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of candidate crystal models.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine the list of candidate_crystal_models</span>
        <span class="k">return</span> <span class="n">candidate_crystal_models</span>
</pre></div>
</div>
<p>As above, register this new lattice search strategy in the <code class="docutils literal notranslate"><span class="pre">libtbx_refresh.py</span></code>
file of our local <code class="docutils literal notranslate"><span class="pre">myproject</span></code> package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">libtbx.pkg_utils</span>
<span class="n">libtbx</span><span class="o">.</span><span class="n">pkg_utils</span><span class="o">.</span><span class="n">define_entry_points</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;dials.index.lattice_search_strategy&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;mylatticesearch = myproject.mylatticesearch:MyLatticeSearch&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="extending-profile-models">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Extending profile models</a><a class="headerlink" href="#extending-profile-models" title="Link to this heading">¶</a></h2>
</section>
<section id="extending-dials-scale">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Extending dials.scale</a><a class="headerlink" href="#extending-dials-scale" title="Link to this heading">¶</a></h2>
<p><cite>dials.scale</cite> can be extended by defining new scaling models using the
entry point <code class="docutils literal notranslate"><span class="pre">dxtbx.scaling_model_ext</span></code>.</p>
<section id="defining-a-scaling-model">
<h3>Defining a scaling model<a class="headerlink" href="#defining-a-scaling-model" title="Link to this heading">¶</a></h3>
<p>A new scaling model can be defined, which should inherit from the class
<a class="reference internal" href="../library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase" title="dials.algorithms.scaling.model.model.ScalingModelBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">dials.algorithms.scaling.model.model.ScalingModelBase</span></code></a>. A new
scaling model must define the <cite>from_dict</cite>, <cite>from_data</cite> and
<cite>configure_components</cite> methods, and should also define an <cite>__init__</cite> method. The model
must also define <cite>consecutive_refinement_order</cite> to indicate which order the components
should be refined for the consecutive scaling mode.
The scaling model must be composed of multiplicative components, which must
inherit from
<code class="xref py py-class docutils literal notranslate"><span class="pre">dials.algorithms.scaling.model.components.scale_components.ScaleComponentBase</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">libtbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">phil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scitbx.array_family</span><span class="w"> </span><span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.model.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalingModelBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mypath.components</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpecialComponent</span>

<span class="n">mymodel_phil_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">special_correction = True</span>
<span class="s2">    .help = &quot;Option to toggle the special correction.&quot;</span>
<span class="s2">    .type = bool</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyScalingModel</span><span class="p">(</span><span class="n">ScalingModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;My scaling model.&quot;&quot;&quot;</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="s2">&quot;modelname&quot;</span>

    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">mymodel_phil_str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyScalingModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;special&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpecialComponent</span><span class="p">(</span>
                <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
                <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">][</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a MyScalingModel from a dictionary.&quot;&quot;&quot;</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;configuration_parameters&quot;</span><span class="p">]</span>
        <span class="n">is_scaled</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;is_scaled&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;special&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">]:</span>
                <span class="n">parameter_esds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;special : {&quot;</span><span class="n">parameters</span><span class="s2">&quot; : parameters, &quot;</span><span class="n">parameter_esds</span><span class="s2">&quot; : parameter_esds}}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the MycalingModel from data.&quot;&quot;&quot;</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">modelname</span><span class="o">.</span><span class="n">special_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;special&quot;</span><span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;important_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflection_table</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the required reflection table data to the model components.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;special&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">consecutive_refinement_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;A nested list of the refinement order&quot;</span><span class="o">.</span>
        <span class="k">return</span> <span class="p">[[</span><span class="s2">&quot;special&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../national_resource.html">US National Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &#169;2025, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>