

<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dials.algorithms.refinement.engine &#8212; DIALS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" href="../../../../_static/dials-styles.css" type="text/css" />
    <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="logoheader container">
  <a href="../../../../index.html">
  <img class="logoheader" alt="DIALS" src="../../../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dials.algorithms.refinement.engine</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Contains classes for refinement engines. Refinery is the shared interface,</span>
<span class="sd">LevenbergMarquardtIterations, GaussNewtonIterations, SimpleLBFGS and LBFGScurvs</span>
<span class="sd">are the current concrete implementations&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">libtbx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libtbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">easy_mp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libtbx.phil</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scitbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">lbfgs</span><span class="p">,</span> <span class="n">sparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scitbx.array_family</span><span class="w"> </span><span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scitbx.lstbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">normal_eqns</span><span class="p">,</span> <span class="n">normal_eqns_solving</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.refinement</span><span class="w"> </span><span class="kn">import</span> <span class="n">DialsRefineRuntimeError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.target</span><span class="w"> </span><span class="kn">import</span> <span class="n">Target</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># termination reason strings</span>
<span class="n">TARGET_ACHIEVED</span> <span class="o">=</span> <span class="s2">&quot;RMSD target achieved&quot;</span>
<span class="n">RMSD_CONVERGED</span> <span class="o">=</span> <span class="s2">&quot;RMSD no longer decreasing&quot;</span>
<span class="n">STEP_TOO_SMALL</span> <span class="o">=</span> <span class="s2">&quot;Step too small&quot;</span>
<span class="n">OBJECTIVE_INCREASE</span> <span class="o">=</span> <span class="s2">&quot;Refinement failure: objective increased&quot;</span>
<span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="s2">&quot;Reached maximum number of iterations&quot;</span>
<span class="n">MAX_TRIAL_ITERATIONS</span> <span class="o">=</span> <span class="s2">&quot;Reached maximum number of consecutive unsuccessful trial steps&quot;</span>
<span class="n">DOF_TOO_LOW</span> <span class="o">=</span> <span class="s2">&quot;Not enough degrees of freedom to refine&quot;</span>
<span class="n">OBJECTIVE_FLAT</span> <span class="o">=</span> <span class="s2">&quot;Refinement failure: zero expected decrease of the objective&quot;</span>


<span class="n">refinery_phil_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">refinery</span>
<span class="s2">  .help = &quot;Parameters to configure the refinery&quot;</span>
<span class="s2">  .expert_level = 1</span>
<span class="s2">{</span>
<span class="s2">  engine = SimpleLBFGS LBFGScurvs GaussNewton *LevMar SparseLevMar</span>
<span class="s2">    .help = &quot;The minimisation engine to use&quot;</span>
<span class="s2">    .type = choice</span>

<span class="s2">  max_iterations = None</span>
<span class="s2">    .help = &quot;Maximum number of iterations in refinement before termination.&quot;</span>
<span class="s2">            &quot;None implies the engine supplies its own default.&quot;</span>
<span class="s2">    .type = int(value_min=1)</span>

<span class="s2">  log = None</span>
<span class="s2">    .help = &quot;Filename for an optional log that a minimisation engine may use&quot;</span>
<span class="s2">            &quot;to write additional information&quot;</span>
<span class="s2">    .type = path</span>

<span class="s2">  journal</span>
<span class="s2">    .help = &quot;Extra items to track in the refinement history&quot;</span>
<span class="s2">  {</span>
<span class="s2">    track_step = False</span>
<span class="s2">      .help = &quot;Record parameter shifts history in the refinement journal, if&quot;</span>
<span class="s2">              &quot;the engine supports it.&quot;</span>
<span class="s2">      .type = bool</span>

<span class="s2">    track_gradient = False</span>
<span class="s2">      .help = &quot;Record parameter gradients history in the refinement journal, if&quot;</span>
<span class="s2">              &quot;the engine supports it.&quot;</span>
<span class="s2">      .type = bool</span>

<span class="s2">    track_parameter_correlation = False</span>
<span class="s2">      .help = &quot;Record correlation matrix between columns of the Jacobian for&quot;</span>
<span class="s2">              &quot;each step of refinement.&quot;</span>
<span class="s2">      .type = bool</span>

<span class="s2">    track_jacobian_structure = False</span>
<span class="s2">      .help = &quot;Record numbers of explicit and structural zeroes in each column&quot;</span>
<span class="s2">              &quot;of the Jacobian at each step of refinement.&quot;</span>
<span class="s2">      .type = bool</span>

<span class="s2">    track_condition_number = False</span>
<span class="s2">      .help = &quot;Record condition number of the Jacobian for each step of &quot;</span>
<span class="s2">              &quot;refinement.&quot;</span>
<span class="s2">      .type = bool</span>

<span class="s2">    track_normal_matrix = False</span>
<span class="s2">      .help = &quot;Record the full normal matrix at each step of refinement&quot;</span>
<span class="s2">      .type = bool</span>

<span class="s2">    track_out_of_sample_rmsd = False</span>
<span class="s2">      .type = bool</span>
<span class="s2">      .help = &quot;Record RMSDs calculated using the refined experiments with&quot;</span>
<span class="s2">              &quot;reflections not used in refinement at each step. Only valid if a&quot;</span>
<span class="s2">              &quot;subset of input reflections was taken for refinement&quot;</span>
<span class="s2">  }</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">refinery_phil_scope</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">refinery_phil_str</span><span class="p">)</span>


<div class="viewcode-block" id="Journal">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Journal</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container in which to store information about refinement history.</span>

<span class="sd">    This is simply a dict but provides some extra methods for access that</span>
<span class="sd">    maintain values as columns in a table. Refinery classes will use these methods</span>
<span class="sd">    while entering data to ensure the table remains consistent. Methods inherited</span>
<span class="sd">    from dict are not hidden for ease of use of this object when returned to the</span>
<span class="sd">    user.&quot;&quot;&quot;</span>

    <span class="n">reason_for_termination</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_nrows</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Journal.get_nrows">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.get_nrows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_nrows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span></div>


<div class="viewcode-block" id="Journal.add_column">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.add_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new column named by key&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span></div>


<div class="viewcode-block" id="Journal.add_row">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.add_row">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an element to the end of each of the columns. Fail if any columns</span>
<span class="sd">        are the wrong length&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Journal.del_last_row">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.del_last_row">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">del_last_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the last element from the each of the columns. Fail if any columns</span>
<span class="sd">        are the wrong length&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span> <span class="o">-=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Journal.set_last_cell">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.set_last_cell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_last_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set last cell in column given by key to value. Fail if the column is the</span>
<span class="sd">        wrong length&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrows</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Journal.to_json_file">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.to_json_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;attributes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Journal.from_json_file">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Journal.from_json_file">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">j</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">j</span></div>
</div>



<div class="viewcode-block" id="Refinery">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Refinery</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for Refinery objects. This should be subclassed and the run</span>
<span class="sd">    method implemented.&quot;&quot;&quot;</span>

    <span class="c1"># NOTES. A Refinery is initialised with a Target function. The target</span>
    <span class="c1"># function already contains a ReflectionManager (which holds the data) so</span>
    <span class="c1"># there&#39;s no need to pass the data in here. In fact the Target</span>
    <span class="c1"># class does the bulk of the work, as it also does the reflection prediction</span>
    <span class="c1"># to get the updated predictions on each cycle. This should make some sense</span>
    <span class="c1"># as the target function is inextricably linked to the space in which</span>
    <span class="c1"># predictions are made (e.g. detector space, phi), so it is not general</span>
    <span class="c1"># enough to sit abstractly above the prediction.</span>

    <span class="c1"># This keeps the Refinery simple and able to be focused only on generic</span>
    <span class="c1"># features of managing a refinement run, like reporting results and checking</span>
    <span class="c1"># termination criteria.</span>

    <span class="c1"># The prediction values come from a PredictionParameterisation object.</span>
    <span class="c1"># This is also referred to by the Target function, but it makes sense for</span>
    <span class="c1"># Refinery to be able to refer to it directly. So refinery should keep a</span>
    <span class="c1"># separate link to its PredictionParameterisation.</span>

<div class="viewcode-block" id="Refinery.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Target</span><span class="p">,</span>
        <span class="n">prediction_parameterisation</span><span class="p">,</span>
        <span class="n">constraints_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tracking</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># reference to PredictionParameterisation, Target and ConstraintsManager</span>
        <span class="c1"># objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">prediction_parameterisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="o">=</span> <span class="n">constraints_manager</span>

        <span class="c1"># initial parameter values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">get_param_vals</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">constrain_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_x</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># undefined initial functional and gradients values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span> <span class="o">|</span> <span class="n">sparse</span><span class="o">.</span><span class="n">matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># filename for an optional log file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_target_achieved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span>

        <span class="c1"># attributes for journalling functionality, based on lstbx&#39;s</span>
        <span class="c1"># journaled_non_linear_ls class</span>
        <span class="k">if</span> <span class="n">tracking</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># set default tracking</span>
            <span class="n">tracking</span> <span class="o">=</span> <span class="n">refinery_phil_scope</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span><span class="o">.</span><span class="n">refinery</span><span class="o">.</span><span class="n">journal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">Journal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;num_reflections&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;objective&quot;</span><span class="p">)</span>  <span class="c1"># flex.double()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;gradient_norm&quot;</span><span class="p">)</span>  <span class="c1"># flex.double()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;solution_norm&quot;</span><span class="p">)</span>  <span class="c1"># flex.double()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;parameter_vector&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;parameter_vector_norm&quot;</span><span class="p">)</span>  <span class="c1"># flex.double()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;rmsd&quot;</span><span class="p">)</span>

        <span class="c1"># Optional tracking</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_step</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;solution&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_gradient</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_parameter_correlation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;parameter_correlation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_condition_number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;condition_number&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_jacobian_structure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;jacobian_structure&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_normal_matrix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;normal_matrix&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracking</span><span class="o">.</span><span class="n">track_out_of_sample_rmsd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;out_of_sample_rmsd&quot;</span><span class="p">)</span>

        <span class="c1"># number of processes to use, for engines that support multiprocessing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_step</span><span class="p">()</span></div>


<div class="viewcode-block" id="Refinery.get_num_steps">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.get_num_steps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_num_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_nrows</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Refinery.prepare_for_step">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.prepare_for_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_for_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the parameterisation and prepare the target function&quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">expand_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># set current parameter values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">set_param_vals</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># do reflection prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span></div>


<div class="viewcode-block" id="Refinery.update_journal">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.update_journal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_journal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append latest step information to the journal attributes&quot;&quot;&quot;</span>

        <span class="c1"># add step quantities to journal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;num_reflections&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">get_num_matches</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;rmsd&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">rmsds</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span>
            <span class="s2">&quot;parameter_vector&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">get_param_vals</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;gradient&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;parameter_correlation&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resid_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;RMSD_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">rmsd_names</span><span class="p">]</span>
            <span class="c1"># split Jacobian into dense matrix blocks corresponding to each residual</span>
            <span class="n">jblocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_jacobian_into_blocks</span><span class="p">()</span>
            <span class="n">corrmats</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">resid_names</span><span class="p">,</span> <span class="n">jblocks</span><span class="p">):</span>
                <span class="n">corrmats</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_packed_corr_mat</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;parameter_correlation&quot;</span><span class="p">,</span> <span class="n">corrmats</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;jacobian_structure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;jacobian_structure&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian_structure</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;condition_number&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span>
                <span class="s2">&quot;condition_number&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian_condition_number</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;out_of_sample_rmsd&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">predict_for_free_reflections</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span>
                <span class="s2">&quot;out_of_sample_rmsd&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">rmsds_for_reflection_table</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Refinery.split_jacobian_into_blocks">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.split_jacobian_into_blocks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_jacobian_into_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the Jacobian into blocks each corresponding to a separate</span>
<span class="sd">        residual, converting sparse to flex.double if appropriate&quot;&quot;&quot;</span>

        <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">rmsd_names</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The Jacobian might be a sparse matrix</span>
            <span class="n">j</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span><span class="o">.</span><span class="n">as_dense_matrix</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span>

        <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">nr_block</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nr</span> <span class="o">/</span> <span class="n">nblocks</span><span class="p">)</span>
        <span class="n">row_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="o">*</span> <span class="n">nr_block</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">)]</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">matrix_copy_block</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_block</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">row_start</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">blocks</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_packed_corr_mat</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list containing the upper diagonal values of the</span>
<span class="sd">        correlation matrix calculated between columns of 2D matrix flex.double</span>
<span class="sd">        matrix m&quot;&quot;&quot;</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col1</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col1</span> <span class="o">==</span> <span class="n">col2</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Avoid spuriously high correlation between a column that should be</span>
                    <span class="c1"># zero (such as the gradient of X residuals wrt the Shift2 parameter)</span>
                    <span class="c1"># and another column (such as the gradient of X residuals wrt the</span>
                    <span class="c1"># Dist parameter) by rounding values to 15 places. It seems that such</span>
                    <span class="c1"># spurious correlations may occur in cases where gradients are</span>
                    <span class="c1"># calculated to be zero by matrix operations, rather than set to zero.</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">matrix_copy_column</span><span class="p">(</span><span class="n">col1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">matrix_copy_column</span><span class="p">(</span><span class="n">col2</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">linear_correlation</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span><span class="o">.</span><span class="n">coefficient</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">tmp</span>

<div class="viewcode-block" id="Refinery.get_correlation_matrix_for_step">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.get_correlation_matrix_for_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_correlation_matrix_for_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each type of residual (e.g. X, Y, Phi), decompress and return the</span>
<span class="sd">        full 2D correlation matrix between columns of the Jacobian that was</span>
<span class="sd">        stored in the journal at the given step number. If not available, return</span>
<span class="sd">        None&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;parameter_correlation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">packed_mats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;parameter_correlation&quot;</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">packed_mats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">packed_mats</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">packed_mats</span><span class="p">)</span>

        <span class="n">nparam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">packed_mats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">nparam</span><span class="p">,</span> <span class="n">nparam</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparam</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">nparam</span><span class="p">):</span>
                    <span class="n">corr_mat</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">corr_mat</span><span class="o">.</span><span class="n">matrix_copy_upper_to_lower_triangle_in_place</span><span class="p">()</span>
            <span class="n">packed_mats</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_mat</span>
        <span class="k">return</span> <span class="n">packed_mats</span></div>


<div class="viewcode-block" id="Refinery.jacobian_condition_number">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.jacobian_condition_number">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">jacobian_condition_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the condition number of the Jacobian, for tracking in the</span>
<span class="sd">        refinement journal, if requested. The condition number of a matrix A is</span>
<span class="sd">        defined as cond(A) = ||A|| ||inv(A)||. For a rectangular matrix the inverse</span>
<span class="sd">        operation refers to the Moore-Penrose pseudoinverse. Various matrix norms</span>
<span class="sd">        can be used, resulting in numerically different condition numbers, however</span>
<span class="sd">        the 2-norm is commonly used. In that case, the definition is equivalent</span>
<span class="sd">        to the ratio of the largest to smallest singular values of the matrix:</span>
<span class="sd">        cond(A) = sig_(A) / sig_min(A). That is the calculation that is performed</span>
<span class="sd">        here.</span>

<span class="sd">        The condition number is a measure of how accurate the solution x to the</span>
<span class="sd">        equation Ax = b will be. Essentially it measures how errors are amplified</span>
<span class="sd">        through the linear equation. The condition number is large in the case that</span>
<span class="sd">        the columns of A are nearly linearly-dependent (and infinite for a singular</span>
<span class="sd">        matrix). We use it here then to detect situations where the correlation</span>
<span class="sd">        between effects of different parameter shifts becomes large and therefore</span>
<span class="sd">        refinement is problematic.</span>

<span class="sd">        Note, the Jacobian used here does not include any additional rows due to</span>
<span class="sd">        restraints terms that might be applied, or any parameter reduction due to</span>
<span class="sd">        constraints. Therefore this condition number relates to the pure linearised</span>
<span class="sd">        (Gauss-Newton) step, which might not actually be what the refinement engine</span>
<span class="sd">        uses. It can be indicative of issues in the fundamental set up of the least</span>
<span class="sd">        squares problem, even if these issues are avoided in practice (e.g. by</span>
<span class="sd">        use of an algorithm like Levenberg-Marquardt, inclusion of restraints or</span>
<span class="sd">        parameter reduction).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The Jacobian might be a sparse matrix</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span><span class="o">.</span><span class="n">as_dense_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">scitbx.linalg.svd</span><span class="w"> </span><span class="kn">import</span> <span class="n">real</span> <span class="k">as</span> <span class="n">svd_real</span>

        <span class="n">svd</span> <span class="o">=</span> <span class="n">svd_real</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># The condition number is the ratio of the largest to the smallest singular</span>
        <span class="c1"># values of the matrix</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">svd</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">svd</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span></div>


<div class="viewcode-block" id="Refinery.test_for_termination">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.test_for_termination">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_for_termination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if refinement should be terminated&quot;&quot;&quot;</span>

        <span class="c1"># Basic version delegate to the Target class. Derived classes may</span>
        <span class="c1"># implement other termination criteria</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_achieved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">achieved</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_achieved</span></div>


<div class="viewcode-block" id="Refinery.test_rmsd_convergence">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.test_rmsd_convergence">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_rmsd_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for convergence of RMSDs&quot;&quot;&quot;</span>

        <span class="c1"># http://en.wikipedia.org/wiki/</span>
        <span class="c1"># Non-linear_least_squares#Convergence_criteria</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;rmsd&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;rmsd&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">abs</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.0001</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span></div>


<div class="viewcode-block" id="Refinery.test_objective_increasing_but_not_nref">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.test_objective_increasing_but_not_nref">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_objective_increasing_but_not_nref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for an increase in the objective value between steps. This</span>
<span class="sd">        could be caused simply by the number of matches between observations</span>
<span class="sd">        and predictions increasing. However, if the number of matches stayed</span>
<span class="sd">        the same or reduced then this is a bad sign.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;num_reflections&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;num_reflections&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">l1</span> <span class="o">&gt;</span> <span class="n">l2</span> <span class="ow">and</span> <span class="n">n1</span> <span class="o">&lt;=</span> <span class="n">n2</span></div>


<div class="viewcode-block" id="Refinery.set_nproc">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.set_nproc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_nproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nproc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set number of processors for multiprocessing. Override in derived classes</span>
<span class="sd">        if a policy dictates that this must not be user-controlled&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span> <span class="o">=</span> <span class="n">nproc</span></div>


<div class="viewcode-block" id="Refinery.run">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.Refinery.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be implemented by derived class. It is expected that each step of</span>
<span class="sd">        refinement be preceded by a call to prepare_for_step and followed by</span>
<span class="sd">        calls to update_journal and test_for_termination (in that order).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Specify a minimizer and its parameters, and run</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_dump_normal_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output the full normal matrix at the current step as a string for debugging.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normal_matrix_packed_u</span><span class="p">()</span>
                <span class="o">.</span><span class="n">matrix_packed_u_as_symmetric</span><span class="p">()</span>
                <span class="o">.</span><span class="n">as_scitbx_matrix</span><span class="p">()</span>
                <span class="o">.</span><span class="n">matlab_form</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one_row_per_line</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Unavailable&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_jacobian_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the structure of the Jacobian matrix and output as a table for</span>
<span class="sd">        display&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span><span class="o">.</span><span class="n">cols</span><span class="p">()):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                    <span class="s2">&quot;structural_zeroes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">col</span><span class="o">.</span><span class="n">non_zeroes</span><span class="p">),</span>
                    <span class="s2">&quot;all_zeroes&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">col</span><span class="o">.</span><span class="n">as_dense_vector</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="DisableMPmixin">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.DisableMPmixin">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DisableMPmixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A mixin class that disables setting of nproc for multiprocessing&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DisableMPmixin.set_nproc">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.DisableMPmixin.set_nproc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_nproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nproc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nproc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="AdaptLbfgs">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLbfgs">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AdaptLbfgs</span><span class="p">(</span><span class="n">Refinery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adapt Refinery for L-BFGS minimiser&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptLbfgs.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLbfgs.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Refinery</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_termination_params</span> <span class="o">=</span> <span class="n">lbfgs</span><span class="o">.</span><span class="n">termination_parameters</span><span class="p">(</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_string</span> <span class="o">=</span> <span class="n">StringIO</span></div>


<div class="viewcode-block" id="AdaptLbfgs.compute_functional_and_gradients">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLbfgs.compute_functional_and_gradients">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_functional_and_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">dL_dp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_functional_gradients_and_curvatures</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="n">dL_dp</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g</span></div>


<div class="viewcode-block" id="AdaptLbfgs.compute_functional_gradients_and_curvatures">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLbfgs.compute_functional_gradients_and_curvatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_functional_gradients_and_curvatures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_step</span><span class="p">()</span>

        <span class="c1"># observation terms</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">split_matches_into_blocks</span><span class="p">(</span><span class="n">nproc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">task_results</span> <span class="o">=</span> <span class="n">easy_mp</span><span class="o">.</span><span class="n">parallel_map</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_functional_gradients_and_curvatures</span><span class="p">,</span>
                <span class="n">iterable</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span>
                <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;multiprocessing&quot;</span><span class="p">,</span>
                <span class="n">preserve_exception_message</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_results</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_functional_gradients_and_curvatures</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span>
            <span class="p">]</span>

        <span class="c1"># reduce blockwise results</span>
        <span class="n">flist</span><span class="p">,</span> <span class="n">glist</span><span class="p">,</span> <span class="n">clist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">task_results</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">glist</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">clist</span><span class="p">)]</span>

        <span class="c1"># restraints terms</span>
        <span class="n">restraints</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_restraints_functional_gradients_and_curvatures</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">restraints</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">+=</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>

        <span class="c1"># compact and reorder according to the constraints</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">constrain_gradient_vector</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">constrain_gradient_vector</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptLbfgs.callback_after_step">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLbfgs.callback_after_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">callback_after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimizer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do journalling, evaluate rmsds and return True if the target is</span>
<span class="sd">        reached to terminate the refinement.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_journal</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_nrows</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_for_termination</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">TARGET_ACHIEVED</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_rmsd_convergence</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">RMSD_CONVERGED</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AdaptLbfgs.run_lbfgs">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLbfgs.run_lbfgs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_lbfgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curvatures</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the minimiser, keeping track of its log.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ref_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_string</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">curvatures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diag_mode</span> <span class="o">=</span> <span class="s2">&quot;always&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">lbfgs</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">target_evaluator</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">termination_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_termination_params</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="n">ref_log</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">ref_log</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="n">ref_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;lbfgs minimizer stop: &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">+=</span> <span class="n">msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">error</span></div>
</div>



<div class="viewcode-block" id="SimpleLBFGS">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.SimpleLBFGS">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimpleLBFGS</span><span class="p">(</span><span class="n">AdaptLbfgs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refinery implementation, using cctbx LBFGS with basic settings&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimpleLBFGS.run">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.SimpleLBFGS.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_lbfgs</span><span class="p">(</span><span class="n">curvatures</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LBFGScurvs">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LBFGScurvs">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LBFGScurvs</span><span class="p">(</span><span class="n">AdaptLbfgs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refinery implementation using cctbx LBFGS with curvatures&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LBFGScurvs.run">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LBFGScurvs.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_lbfgs</span><span class="p">(</span><span class="n">curvatures</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="LBFGScurvs.compute_functional_gradients_diag">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LBFGScurvs.compute_functional_gradients_diag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_functional_gradients_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">dL_dp</span><span class="p">,</span> <span class="n">curvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_functional_gradients_and_curvatures</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="n">dL_dp</span>

        <span class="c1"># Curvatures of zero will cause a crash, because their inverse is taken.</span>
        <span class="k">assert</span> <span class="n">curvs</span><span class="o">.</span><span class="n">all_gt</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">diags</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">curvs</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;  curv: &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2"> &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">curvs</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">curvs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">,</span> <span class="n">diags</span></div>
</div>



<div class="viewcode-block" id="AdaptLstbx">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AdaptLstbx</span><span class="p">(</span><span class="n">Refinery</span><span class="p">,</span> <span class="n">normal_eqns</span><span class="o">.</span><span class="n">non_linear_ls</span><span class="p">,</span> <span class="n">normal_eqns</span><span class="o">.</span><span class="n">non_linear_ls_mixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adapt Refinery for lstbx&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptLstbx.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">prediction_parameterisation</span><span class="p">,</span>
        <span class="n">constraints_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tracking</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">Refinery</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">prediction_parameterisation</span><span class="p">,</span>
            <span class="n">constraints_manager</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
            <span class="n">tracking</span><span class="o">=</span><span class="n">tracking</span><span class="p">,</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># required for restart to work (do I need that method?)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>

        <span class="c1"># keep attribute for the Cholesky factor required for ESD calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">normal_eqns</span><span class="o">.</span><span class="n">non_linear_ls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_parameters</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="AdaptLstbx.restart">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.restart">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_x</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptLstbx.parameter_vector_norm">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.parameter_vector_norm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parameter_vector_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span></div>


<div class="viewcode-block" id="AdaptLstbx.build_up">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.build_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># code here to calculate the residuals. Rely on the target class</span>
        <span class="c1"># for this</span>

        <span class="c1"># I need to use the weights. They are the variances of the</span>
        <span class="c1"># observations... See http://en.wikipedia.org/wiki/Non-linear_least_squares</span>
        <span class="c1"># at &#39;diagonal weight matrix&#39;</span>

        <span class="c1"># set current parameter values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_step</span><span class="p">()</span>

        <span class="c1"># Reset the state to construction time, i.e. no equations accumulated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># observation terms</span>
        <span class="k">if</span> <span class="n">objective_only</span><span class="p">:</span>
            <span class="n">residuals</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_residuals</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_residuals</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">split_matches_into_blocks</span><span class="p">(</span><span class="n">nproc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># ensure the jacobian is not tracked</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># processing functions</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">task_wrapper</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
                    <span class="p">(</span>
                        <span class="n">residuals</span><span class="p">,</span>
                        <span class="n">jacobian</span><span class="p">,</span>
                        <span class="n">weights</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_residuals_and_gradients</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;residuals&quot;</span><span class="p">:</span> <span class="n">residuals</span><span class="p">,</span>
                        <span class="s2">&quot;jacobian&quot;</span><span class="p">:</span> <span class="n">jacobian</span><span class="p">,</span>
                        <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
                    <span class="p">}</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">callback_wrapper</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;jacobian&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">constrain_jacobian</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_equations</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">])</span>
                    <span class="c1"># no longer need the result</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;jacobian&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">return</span>

                <span class="n">easy_mp</span><span class="o">.</span><span class="n">parallel_map</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">task_wrapper</span><span class="p">,</span>
                    <span class="n">iterable</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nproc</span><span class="p">,</span>
                    <span class="n">callback</span><span class="o">=</span><span class="n">callback_wrapper</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;multiprocessing&quot;</span><span class="p">,</span>
                    <span class="n">preserve_exception_message</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">residuals</span><span class="p">,</span>
                        <span class="n">jacobian</span><span class="p">,</span>
                        <span class="n">weights</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_residuals_and_gradients</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">jacobian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">constrain_jacobian</span><span class="p">(</span><span class="n">jacobian</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">add_equations</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">jacobian</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

                <span class="c1"># Keep reference to the Jacobian in case required by the Journal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jacobian</span> <span class="o">=</span> <span class="n">jacobian</span>

        <span class="c1"># restraints terms</span>
        <span class="n">restraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">compute_restraints_residuals_and_gradients</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">restraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">objective_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_residuals</span><span class="p">(</span><span class="n">restraints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span><span class="o">.</span><span class="n">constrain_jacobian</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_equations</span><span class="p">(</span><span class="n">restraints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">restraints</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="AdaptLstbx.step_forward">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.step_forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span></div>


<div class="viewcode-block" id="AdaptLstbx.step_backward">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.step_backward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_x</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="AdaptLstbx.set_cholesky_factor">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.set_cholesky_factor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_cholesky_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the Cholesky factor required for ESD calculation. This method is</span>
<span class="sd">        valid only for the LSTBX dense matrix interface&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_equations</span><span class="p">()</span><span class="o">.</span><span class="n">cholesky_factor_packed_u</span><span class="p">()</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="AdaptLstbx.calculate_esds">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.AdaptLstbx.calculate_esds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_esds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate ESDs of parameters&quot;&quot;&quot;</span>

        <span class="c1"># it is possible to get here with zero steps taken by the minimiser. For</span>
        <span class="c1"># example by failing for the MAX_TRIAL_ITERATIONS reason before any forward</span>
        <span class="c1"># steps are taken with the LevMar engine. If so the below is invalid,</span>
        <span class="c1"># so return early</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_nrows</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># if constraints were used then the normal matrix has fewer rows/columns</span>
        <span class="c1"># than the number of expanded parameters. At the moment, do not support</span>
        <span class="c1"># this calculation when constraints were used</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constr_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># invert normal matrix from N^-1 = (U^-1)(U^-1)^T</span>
        <span class="n">cf_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">matrix_packed_u_as_upper_triangle</span><span class="p">()</span><span class="o">.</span><span class="n">matrix_inversion</span><span class="p">()</span>
        <span class="n">nm_inv</span> <span class="o">=</span> <span class="n">cf_inv</span><span class="o">.</span><span class="n">matrix_multiply_transpose</span><span class="p">(</span><span class="n">cf_inv</span><span class="p">)</span>

        <span class="c1"># keep the estimated parameter variance-covariance matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_var_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nm_inv</span>
        <span class="c1"># send this back to the models to calculate their uncertainties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">calculate_model_state_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_var_cov</span><span class="p">)</span>

        <span class="c1"># send parameter variances back to the parameter classes</span>
        <span class="c1"># themselves, for reporting purposes and for building restraints</span>
        <span class="c1"># based on existing parameterisations.</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_var_cov</span><span class="o">.</span><span class="n">matrix_diagonal</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">s2</span><span class="o">.</span><span class="n">all_ge</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">set_param_esds</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GaussNewtonIterations">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.GaussNewtonIterations">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GaussNewtonIterations</span><span class="p">(</span><span class="n">AdaptLstbx</span><span class="p">,</span> <span class="n">normal_eqns_solving</span><span class="o">.</span><span class="n">iterations</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refinery implementation, using lstbx Gauss Newton iterations&quot;&quot;&quot;</span>

    <span class="c1"># defaults that may be overridden</span>
    <span class="n">gradient_threshold</span> <span class="o">=</span> <span class="mf">1.0e-10</span>
    <span class="n">step_threshold</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">damping_value</span> <span class="o">=</span> <span class="mf">0.0007</span>
    <span class="n">max_shift_over_esd</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">convergence_as_shift_over_esd</span> <span class="o">=</span> <span class="mf">1e-5</span>

<div class="viewcode-block" id="GaussNewtonIterations.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.GaussNewtonIterations.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">prediction_parameterisation</span><span class="p">,</span>
        <span class="n">constraints_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tracking</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">AdaptLstbx</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">prediction_parameterisation</span><span class="p">,</span>
            <span class="n">constraints_manager</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
            <span class="n">tracking</span><span class="o">=</span><span class="n">tracking</span><span class="p">,</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add an attribute to the journal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">)</span>  <span class="c1"># flex.double()</span>

        <span class="c1"># adopt any overrides of the defaults above</span>
        <span class="n">libtbx</span><span class="o">.</span><span class="n">adopt_optional_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span></div>


<div class="viewcode-block" id="GaussNewtonIterations.run">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.GaussNewtonIterations.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># prepare for first step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_up</span><span class="p">()</span>

        <span class="c1"># return early if refinement is not possible</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dof</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">DOF_TOO_LOW</span>
            <span class="k">return</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># set functional and gradients for the step (to add to the history)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">opposite_of_gradient</span><span class="p">()</span>

            <span class="c1"># cache some items for the journal prior to solve</span>
            <span class="n">pvn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_vector_norm</span><span class="p">()</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_of_gradient</span><span class="p">()</span><span class="o">.</span><span class="n">norm_inf</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;normal_matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">nm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump_normal_matrix</span><span class="p">()</span>

            <span class="c1"># solve the normal equations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

            <span class="c1"># standard journalling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_journal</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_nrows</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># add cached items to the journal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;parameter_vector_norm&quot;</span><span class="p">,</span> <span class="n">pvn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;gradient_norm&quot;</span><span class="p">,</span> <span class="n">gn</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;normal_matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;normal_matrix&quot;</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span>

            <span class="c1"># extra journalling post solve</span>
            <span class="k">if</span> <span class="s2">&quot;solution&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;solution&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="o">.</span><span class="n">step</span><span class="p">()</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;solution_norm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_sq</span><span class="p">())</span>

            <span class="c1"># test termination criteria</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_for_termination</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">TARGET_ACHIEVED</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_rmsd_convergence</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">RMSD_CONVERGED</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">had_too_small_a_step</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">STEP_TOO_SMALL</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_objective_increasing_but_not_nref</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">OBJECTIVE_INCREASE</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_backward</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;. Parameters set back one step&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_step</span><span class="p">()</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">MAX_ITERATIONS</span>
                <span class="k">break</span>

            <span class="c1"># prepare for next step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_up</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_cholesky_factor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_esds</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="LevenbergMarquardtIterations">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LevenbergMarquardtIterations">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LevenbergMarquardtIterations</span><span class="p">(</span><span class="n">GaussNewtonIterations</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refinery implementation, employing lstbx Levenberg Marquadt</span>
<span class="sd">    iterations&quot;&quot;&quot;</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="mf">1e-3</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span>

    <span class="nd">@mu</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="LevenbergMarquardtIterations.setup_mu">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LevenbergMarquardtIterations.setup_mu">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup initial value for mu&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_matrix_packed_u</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">matrix_packed_u_diagonal</span><span class="p">())</span></div>


<div class="viewcode-block" id="LevenbergMarquardtIterations.add_constant_to_diagonal">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LevenbergMarquardtIterations.add_constant_to_diagonal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_constant_to_diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the constant value mu to the diagonal of the normal matrix&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_matrix_packed_u</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">matrix_packed_u_diagonal_add_in_place</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span></div>


<div class="viewcode-block" id="LevenbergMarquardtIterations.report_progress">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LevenbergMarquardtIterations.report_progress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">report_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback within the refinement main loop that can be overridden to</span>
<span class="sd">        report the value of the objective function (and possibly) other details for</span>
<span class="sd">        long-running methods&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_run_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># add an attribute to the journal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;nu&quot;</span><span class="p">)</span>

        <span class="c1"># set max iterations if not already.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_up</span><span class="p">()</span>

        <span class="c1"># early test for linear independence, require all right hand side elements to be non-zero</span>
        <span class="n">RHS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_equations</span><span class="p">()</span><span class="o">.</span><span class="n">right_hand_side</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">RHS</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">RHS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">())</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mf">0.0</span>
            <span class="p">]</span>
            <span class="k">raise</span> <span class="n">DialsRefineRuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The normal equations have an indeterminate solution. The problematic parameters are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p_names</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># return early if refinement is not possible</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dof</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">DOF_TOO_LOW</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_mu</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># set functional and gradients for the step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">opposite_of_gradient</span><span class="p">()</span>

            <span class="c1"># cache some items for the journal prior to solve</span>
            <span class="n">pvn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_vector_norm</span><span class="p">()</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_of_gradient</span><span class="p">()</span><span class="o">.</span><span class="n">norm_inf</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;normal_matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">nm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump_normal_matrix</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_constant_to_diagonal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>

            <span class="c1"># solve the normal equations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

            <span class="c1"># keep the cholesky factor for ESD calculation if we end this step. Doing</span>
            <span class="c1"># it here ensures the normal equations are solved (cholesky_factor_packed_u</span>
            <span class="c1"># can only be called if that is the case)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cholesky_factor</span><span class="p">()</span>

            <span class="c1"># standard journalling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_journal</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_nrows</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># add cached items to the journal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;parameter_vector_norm&quot;</span><span class="p">,</span> <span class="n">pvn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;gradient_norm&quot;</span><span class="p">,</span> <span class="n">gn</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;normal_matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;normal_matrix&quot;</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span>

            <span class="c1"># extra journalling post solve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;nu&quot;</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;solution&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;solution&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="o">.</span><span class="n">step</span><span class="p">()</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;solution_norm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">set_last_cell</span><span class="p">(</span><span class="s2">&quot;reduced_chi_squared&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_sq</span><span class="p">())</span>

            <span class="c1"># test termination criteria before taking the next forward step</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">had_too_small_a_step</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">STEP_TOO_SMALL</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_for_termination</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">TARGET_ACHIEVED</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_rmsd_convergence</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">RMSD_CONVERGED</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iterations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">MAX_ITERATIONS</span>
                <span class="k">break</span>

            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">expected_decrease</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">*</span> <span class="n">h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expected_decrease</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">OBJECTIVE_FLAT</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_up</span><span class="p">(</span><span class="n">objective_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">objective_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_progress</span><span class="p">(</span><span class="n">objective_new</span><span class="p">)</span>
            <span class="n">actual_decrease</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">-</span> <span class="n">objective_new</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">actual_decrease</span> <span class="o">/</span> <span class="n">expected_decrease</span>
            <span class="k">if</span> <span class="n">rho</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">*=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">del_last_row</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">nu</span> <span class="o">&gt;=</span> <span class="mi">8192</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reason_for_termination</span> <span class="o">=</span> <span class="n">MAX_TRIAL_ITERATIONS</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">*=</span> <span class="n">nu</span>
                <span class="n">nu</span> <span class="o">*=</span> <span class="mi">2</span>

            <span class="c1"># prepare for next step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_up</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_esds</span><span class="p">()</span>

<div class="viewcode-block" id="LevenbergMarquardtIterations.run">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.refinement.html#dials.algorithms.refinement.engine.LevenbergMarquardtIterations.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_core</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_esds</span><span class="p">()</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../national_resource.html">US National Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &#169;2025, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>