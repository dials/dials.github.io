

<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dials.algorithms.indexing.indexer &#8212; DIALS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" href="../../../../_static/dials-styles.css" type="text/css" />
    <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="logoheader container">
  <a href="../../../../index.html">
  <img class="logoheader" alt="DIALS" src="../../../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dials.algorithms.indexing.indexer</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.metadata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">iotbx.phil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">libtbx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cctbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">sgtbx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dxtbx.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentList</span><span class="p">,</span> <span class="n">ImageSequence</span><span class="p">,</span> <span class="n">tof_helpers</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dials.util</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DialsIndexError</span><span class="p">,</span>
    <span class="n">DialsIndexRefineError</span><span class="p">,</span>
    <span class="n">assign_indices</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.compare_orientation_matrices</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">difference_rotation_matrix_axis_angle</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.max_cell</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_max_cell</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.symmetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SymmetryHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.refinement</span><span class="w"> </span><span class="kn">import</span> <span class="n">DialsRefineConfigError</span><span class="p">,</span> <span class="n">DialsRefineRuntimeError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.spot_finding.per_image_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">ice_rings_selection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.array_family</span><span class="w"> </span><span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.util.multi_dataset_handling</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_experiment_identifiers</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">max_cell_phil_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">max_cell_estimation</span>
<span class="s2">  .expert_level = 1</span>
<span class="s2">{</span>
<span class="s2">  filter_ice = True</span>
<span class="s2">    .type = bool</span>
<span class="s2">    .help = &quot;Filter out reflections at typical ice ring resolutions&quot;</span>
<span class="s2">            &quot;before max_cell estimation.&quot;</span>
<span class="s2">  filter_overlaps = True</span>
<span class="s2">    .type = bool</span>
<span class="s2">    .help = &quot;Filter out reflections with overlapping bounding boxes before&quot;</span>
<span class="s2">            &quot;max_cell estimation.&quot;</span>
<span class="s2">  overlaps_border = 0</span>
<span class="s2">    .type = int(value_min=0)</span>
<span class="s2">    .help = &quot;Optionally add a border around the bounding boxes before finding&quot;</span>
<span class="s2">            &quot;overlaps.&quot;</span>
<span class="s2">  multiplier = 1.3</span>
<span class="s2">    .type = float(value_min=0)</span>
<span class="s2">    .help = &quot;Multiply the estimated maximum basis vector length by this value.&quot;</span>
<span class="s2">    .expert_level = 2</span>
<span class="s2">  step_size = 45</span>
<span class="s2">    .type = float(value_min=0)</span>
<span class="s2">    .help = &quot;Step size, in degrees, of the blocks used to perform the max_cell &quot;</span>
<span class="s2">            &quot;estimation.&quot;</span>
<span class="s2">    .expert_level = 2</span>
<span class="s2">  nearest_neighbor_percentile = None</span>
<span class="s2">    .type = float(value_min=0, value_max=1)</span>
<span class="s2">    .help = &quot;Percentile of NN histogram to use for max cell determination.&quot;</span>
<span class="s2">    .expert_level = 2</span>
<span class="s2">  histogram_binning = linear *log</span>
<span class="s2">    .type = choice</span>
<span class="s2">    .help = &quot;Choose between linear or logarithmic bins for nearest neighbour&quot;</span>
<span class="s2">            &quot;histogram analysis.&quot;</span>
<span class="s2">  nn_per_bin = 5</span>
<span class="s2">    .type = int(value_min=1)</span>
<span class="s2">    .help = &quot;Target number of nearest neighbours per histogram bin.&quot;</span>
<span class="s2">  max_height_fraction = 0.25</span>
<span class="s2">    .type = float(value_min=0, value_max=1)</span>
<span class="s2">    .expert_level=2</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">phil_str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">indexing {</span>
<span class="sd">  nproc = 1</span>
<span class="sd">    .type = int(value_min=1)</span>
<span class="sd">    .help = &quot;The number of processes to use.&quot;</span>
<span class="sd">  mm_search_scope = 4.0</span>
<span class="sd">    .help = &quot;Global radius of origin offset search.&quot;</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  wide_search_binning = 2</span>
<span class="sd">    .help = &quot;Modify the coarseness of the wide grid search for the beam centre.&quot;</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  min_cell_volume = 25</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">    .help = &quot;Minimum unit cell volume (in Angstrom^3).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  min_cell = 3</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">    .help = &quot;Minimum length of candidate unit cell basis vectors (in Angstrom).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  max_cell = Auto</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">    .help = &quot;Maximum length of candidate unit cell basis vectors (in Angstrom).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  %s</span>
<span class="sd">  sigma_phi_deg = None</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">    .help = &quot;Override the phi sigmas for refinement. Mainly intended for single-shot&quot;</span>
<span class="sd">            &quot;rotation images where the phi sigma is almost certainly incorrect.&quot;</span>
<span class="sd">    .expert_level = 2</span>

<span class="sd">  known_symmetry {</span>
<span class="sd">    space_group = None</span>
<span class="sd">      .type = space_group</span>
<span class="sd">      .help = &quot;Target space group for indexing.&quot;</span>
<span class="sd">    unit_cell = None</span>
<span class="sd">      .type = unit_cell</span>
<span class="sd">      .help = &quot;Target unit cell for indexing.&quot;</span>
<span class="sd">    relative_length_tolerance = 0.1</span>
<span class="sd">      .type = float</span>
<span class="sd">      .help = &quot;Relative tolerance for unit cell lengths in unit cell comparison.&quot;</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">    absolute_angle_tolerance = 5</span>
<span class="sd">      .type = float</span>
<span class="sd">      .help = &quot;Angular tolerance (in degrees) in unit cell comparison.&quot;</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">    max_delta = 5</span>
<span class="sd">      .type = float(value_min=0)</span>
<span class="sd">      .help = &quot;Maximum allowed Le Page delta used in searching for basis vector&quot;</span>
<span class="sd">              &quot;combinations that are consistent with the given symmetry.&quot;</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">    A_matrix = None</span>
<span class="sd">      .type = floats(size=9)</span>
<span class="sd">      .help = &quot;A crystal setting A=UB matrix to construct a trial crystal model for indexing.&quot;</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">  }</span>

<span class="sd">  index_assignment {</span>
<span class="sd">    method = *simple local</span>
<span class="sd">      .type = choice</span>
<span class="sd">      .help = &quot;Choose between simple &#39;global&#39; index assignment and xds-style &quot;</span>
<span class="sd">              &quot;&#39;local&#39; index assignment.&quot;</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">    simple {</span>
<span class="sd">      hkl_tolerance = 0.3</span>
<span class="sd">        .type = float(value_min=0, value_max=0.5)</span>
<span class="sd">        .help = &quot;Maximum allowable deviation from integer-ness for assigning &quot;</span>
<span class="sd">                &quot;a miller index to a reciprocal lattice vector.&quot;</span>
<span class="sd">    }</span>
<span class="sd">    local</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">    {</span>
<span class="sd">      epsilon = 0.05</span>
<span class="sd">        .type = float</span>
<span class="sd">        .help = &quot;This corresponds to the xds parameter INDEX_ERROR=&quot;</span>
<span class="sd">      delta = 8</span>
<span class="sd">        .type = int</span>
<span class="sd">        .help = &quot;This corresponds to the xds parameter INDEX_MAGNITUDE=&quot;</span>
<span class="sd">      l_min = 0.8</span>
<span class="sd">        .type = float</span>
<span class="sd">        .help = &quot;This corresponds to the xds parameter INDEX_QUALITY=&quot;</span>
<span class="sd">      nearest_neighbours = 20</span>
<span class="sd">        .type = int(value_min=1)</span>
<span class="sd">    }</span>
<span class="sd">  }</span>
<span class="sd">  check_misindexing {</span>
<span class="sd">    grid_search_scope = 0</span>
<span class="sd">      .type = int</span>
<span class="sd">      .help = &quot;Search scope for testing misindexing on h, k, l.&quot;</span>
<span class="sd">  }</span>
<span class="sd">  debug = False</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  combine_scans = False</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  refinement_protocol {</span>
<span class="sd">    mode = *refine_shells repredict_only None</span>
<span class="sd">      .type = choice</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">      .help = &quot;refine_shells: if using sequences indexer, refine in increasing&quot;</span>
<span class="sd">              &quot;resolution cutoffs after indexing, if using stills indexer,&quot;</span>
<span class="sd">              &quot;refine all data up to d_min_start resolution once only.&quot;</span>
<span class="sd">              &quot;repredict_only: do not refine after indexing, just update spot&quot;</span>
<span class="sd">              &quot;predictions.&quot;</span>
<span class="sd">              &quot;None: do not refine and do not update spot predictions.&quot;</span>
<span class="sd">    n_macro_cycles = 5</span>
<span class="sd">      .type = int(value_min=1)</span>
<span class="sd">      .help = &quot;Maximum number of macro cycles of refinement, reindexing all&quot;</span>
<span class="sd">              &quot;reflections using updated geometry at the beginning of each&quot;</span>
<span class="sd">              &quot;cycle. Does not apply to stills.indexer=stills.&quot;</span>
<span class="sd">    d_min_step = Auto</span>
<span class="sd">      .type = float(value_min=0.0)</span>
<span class="sd">      .help = &quot;Reduction per step in d_min for reflections to include&quot;</span>
<span class="sd">              &quot;in refinement. Does not apply to stills.indexer=stills.&quot;</span>
<span class="sd">    d_min_start = None</span>
<span class="sd">      .type = float(value_min=0.0)</span>
<span class="sd">      .help = &quot;For sequences/stills indexer, the lower limit of d-spacing&quot;</span>
<span class="sd">              &quot;of reflections used in the first/the only round of refinement.&quot;</span>
<span class="sd">    d_min_final = None</span>
<span class="sd">      .type = float(value_min=0.0)</span>
<span class="sd">      .help = &quot;Do not ever include reflections below this value in refinement.&quot;</span>
<span class="sd">              &quot;Does not apply to stills.indexer=stills.&quot;</span>
<span class="sd">    disable_unit_cell_volume_sanity_check = False</span>
<span class="sd">      .type = bool</span>
<span class="sd">      .help = &quot;Disable sanity check on unrealistic increases in unit cell volume&quot;</span>
<span class="sd">              &quot;during refinement. Does not apply to stills.indexer=stills.&quot;</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">  }</span>
<span class="sd">  multiple_lattice_search</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">  {</span>
<span class="sd">    recycle_unindexed_reflections_cutoff = 0.1</span>
<span class="sd">      .type = float(value_min=0, value_max=1)</span>
<span class="sd">      .help = &quot;Attempt another cycle of indexing on the unindexed reflections &quot;</span>
<span class="sd">              &quot;if more than the fraction of input reflections are unindexed.&quot;</span>
<span class="sd">    minimum_angular_separation = 5</span>
<span class="sd">      .type = float(value_min=0)</span>
<span class="sd">      .help = &quot;The minimum angular separation (in degrees) between two lattices.&quot;</span>
<span class="sd">    max_lattices = 1</span>
<span class="sd">      .type = int</span>
<span class="sd">    cluster_analysis {</span>
<span class="sd">      method = *dbscan hcluster</span>
<span class="sd">        .type = choice</span>
<span class="sd">      hcluster {</span>
<span class="sd">        linkage {</span>
<span class="sd">          method = *ward</span>
<span class="sd">            .type = choice</span>
<span class="sd">          metric = *euclidean</span>
<span class="sd">            .type = choice</span>
<span class="sd">        }</span>
<span class="sd">        cutoff = 15</span>
<span class="sd">          .type = float(value_min=0)</span>
<span class="sd">        cutoff_criterion = *distance inconsistent</span>
<span class="sd">          .type = choice</span>
<span class="sd">      }</span>
<span class="sd">      dbscan {</span>
<span class="sd">        eps = 0.05</span>
<span class="sd">          .type = float(value_min=0.0)</span>
<span class="sd">        min_samples = 30</span>
<span class="sd">          .type = int(value_min=1)</span>
<span class="sd">      }</span>
<span class="sd">      min_cluster_size = 20</span>
<span class="sd">        .type = int(value_min=0)</span>
<span class="sd">      intersection_union_ratio_cutoff = 0.4</span>
<span class="sd">        .type = float(value_min=0.0, value_max=1.0)</span>
<span class="sd">    }</span>
<span class="sd">  }</span>
<span class="sd">  stills {</span>
<span class="sd">    indexer = *Auto stills sequences</span>
<span class="sd">      .type = choice</span>
<span class="sd">      .help = Use the stills or sequences indexer.  Auto: choose based on the input \</span>
<span class="sd">              imagesets (stills or sequences).</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">    ewald_proximity_resolution_cutoff = 2.0</span>
<span class="sd">      .type = float</span>
<span class="sd">      .help = For still images, this high-resolution cutoff is used to calculate</span>
<span class="sd">      .help = the acceptable volume of reciprocal space for spot prediction</span>
<span class="sd">    refine_all_candidates = True</span>
<span class="sd">      .type = bool</span>
<span class="sd">      .help = If False, no attempt is made to refine the model from initial basis \</span>
<span class="sd">              vector selection. The indexing solution with the best RMSD is chosen.</span>
<span class="sd">    candidate_outlier_rejection = True</span>
<span class="sd">      .type = bool</span>
<span class="sd">      .expert_level = 1</span>
<span class="sd">      .help = If True, while refining candidate basis solutions, also apply Sauter/ \</span>
<span class="sd">              Poon (2010) outlier rejection</span>
<span class="sd">    refine_candidates_with_known_symmetry = False</span>
<span class="sd">      .type = bool</span>
<span class="sd">      .expert_level = 2</span>
<span class="sd">      .help = If False, when choosing the best set of candidate basis solutions, \</span>
<span class="sd">              refine the candidates in the P1 setting. If True, after indexing \</span>
<span class="sd">              in P1, convert the candidates to the known symmetry and apply the \</span>
<span class="sd">              corresponding change of basis to the indexed reflections.</span>
<span class="sd">    rmsd_min_px = 2</span>
<span class="sd">      .type = float</span>
<span class="sd">      .help = Minimum acceptable RMSD for choosing candidate basis solutions \</span>
<span class="sd">              (in pixels)</span>
<span class="sd">    ewald_proximal_volume_max = 0.0025</span>
<span class="sd">      .type = float</span>
<span class="sd">      .help = Maximum acceptable ewald proximal volume when choosing candidate \</span>
<span class="sd">              basis solutions</span>
<span class="sd">    isoforms</span>
<span class="sd">      .help = Constrain the unit cell to specific values during refinement after initial indexing.</span>
<span class="sd">      .multiple=True</span>
<span class="sd">    {</span>
<span class="sd">      name=None</span>
<span class="sd">        .type=str</span>
<span class="sd">      cell=None</span>
<span class="sd">        .type=unit_cell</span>
<span class="sd">      lookup_symbol=None</span>
<span class="sd">        .type=str</span>
<span class="sd">        .help=The sgtbx lookup symbol of the reflections pointgroup</span>
<span class="sd">      rmsd_target_mm=None</span>
<span class="sd">        .type=float</span>
<span class="sd">        .help=Maximum acceptable DIALS positional rmsd, in mm</span>
<span class="sd">      beam_restraint=None</span>
<span class="sd">        .type=floats(size=2)</span>
<span class="sd">        .help=Known beam position in mm X,Y, rmsd_target_mm is reused here as a circle of confusion</span>
<span class="sd">        .help=to assure that no images are accepted where the lattice is misindexed by a unit shift.</span>
<span class="sd">    }</span>
<span class="sd">    set_domain_size_ang_value = None</span>
<span class="sd">      .type=float</span>
<span class="sd">      .help=If specified, will set the domain size ang value and override the value determined from nave refinement</span>
<span class="sd">    set_mosaic_half_deg_value = None</span>
<span class="sd">      .type=float</span>
<span class="sd">      .help=If specified, will set the mosaic half degree value and override the value determined from nave refinement</span>
<span class="sd">  }</span>
<span class="sd">}</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="o">%</span> <span class="n">max_cell_phil_str</span>
<span class="p">)</span>

<span class="n">phil_scope</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">phil_str</span><span class="p">,</span> <span class="n">process_includes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="Indexer">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Indexer</span><span class="p">:</span>
<div class="viewcode-block" id="Indexer.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="o">=</span> <span class="n">reflections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hkl_offset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index_assignment</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_indices</span> <span class="o">=</span> <span class="n">assign_indices</span><span class="o">.</span><span class="n">AssignIndicesLocal</span><span class="p">(</span>
                <span class="n">epsilon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index_assignment</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index_assignment</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
                <span class="n">l_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index_assignment</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
                <span class="n">nearest_neighbours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index_assignment</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">nearest_neighbours</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_indices</span> <span class="o">=</span> <span class="n">assign_indices</span><span class="o">.</span><span class="n">AssignIndicesGlobal</span><span class="p">(</span>
                <span class="n">tolerance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index_assignment</span><span class="o">.</span><span class="n">simple</span><span class="o">.</span><span class="n">hkl_tolerance</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">outlier</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">libtbx</span><span class="o">.</span><span class="n">Auto</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">goniometer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">outlier</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;sauter_poon&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># different default to dials.refine</span>
                <span class="c1"># tukey is faster and more appropriate at the indexing step</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">outlier</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;tukey&quot;</span>

        <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">is_similar_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detector</span><span class="p">):</span>
                <span class="n">expt</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detector</span>
            <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">goniometer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">expt</span><span class="o">.</span><span class="n">goniometer</span><span class="o">.</span><span class="n">is_similar_to</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">goniometer</span>
            <span class="p">):</span>
                <span class="n">expt</span><span class="o">.</span><span class="n">goniometer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">goniometer</span>
                <span class="c1"># can only share a beam if we share a goniometer?</span>
                <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">is_similar_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">beam</span><span class="p">):</span>
                    <span class="n">expt</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">beam</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">combine_scans</span> <span class="ow">and</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scan</span><span class="p">:</span>
                    <span class="n">expt</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scan</span>

        <span class="k">if</span> <span class="s2">&quot;flags&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">:</span>
            <span class="n">strong_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">strong</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strong_sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">strong_sel</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;flags&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="ow">or</span> <span class="n">strong_sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># backwards compatibility for testing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span>
                <span class="n">flex</span><span class="o">.</span><span class="n">size_t_range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">strong</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_symmetry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_indexing</span><span class="p">()</span></div>


<div class="viewcode-block" id="Indexer.from_parameters">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.from_parameters">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_parameters</span><span class="p">(</span>
        <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">known_crystal_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">known_crystal_models</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.known_orientation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">IndexerKnownOrientation</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">known_crystal_models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_space_group</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="n">idxr</span> <span class="o">=</span> <span class="n">IndexerKnownOrientation</span><span class="p">(</span>
                <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">known_crystal_models</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_stills</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_sequences</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">imageset</span><span class="p">,</span> <span class="n">ImageSequence</span><span class="p">):</span>
                    <span class="n">has_sequences</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">has_stills</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">has_stills</span> <span class="ow">and</span> <span class="n">has_sequences</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Please provide only stills or only sequences, not both&quot;</span>
                <span class="p">)</span>

            <span class="n">use_stills_indexer</span> <span class="o">=</span> <span class="n">has_stills</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">stills</span><span class="o">.</span><span class="n">indexer</span> <span class="ow">is</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">Auto</span>
                <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">stills</span><span class="o">.</span><span class="n">indexer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">stills</span><span class="o">.</span><span class="n">indexer</span> <span class="o">==</span> <span class="s2">&quot;stills&quot;</span><span class="p">:</span>
                    <span class="n">use_stills_indexer</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">stills</span><span class="o">.</span><span class="n">indexer</span> <span class="o">==</span> <span class="s2">&quot;sequences&quot;</span><span class="p">:</span>
                    <span class="n">use_stills_indexer</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">basis_vector_combinations</span><span class="o">.</span><span class="n">max_refine</span> <span class="ow">is</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">Auto</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_stills_indexer</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">basis_vector_combinations</span><span class="o">.</span><span class="n">max_refine</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">basis_vector_combinations</span><span class="o">.</span><span class="n">max_refine</span> <span class="o">=</span> <span class="mi">50</span>

            <span class="k">if</span> <span class="n">use_stills_indexer</span><span class="p">:</span>
                <span class="c1"># Ensure the indexer and downstream applications treat this as set of stills</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">dxtbx.imageset</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageSet</span>  <span class="c1"># , MemImageSet</span>

                <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
                    <span class="c1"># Elsewhere, checks are made for ImageSequence when picking between algorithms</span>
                    <span class="c1"># specific to rotations vs. stills, so here reset any ImageSequences to stills.</span>
                    <span class="c1"># Note, dials.stills_process resets ImageSequences to ImageSets already,</span>
                    <span class="c1"># and it&#39;s not free (the ImageSet cache is dropped), only do it if needed</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span><span class="p">,</span> <span class="n">ImageSequence</span><span class="p">):</span>
                        <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span> <span class="o">=</span> <span class="n">ImageSet</span><span class="p">(</span>
                            <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">indices</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="c1"># if isinstance(imageset, MemImageSet):</span>
                    <span class="c1">#   imageset = MemImageSet(imagesequence._images, imagesequence.indices())</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#   imageset = ImageSet(imagesequence.reader(), imagesequence.indices())</span>
                    <span class="c1">#   imageset._models = imagesequence._models</span>
                    <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">set_scan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span><span class="o">.</span><span class="n">set_goniometer</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">experiment</span><span class="o">.</span><span class="n">goniometer</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">IndexerType</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">entry_points</span><span class="p">(</span>
                <span class="n">group</span><span class="o">=</span><span class="s2">&quot;dials.index.basis_vector_search&quot;</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">entry_point</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">use_stills_indexer</span><span class="p">:</span>
                        <span class="c1"># do something</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.stills_indexer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                            <span class="n">StillsIndexerBasisVectorSearch</span> <span class="k">as</span> <span class="n">IndexerType</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.lattice_search</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                            <span class="n">BasisVectorSearch</span> <span class="k">as</span> <span class="n">IndexerType</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="n">IndexerType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">entry_points</span><span class="p">(</span>
                    <span class="n">group</span><span class="o">=</span><span class="s2">&quot;dials.index.lattice_search&quot;</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">indexing</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">entry_point</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">use_stills_indexer</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.stills_indexer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                                <span class="n">StillsIndexerLatticeSearch</span> <span class="k">as</span> <span class="n">IndexerType</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.lattice_search</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                                <span class="n">LatticeSearch</span> <span class="k">as</span> <span class="n">IndexerType</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="k">assert</span> <span class="n">IndexerType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">idxr</span> <span class="o">=</span> <span class="n">IndexerType</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">idxr</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target_unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">unit_cell</span>
        <span class="n">target_space_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span>
        <span class="k">if</span> <span class="n">target_space_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_space_group</span> <span class="o">=</span> <span class="n">target_space_group</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_space_group</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">space_group</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span> <span class="o">=</span> <span class="n">target_space_group</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry_handler</span> <span class="o">=</span> <span class="n">SymmetryHandler</span><span class="p">(</span>
            <span class="n">unit_cell</span><span class="o">=</span><span class="n">target_unit_cell</span><span class="p">,</span>
            <span class="n">space_group</span><span class="o">=</span><span class="n">target_space_group</span><span class="p">,</span>
            <span class="n">max_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">max_delta</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Indexer.setup_indexing">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.setup_indexing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_indexing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DialsIndexError</span><span class="p">(</span><span class="s2">&quot;No reflections left to index!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;imageset_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;imageset_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">centroid_px_to_mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">map_centroids_to_reciprocal_space</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">calculate_entering_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">find_max_cell</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">sigma_phi_deg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_x</span><span class="p">,</span> <span class="n">var_y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;xyzobs.mm.variance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">()</span>
            <span class="n">var_phi_rad</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span>
                <span class="n">var_x</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">sigma_phi_deg</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;xyzobs.mm.variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">(</span>
                <span class="n">var_x</span><span class="p">,</span> <span class="n">var_y</span><span class="p">,</span> <span class="n">var_phi_rad</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_write_reciprocal_lattice_points_as_pdb</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Indexer.index">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="n">ExperimentList</span><span class="p">()</span>

        <span class="n">had_refinement_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">have_similar_crystal_models</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">had_refinement_error</span> <span class="ow">or</span> <span class="n">have_similar_crystal_models</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">max_lattices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">multiple_lattice_search</span><span class="o">.</span><span class="n">max_lattices</span>
            <span class="k">if</span> <span class="n">max_lattices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="n">max_lattices</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cutoff_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">multiple_lattice_search</span><span class="o">.</span><span class="n">recycle_unindexed_reflections_cutoff</span>
                <span class="n">d_spacings</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;rlp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">norms</span><span class="p">()</span>
                <span class="n">d_min_indexed</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d_spacings</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexed_reflections</span><span class="p">))</span>
                <span class="n">min_reflections_for_indexing</span> <span class="o">=</span> <span class="n">cutoff_fraction</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">d_spacings</span> <span class="o">&gt;</span> <span class="n">d_min_indexed</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">crystal_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">d_spacings</span> <span class="o">&gt;</span> <span class="n">d_min_indexed</span><span class="p">)[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">crystal_ids</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_reflections_for_indexing</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Finish searching for more lattices: </span><span class="si">%i</span><span class="s2"> unindexed reflections remaining.&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">crystal_ids</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">break</span>

            <span class="n">n_lattices_previous_cycle</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_start</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_expts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_lattices</span><span class="p">()</span>
                <span class="n">generate_experiment_identifiers</span><span class="p">(</span><span class="n">new_expts</span><span class="p">)</span>
                <span class="n">experiments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_expts</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_lattices</span><span class="p">()</span>
                    <span class="n">generate_experiment_identifiers</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
                    <span class="n">experiments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">DialsIndexError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Indexing remaining reflections failed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_step</span> <span class="ow">is</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">Auto</span><span class="p">:</span>
                <span class="n">n_cycles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">n_macro_cycles</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_cycles</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_step</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d_spacings</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;rlp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">norms</span><span class="p">()</span>
                    <span class="n">d_min_all</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d_spacings</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_step</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">-</span> <span class="n">d_min_all</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cycles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Using d_min_step </span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_step</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DialsIndexError</span><span class="p">(</span><span class="s2">&quot;No suitable lattice could be found.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">())</span> <span class="o">==</span> <span class="n">n_lattices_previous_cycle</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No more suitable lattices could be found&quot;</span><span class="p">)</span>
                <span class="c1"># no more lattices found</span>
                <span class="k">break</span>

            <span class="k">for</span> <span class="n">i_cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">n_macro_cycles</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">i_cycle</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_step</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="n">d_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_step</span>
                    <span class="n">d_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_final</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">d_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_final</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d_min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">=</span> <span class="n">d_min</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Increasing resolution to </span><span class="si">%.2f</span><span class="s2"> Angstrom&quot;</span><span class="p">,</span> <span class="n">d_min</span><span class="p">)</span>

                <span class="c1"># reset reflection lattice flags</span>
                <span class="c1"># the lattice a given reflection belongs to: a value of -1 indicates</span>
                <span class="c1"># that a reflection doesn&#39;t belong to any lattice so far</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">index_reflections</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i_cycle</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_symmetry_post_indexing</span><span class="p">(</span>
                        <span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span> <span class="n">n_lattices_previous_cycle</span>
                    <span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Indexed crystal models:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span> <span class="n">d_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_min</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_similar_crystal_models</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
                    <span class="n">have_similar_crystal_models</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting refinement (macro-cycle </span><span class="si">%i</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">i_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indexed_reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>

                <span class="n">sel</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Note, anything below d_min doesn&#39;t get indexed so has an id of -1</span>
                <span class="c1"># so code below is redundant?</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;rlp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">norms</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">isel</span> <span class="o">=</span> <span class="p">(</span><span class="n">lengths</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span><span class="p">)</span><span class="o">.</span><span class="n">iselection</span><span class="p">()</span>
                    <span class="n">sel</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">isel</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="n">sel</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">unset_flags</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">indexed</span><span class="p">)</span>
                <span class="c1"># N.B. we don&#39;t set self.unindexed_reflections here, as we don&#39;t want to overwrite yet</span>
                <span class="c1"># if the refinement cycle below fails</span>
                <span class="n">unindexed_reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="n">sel</span>
                <span class="p">)</span>  <span class="c1"># reflections that have an id of -1</span>

                <span class="n">reflections_for_refinement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">indexed_reflections</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;repredict_only&quot;</span><span class="p">:</span>
                    <span class="n">refined_experiments</span><span class="p">,</span> <span class="n">refined_reflections</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">experiments</span><span class="p">,</span>
                        <span class="n">reflections_for_refinement</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.refinement.prediction.managed_predictors</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                        <span class="n">ExperimentsPredictorFactory</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">ref_predictor</span> <span class="o">=</span> <span class="n">ExperimentsPredictorFactory</span><span class="o">.</span><span class="n">from_experiments</span><span class="p">(</span>
                        <span class="n">experiments</span><span class="p">,</span>
                        <span class="n">spherical_relp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">parameterisation</span><span class="o">.</span><span class="n">spherical_relp_model</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">ref_predictor</span><span class="p">(</span><span class="n">refined_reflections</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">refined_experiments</span><span class="p">,</span> <span class="n">refined_reflections</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">experiments</span><span class="p">,</span>
                        <span class="n">reflections_for_refinement</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">refined_experiments</span><span class="p">,</span> <span class="n">refined_reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span>
                            <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections_for_refinement</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">DialsRefineConfigError</span><span class="p">,</span> <span class="n">DialsRefineRuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">DialsIndexRefineError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="n">had_refinement_error</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Refinement failed:&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="c1"># need to remove crystals - may be shared!</span>
                        <span class="n">models_to_remove</span> <span class="o">=</span> <span class="n">experiments</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">crystal</span><span class="o">=</span><span class="n">experiments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">crystal</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models_to_remove</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">experiments</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span>
                            <span class="c1"># remove experiment id from the reflections associated</span>
                            <span class="c1"># with this deleted experiment - indexed flag removed</span>
                            <span class="c1"># below</span>
                            <span class="c1"># note here we are acting on the table from the last macrocycle</span>
                            <span class="c1"># This is guaranteed to exist due to the check if len(experiments) == 1: above</span>
                            <span class="c1"># N.B. Need to unset the flags here as the break below means we</span>
                            <span class="c1"># don&#39;t enter the code after</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_id_from_reflections</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_unit_cell_volume_sanity_check</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">refined_experiments</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span> <span class="o">=</span> <span class="n">refined_reflections</span>
                <span class="c1"># id can be -1 if some were determined as outliers in self.refine</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">unset_flags</span><span class="p">(</span>
                        <span class="n">sel</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">indexed</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;miller_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span>
                        <span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">unindexed_reflections</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">~</span><span class="n">sel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">clean_experiment_identifiers_map</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unindexed_reflections</span> <span class="o">=</span> <span class="n">unindexed_reflections</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">):</span>
                    <span class="n">ref_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;imageset_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                    <span class="p">)</span>
                    <span class="n">ref_sel</span> <span class="o">=</span> <span class="n">ref_sel</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ref_sel</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_expt</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">ref_sel</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]):</span>
                        <span class="n">refined_expt</span> <span class="o">=</span> <span class="n">refined_experiments</span><span class="p">[</span><span class="n">i_expt</span><span class="p">]</span>
                        <span class="n">expt</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">refined_expt</span><span class="o">.</span><span class="n">detector</span>
                        <span class="n">expt</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="n">refined_expt</span><span class="o">.</span><span class="n">beam</span>
                        <span class="n">expt</span><span class="o">.</span><span class="n">goniometer</span> <span class="o">=</span> <span class="n">refined_expt</span><span class="o">.</span><span class="n">goniometer</span>
                        <span class="n">expt</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">refined_expt</span><span class="o">.</span><span class="n">scan</span>
                        <span class="n">refined_expt</span><span class="o">.</span><span class="n">imageset</span> <span class="o">=</span> <span class="n">expt</span><span class="o">.</span><span class="n">imageset</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">parameterisation</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">fix</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="o">.</span><span class="n">refinement</span><span class="o">.</span><span class="n">parameterisation</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">fix</span>
                    <span class="o">==</span> <span class="s2">&quot;all&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># Experimental geometry may have changed - re-map centroids to</span>
                    <span class="c1"># reciprocal space</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">map_centroids_to_reciprocal_space</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

                <span class="c1"># update for next cycle</span>
                <span class="n">experiments</span> <span class="o">=</span> <span class="n">refined_experiments</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span> <span class="o">=</span> <span class="n">refined_experiments</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Refined crystal models:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_experiments</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">,</span>
                    <span class="n">d_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_min</span><span class="p">,</span>
                    <span class="n">unindexed_reflections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unindexed_reflections</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">i_cycle</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">d_min_final</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Target d_min_final reached: finished with refinement&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DialsIndexRefineError</span><span class="p">(</span><span class="s2">&quot;None of the experiments could refine.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.compare_orientation_matrices</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">rotation_matrix_differences</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">rotation_matrix_differences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">())</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;xyzcal.mm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyzcal_mm_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refined_experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_id_from_reflections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_id</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span>
            <span class="kc">True</span>
        <span class="p">):</span>  <span class="c1"># not the case if failure on first cycle of refinement of new xtal</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Removing </span><span class="si">%d</span><span class="s2"> reflections with id </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">model_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">experiment_identifiers</span><span class="p">()[</span><span class="n">model_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">unset_flags</span><span class="p">(</span>
                <span class="n">sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">indexed</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;miller_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unindexed_reflections</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">~</span><span class="n">sel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refined_reflections</span><span class="o">.</span><span class="n">clean_experiment_identifiers_map</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_unit_cell_volume_sanity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_experiments</span><span class="p">,</span> <span class="n">refined_experiments</span><span class="p">):</span>
        <span class="c1"># sanity check for unrealistic unit cell volume increase during refinement</span>
        <span class="c1"># usually this indicates too many parameters are being refined given the</span>
        <span class="c1"># number of observations provided.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">refinement_protocol</span><span class="o">.</span><span class="n">disable_unit_cell_volume_sanity_check</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">orig_expt</span><span class="p">,</span> <span class="n">refined_expt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">original_experiments</span><span class="p">,</span> <span class="n">refined_experiments</span>
            <span class="p">):</span>
                <span class="n">uc1</span> <span class="o">=</span> <span class="n">orig_expt</span><span class="o">.</span><span class="n">crystal</span><span class="o">.</span><span class="n">get_unit_cell</span><span class="p">()</span>
                <span class="n">uc2</span> <span class="o">=</span> <span class="n">refined_expt</span><span class="o">.</span><span class="n">crystal</span><span class="o">.</span><span class="n">get_unit_cell</span><span class="p">()</span>
                <span class="n">volume_change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uc1</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span> <span class="o">-</span> <span class="n">uc2</span><span class="o">.</span><span class="n">volume</span><span class="p">())</span> <span class="o">/</span> <span class="n">uc1</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span>
                <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">volume_change</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;Unrealistic unit cell volume increase during refinement of </span><span class="si">%.1f%%</span><span class="s2">.&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Please try refining fewer parameters, either by enforcing symmetry&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;constraints (space_group=) and/or disabling experimental geometry&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;refinement (detector.fix=all and beam.fix=all). To disable this&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;sanity check set disable_unit_cell_volume_sanity_check=True.&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">volume_change</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">DialsIndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_symmetry_post_indexing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">n_lattices_previous_cycle</span>
    <span class="p">):</span>
        <span class="c1"># now apply the space group symmetry only after the first indexing</span>
        <span class="c1"># need to make sure that the symmetrized orientation is similar to the P1 model</span>
        <span class="k">for</span> <span class="n">cryst</span> <span class="ow">in</span> <span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">()[</span><span class="n">n_lattices_previous_cycle</span><span class="p">:]:</span>
            <span class="n">new_cryst</span><span class="p">,</span> <span class="n">cb_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry_handler</span><span class="o">.</span><span class="n">apply_symmetry</span><span class="p">(</span><span class="n">cryst</span><span class="p">)</span>
            <span class="n">new_cryst</span> <span class="o">=</span> <span class="n">new_cryst</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">cb_op</span><span class="p">)</span>
            <span class="n">cryst</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cryst</span><span class="p">)</span>
            <span class="n">cryst</span><span class="o">.</span><span class="n">set_space_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">space_group</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i_expt</span><span class="p">,</span> <span class="n">expt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">crystal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">cryst</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cb_op</span><span class="o">.</span><span class="n">is_identity_op</span><span class="p">():</span>
                    <span class="n">miller_indices</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;miller_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i_expt</span>
                    <span class="p">)</span>
                    <span class="n">miller_indices</span> <span class="o">=</span> <span class="n">cb_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">miller_indices</span><span class="p">)</span>
                    <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;miller_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span>
                        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i_expt</span><span class="p">,</span> <span class="n">miller_indices</span>
                    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_similar_crystal_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks for too-similar crystal models and removes them.</span>

<span class="sd">        Checks whether the most recently added crystal model is similar to previously</span>
<span class="sd">        found crystal models, and if so, deletes the last crystal model from the</span>
<span class="sd">        experiment list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">have_similar_crystal_models</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cryst_b</span> <span class="o">=</span> <span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_a</span><span class="p">,</span> <span class="n">cryst_a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">R_ab</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">cb_op_ab</span> <span class="o">=</span> <span class="n">difference_rotation_matrix_axis_angle</span><span class="p">(</span>
                <span class="n">cryst_a</span><span class="p">,</span> <span class="n">cryst_b</span>
            <span class="p">)</span>
            <span class="n">min_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">multiple_lattice_search</span><span class="o">.</span><span class="n">minimum_angular_separation</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_angle</span><span class="p">:</span>  <span class="c1"># degrees</span>
                <span class="c1"># account for potential shared crystal model</span>
                <span class="n">models_to_reject</span> <span class="o">=</span> <span class="n">experiments</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">crystal</span><span class="o">=</span><span class="n">cryst_b</span><span class="p">)</span>
                <span class="n">reject</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crystal models too similar, rejecting crystal </span><span class="si">{</span><span class="n">reject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Rotation matrix to transform crystal </span><span class="si">{</span><span class="n">i_a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> to crystal </span><span class="si">{</span><span class="n">reject</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">R_ab</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Rotation of </span><span class="si">{</span><span class="n">angle</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> degrees&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot; about axis (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">axis</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">have_similar_crystal_models</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models_to_reject</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">experiments</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
                    <span class="c1"># Unset ids in the reflection table</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remove_id_from_reflections</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">have_similar_crystal_models</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_xyzcal_mm_to_px</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
        <span class="c1"># set xyzcal.px field in reflections</span>
        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;xyzcal.px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
            <span class="n">imgset_sel</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;imageset_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
            <span class="n">refined_reflections</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">imgset_sel</span><span class="p">)</span>
            <span class="n">panel_numbers</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">size_t</span><span class="p">(</span><span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;panel&quot;</span><span class="p">])</span>
            <span class="n">xyzcal_mm</span> <span class="o">=</span> <span class="n">refined_reflections</span><span class="p">[</span><span class="s2">&quot;xyzcal.mm&quot;</span><span class="p">]</span>
            <span class="n">x_mm</span><span class="p">,</span> <span class="n">y_mm</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">xyzcal_mm</span><span class="o">.</span><span class="n">parts</span><span class="p">()</span>
            <span class="n">xy_cal_mm</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec2_double</span><span class="p">(</span><span class="n">x_mm</span><span class="p">,</span> <span class="n">y_mm</span><span class="p">)</span>
            <span class="n">xy_cal_px</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec2_double</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xy_cal_mm</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i_panel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">detector</span><span class="p">)):</span>
                <span class="n">panel</span> <span class="o">=</span> <span class="n">expt</span><span class="o">.</span><span class="n">detector</span><span class="p">[</span><span class="n">i_panel</span><span class="p">]</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">panel_numbers</span> <span class="o">==</span> <span class="n">i_panel</span>
                <span class="n">xy_cal_px</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span>
                    <span class="n">sel</span><span class="p">,</span> <span class="n">panel</span><span class="o">.</span><span class="n">millimeter_to_pixel</span><span class="p">(</span><span class="n">xy_cal_mm</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="n">x_px</span><span class="p">,</span> <span class="n">y_px</span> <span class="o">=</span> <span class="n">xy_cal_px</span><span class="o">.</span><span class="n">parts</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">has_property</span><span class="p">(</span><span class="s2">&quot;time_of_flight&quot;</span><span class="p">):</span>
                    <span class="n">tof</span> <span class="o">=</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;time_of_flight&quot;</span><span class="p">)</span>
                    <span class="n">frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tof</span><span class="p">)))</span>
                    <span class="n">tof_to_frame</span> <span class="o">=</span> <span class="n">tof_helpers</span><span class="o">.</span><span class="n">tof_to_frame_interpolator</span><span class="p">(</span><span class="n">tof</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">tof</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">tof</span><span class="p">))</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">tof</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tof</span><span class="p">))</span>
                    <span class="n">z_px</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">tof_to_frame</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">has_property</span><span class="p">(</span><span class="s2">&quot;oscillation&quot;</span><span class="p">):</span>
                    <span class="n">z_px</span> <span class="o">=</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_array_index_from_angle</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z_px</span> <span class="o">=</span> <span class="n">z</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># must be a still image, z centroid not meaningful</span>
                <span class="n">z_px</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">xyzcal_px</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">(</span><span class="n">x_px</span><span class="p">,</span> <span class="n">y_px</span><span class="p">,</span> <span class="n">z_px</span><span class="p">)</span>
            <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;xyzcal.px&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">imgset_sel</span><span class="p">,</span> <span class="n">xyzcal_px</span><span class="p">)</span>

<div class="viewcode-block" id="Indexer.show_experiments">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.show_experiments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_experiments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">d_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unindexed_reflections</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">d_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reciprocal_lattice_points</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;rlp&quot;</span><span class="p">]</span>
            <span class="n">d_spacings</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">reciprocal_lattice_points</span><span class="o">.</span><span class="n">norms</span><span class="p">()</span>
            <span class="n">reflections</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">d_spacings</span> <span class="o">&gt;</span> <span class="n">d_min</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unindexed_reflections</span><span class="p">:</span>
                <span class="n">reciprocal_lattice_points</span> <span class="o">=</span> <span class="n">unindexed_reflections</span><span class="p">[</span><span class="s2">&quot;rlp&quot;</span><span class="p">]</span>
                <span class="n">d_spacings</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">reciprocal_lattice_points</span><span class="o">.</span><span class="n">norms</span><span class="p">()</span>
                <span class="n">unindexed_reflections</span> <span class="o">=</span> <span class="n">unindexed_reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">d_spacings</span> <span class="o">&gt;</span> <span class="n">d_min</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_expt</span><span class="p">,</span> <span class="n">expt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;model </span><span class="si">%i</span><span class="s2"> (</span><span class="si">%i</span><span class="s2"> reflections):&quot;</span><span class="p">,</span>
                <span class="n">i_expt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i_expt</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">expt</span><span class="o">.</span><span class="n">crystal</span><span class="p">)</span>

        <span class="n">indexed_flags</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">indexed</span><span class="p">)</span>
        <span class="n">ice_rings</span> <span class="o">=</span> <span class="n">ice_rings_selection</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unindexed_reflections</span><span class="p">:</span>
            <span class="n">unindexed_rings</span> <span class="o">=</span> <span class="n">ice_rings_selection</span><span class="p">(</span><span class="n">unindexed_reflections</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unindexed_rings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">imageset_id</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;imageset_id&quot;</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;Imageset&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# indexed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# unindexed</span><span class="se">\n</span><span class="s2">total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;# unindexed</span><span class="se">\n</span><span class="s2">non-ice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">% i</span><span class="s2">ndexed&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imageset_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">imageset_id</span> <span class="o">==</span> <span class="n">i</span>
            <span class="n">imageset_indexed_flags</span> <span class="o">=</span> <span class="n">indexed_flags</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="n">ice</span> <span class="o">=</span> <span class="n">ice_rings</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="n">indexed_count</span> <span class="o">=</span> <span class="n">imageset_indexed_flags</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">unindexed_count</span> <span class="o">=</span> <span class="n">imageset_indexed_flags</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">unindexed_noice</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">imageset_indexed_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ice</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">unindexed_reflections</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">unindexed_reflections</span><span class="p">[</span><span class="s2">&quot;imageset_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span>
                <span class="n">unindexed_count</span> <span class="o">+=</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">unindexed_noice</span> <span class="o">+=</span> <span class="n">unindexed_rings</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">indexed_count</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">unindexed_count</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">unindexed_noice</span><span class="p">),</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indexed_count</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">indexed_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">unindexed_count</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">dials</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Indexer.find_max_cell">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.find_max_cell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_max_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_cell_estimation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_cell</span> <span class="ow">is</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">Auto</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">known_symmetry</span><span class="o">.</span><span class="n">unit_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">uc_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry_handler</span><span class="o">.</span><span class="n">target_symmetry_primitive</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_cell</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">uc_params</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using max_cell: </span><span class="si">%.1f</span><span class="s2"> Angstrom&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_cell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">convert_reflections_z_to_deg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">all_tof_experiments</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">expt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">expt</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">has_property</span><span class="p">(</span>
                        <span class="s2">&quot;time_of_flight&quot;</span>
                    <span class="p">):</span>
                        <span class="n">all_tof_experiments</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">all_tof_experiments</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot find max cell for ToF and non-ToF experiments at the same time&quot;</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="n">all_tof_experiments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">step_size</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting default ToF step size to 500 usec&quot;</span><span class="p">)</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">500</span>
                        <span class="n">convert_reflections_z_to_deg</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_cell</span> <span class="o">=</span> <span class="n">find_max_cell</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span>
                    <span class="n">max_cell_multiplier</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">multiplier</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
                    <span class="n">nearest_neighbor_percentile</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">nearest_neighbor_percentile</span><span class="p">,</span>
                    <span class="n">histogram_binning</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">histogram_binning</span><span class="p">,</span>
                    <span class="n">nn_per_bin</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">nn_per_bin</span><span class="p">,</span>
                    <span class="n">max_height_fraction</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">max_height_fraction</span><span class="p">,</span>
                    <span class="n">filter_ice</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">filter_ice</span><span class="p">,</span>
                    <span class="n">filter_overlaps</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">filter_overlaps</span><span class="p">,</span>
                    <span class="n">overlaps_border</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">overlaps_border</span><span class="p">,</span>
                    <span class="n">convert_reflections_z_to_deg</span><span class="o">=</span><span class="n">convert_reflections_z_to_deg</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">max_cell</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found max_cell: </span><span class="si">%.1f</span><span class="s2"> Angstrom&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_cell</span><span class="p">)</span></div>


<div class="viewcode-block" id="Indexer.index_reflections">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.index_reflections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_reflections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_indices</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">d_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hkl_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hkl_offset</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;miller_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_hkl_offset</span><span class="p">(</span>
                <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;miller_index&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hkl_offset</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hkl_offset</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Indexer.refine">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.refine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.indexing.refinement</span><span class="w"> </span><span class="kn">import</span> <span class="n">refine</span>

        <span class="n">properties_to_save</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;xyzcal.mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;entering&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wavelength_cal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s0_cal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tof_cal&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">refiner</span><span class="p">,</span> <span class="n">refined</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">refine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_params</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">outliers</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">predicted</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">predict_for_indexed</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">properties_to_save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">predicted</span><span class="p">:</span>
                <span class="n">reflections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">reflections</span><span class="o">.</span><span class="n">unset_flags</span><span class="p">(</span>
            <span class="n">flex</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">),</span> <span class="kc">True</span><span class="p">),</span> <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">centroid_outlier</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">centroid_outlier</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span>
            <span class="n">predicted</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">centroid_outlier</span><span class="p">),</span>
            <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">centroid_outlier</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span>
            <span class="n">refiner</span><span class="o">.</span><span class="n">selection_used_for_refinement</span><span class="p">(),</span>
            <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">used_in_refinement</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">refiner</span><span class="o">.</span><span class="n">get_experiments</span><span class="p">(),</span> <span class="n">reflections</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_debug_write_reciprocal_lattice_points_as_pdb</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;reciprocal_lattice.pdb&quot;</span>
    <span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cctbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">xray</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">crystal</span><span class="o">.</span><span class="n">symmetry</span><span class="p">(</span>
            <span class="n">unit_cell</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="n">space_group</span><span class="o">=</span><span class="s2">&quot;P1&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i_panel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detector</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detector</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;reciprocal_lattice_</span><span class="si">%i</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="n">i_panel</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span><span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">cs</span><span class="p">)</span>
                <span class="n">reflections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;panel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i_panel</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;rlp&quot;</span><span class="p">]:</span>
                    <span class="n">xs</span><span class="o">.</span><span class="n">add_scatterer</span><span class="p">(</span><span class="n">xray</span><span class="o">.</span><span class="n">scatterer</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">))</span>
                <span class="n">xs</span><span class="o">.</span><span class="n">sites_mod_short</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">as_pdb_file</span><span class="p">())</span>

<div class="viewcode-block" id="Indexer.export_as_json">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.export_as_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_as_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;indexed_experiments.json&quot;</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">experiments</span><span class="o">.</span><span class="n">is_consistent</span><span class="p">()</span>
        <span class="n">experiments</span><span class="o">.</span><span class="n">as_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Indexer.export_reflections">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.export_reflections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_reflections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;reflections.pickle&quot;</span><span class="p">):</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">as_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Indexer.find_lattices">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.Indexer.find_lattices">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_lattices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="apply_hkl_offset">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.indexing.html#dials.algorithms.indexing.indexer.apply_hkl_offset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_hkl_offset</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">as_vec3_double</span><span class="p">()</span><span class="o">.</span><span class="n">parts</span><span class="p">()</span>
    <span class="n">h</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">l</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flex</span><span class="o">.</span><span class="n">miller_index</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">iround</span><span class="p">(),</span> <span class="n">k</span><span class="o">.</span><span class="n">iround</span><span class="p">(),</span> <span class="n">l</span><span class="o">.</span><span class="n">iround</span><span class="p">())</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../national_resource.html">US National Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &#169;2025, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>