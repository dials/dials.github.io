

<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dials.algorithms.integration.integrator &#8212; DIALS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" href="../../../../_static/dials-styles.css" type="text/css" />
    <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="logoheader container">
  <a href="../../../../index.html">
  <img class="logoheader" alt="DIALS" src="../../../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dials.algorithms.integration.integrator</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dials.extensions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimingInfo</span><span class="p">,</span> <span class="n">processor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration.filtering</span><span class="w"> </span><span class="kn">import</span> <span class="n">IceRingFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration.parallel_integrator</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">IntegratorProcessor</span><span class="p">,</span>
    <span class="n">ReferenceCalculatorProcessor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration.processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Processor2D</span><span class="p">,</span>
    <span class="n">Processor3D</span><span class="p">,</span>
    <span class="n">ProcessorFlat3D</span><span class="p">,</span>
    <span class="n">ProcessorSingle2D</span><span class="p">,</span>
    <span class="n">ProcessorStills</span><span class="p">,</span>
    <span class="n">build_processor</span><span class="p">,</span>
    <span class="n">job</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration.report</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">IntegrationReport</span><span class="p">,</span>
    <span class="n">ProfileModelReport</span><span class="p">,</span>
    <span class="n">ProfileValidationReport</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidatedMultiExpProfileModeller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.profile_model.modeller</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiExpProfileModeller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.shoebox</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaskCode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.array_family</span><span class="w"> </span><span class="kn">import</span> <span class="n">flex</span>

<span class="c1"># constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EPS</span><span class="p">,</span> <span class="n">FULL_PARTIALITY</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sorry</span><span class="p">,</span> <span class="n">phil</span><span class="p">,</span> <span class="n">pprint</span><span class="p">,</span> <span class="n">tabulate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.util.command_line</span><span class="w"> </span><span class="kn">import</span> <span class="n">heading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.util.report</span><span class="w"> </span><span class="kn">import</span> <span class="n">Report</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.util.system</span><span class="w"> </span><span class="kn">import</span> <span class="n">MEMORY_LIMIT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials_algorithms_integration_integrator_ext</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Executor</span><span class="p">,</span>
    <span class="n">JobList</span><span class="p">,</span>
    <span class="n">ReflectionManager</span><span class="p">,</span>
    <span class="n">max_memory_needed</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Executor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Integrator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Integrator2D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Integrator3D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Integrator3DThreaded&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IntegratorExecutor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IntegratorFlat3D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IntegratorSingle2D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IntegratorStills&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JobList&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Parameters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Processor2D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Processor3D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ProcessorFlat3D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ProcessorSingle2D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ProcessorStills&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ProfileModellerExecutor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ProfileValidatorExecutor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ReflectionManager&quot;</span><span class="p">,</span>
    <span class="s2">&quot;frame_hist&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generate_phil_scope&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hist&quot;</span><span class="p">,</span>
    <span class="s2">&quot;job&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nframes_hist&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phil_scope&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="generate_phil_scope">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.generate_phil_scope">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_phil_scope</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the integration phil scope.</span>

<span class="sd">    :return: The phil scope</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    integration {</span>

<span class="sd">      include scope dials.data.lookup.phil_scope</span>

<span class="sd">      block {</span>

<span class="sd">        size = auto</span>
<span class="sd">          .type = float</span>
<span class="sd">          .help = &quot;The block size in rotation angle (degrees).&quot;</span>

<span class="sd">        units = *degrees radians frames</span>
<span class="sd">          .type = choice</span>
<span class="sd">          .help = &quot;The units of the block size&quot;</span>

<span class="sd">        threshold = 0.95</span>
<span class="sd">          .type = float(value_min=0.0, value_max=1.0)</span>
<span class="sd">          .help = &quot;For block size auto the block size is calculated by sorting&quot;</span>
<span class="sd">                  &quot;reflections by the number of frames they cover and then&quot;</span>
<span class="sd">                  &quot;selecting the block size to be 2*nframes[threshold] such&quot;</span>
<span class="sd">                  &quot;that 100*threshold % of reflections are guaranteed to be&quot;</span>
<span class="sd">                  &quot;fully contained in 1 block&quot;</span>

<span class="sd">        force = False</span>
<span class="sd">          .type = bool</span>
<span class="sd">          .help = &quot;If the number of processors is 1 and force is False, then the&quot;</span>
<span class="sd">                  &quot;number of blocks may be set to 1. If force is True then the&quot;</span>
<span class="sd">                  &quot;block size is always calculated.&quot;</span>

<span class="sd">        max_memory_usage = 0.90</span>
<span class="sd">          .type = float(value_min=0.0,value_max=1.0)</span>
<span class="sd">          .help = &quot;The maximum percentage of available memory to use for&quot;</span>
<span class="sd">                  &quot;allocating shoebox arrays.&quot;</span>

<span class="sd">      }</span>

<span class="sd">      use_dynamic_mask = True</span>
<span class="sd">        .type = bool</span>
<span class="sd">        .help = &quot;Use dynamic mask if available&quot;</span>

<span class="sd">      debug {</span>

<span class="sd">        reference {</span>

<span class="sd">          filename = &quot;reference_profiles.refl&quot;</span>
<span class="sd">            .type = str</span>
<span class="sd">            .help = &quot;The filename for the reference profiles&quot;</span>

<span class="sd">          output = False</span>
<span class="sd">            .type = bool</span>
<span class="sd">            .help = &quot;Save the reference profiles&quot;</span>
<span class="sd">        }</span>

<span class="sd">        during = modelling *integration</span>
<span class="sd">          .type = choice</span>
<span class="sd">          .help = &quot;Do debugging during modelling or integration&quot;</span>

<span class="sd">        output = False</span>
<span class="sd">          .type = bool</span>
<span class="sd">          .help = &quot;Save shoeboxes after each processing task.&quot;</span>

<span class="sd">        separate_files = True</span>
<span class="sd">          .type = bool</span>
<span class="sd">          .help = &quot;If this is true, the shoeboxes are saved in separate files&quot;</span>
<span class="sd">                  &quot;from the output integrated.refl file. This is necessary&quot;</span>
<span class="sd">                  &quot;in most cases since the amount of memory used by the&quot;</span>
<span class="sd">                  &quot;shoeboxes is typically greater than the available system&quot;</span>
<span class="sd">                  &quot;memory. If, however, you know that memory is not an issue,&quot;</span>
<span class="sd">                  &quot;you can saved the shoeboxes in the integrated.refl file&quot;</span>
<span class="sd">                  &quot;by setting this option to False. This only works if the debug&quot;</span>
<span class="sd">                  &quot;output is during integrated and not modelling.&quot;</span>

<span class="sd">        delete_shoeboxes = False</span>
<span class="sd">          .type = bool</span>
<span class="sd">          .help = &quot;Delete shoeboxes immediately before saving files. This option&quot;</span>
<span class="sd">                  &quot;in combination with debug.output=True enables intermediate&quot;</span>
<span class="sd">                  &quot;processing steps to make use of shoeboxes.&quot;</span>

<span class="sd">        select = None</span>
<span class="sd">          .type = reflection_table_selector</span>
<span class="sd">          .help = &quot;A string specifying the selection. The string should be of the&quot;</span>
<span class="sd">                  &quot;form: select=${COLUMN}[&lt;|&lt;=|==|!=|&gt;=|&gt;]${VALUE}. In addition&quot;</span>
<span class="sd">                  &quot;to the items in the reflection table, the following implicit&quot;</span>
<span class="sd">                  &quot;columns are defined if the necessary data is there:&quot;</span>
<span class="sd">                  &quot; intensity.sum.i_over_sigma&quot;</span>
<span class="sd">                  &quot; intensity.prf.i_over_sigma&quot;</span>

<span class="sd">        split_experiments = True</span>
<span class="sd">          .type = bool</span>
<span class="sd">          .help = &quot;Split shoeboxes into different files&quot;</span>

<span class="sd">      }</span>

<span class="sd">      integrator = *auto 3d flat3d 2d single2d stills 3d_threaded</span>
<span class="sd">        .type = choice</span>
<span class="sd">        .help = &quot;The integrator to use.&quot;</span>
<span class="sd">        .expert_level=3</span>

<span class="sd">      profile {</span>

<span class="sd">        fitting = True</span>
<span class="sd">          .type = bool</span>
<span class="sd">          .help = &quot;Use profile fitting if available&quot;</span>

<span class="sd">        valid_foreground_threshold = 0.75</span>
<span class="sd">          .type = float(value_min=0, value_max=1)</span>
<span class="sd">          .help = &quot;The minimum fraction of foreground pixels that must be valid&quot;</span>
<span class="sd">                  &quot;in order for a reflection to be integrated by profile fitting.&quot;</span>
<span class="sd">          .expert_level = 2</span>

<span class="sd">        sigma_b_multiplier = 2.0</span>
<span class="sd">          .type = float(value_min=1.0)</span>
<span class="sd">          .help = &quot;Background box expansion factor&quot;</span>
<span class="sd">          .expert_level = 3</span>

<span class="sd">        validation {</span>

<span class="sd">          number_of_partitions = 1</span>
<span class="sd">            .type = int(value_min=1)</span>
<span class="sd">            .help = &quot;The number of subsamples to take from the reference spots.&quot;</span>
<span class="sd">                    &quot;If the value is 1, then no validation is performed.&quot;</span>

<span class="sd">          min_partition_size = 100</span>
<span class="sd">            .type = int(value_min=1)</span>
<span class="sd">            .help = &quot;The minimum number of spots to use in each subsample.&quot;</span>

<span class="sd">        }</span>
<span class="sd">      }</span>

<span class="sd">      filter</span>
<span class="sd">        .expert_level = 1</span>
<span class="sd">      {</span>
<span class="sd">        min_zeta = 0.05</span>
<span class="sd">          .help = &quot;Filter the reflections by the value of zeta. A value of less&quot;</span>
<span class="sd">                  &quot;than or equal to zero indicates that this will not be used. A&quot;</span>
<span class="sd">                  &quot;positive value is used as the minimum permissible value.&quot;</span>
<span class="sd">          .type = float(value_min=0.0, value_max=1.0)</span>

<span class="sd">        ice_rings = False</span>
<span class="sd">          .help = &quot;Set the ice ring flags&quot;</span>
<span class="sd">          .type = bool</span>
<span class="sd">      }</span>

<span class="sd">      include scope dials.algorithms.integration.overlaps_filter.phil_scope</span>

<span class="sd">      mp {</span>
<span class="sd">        method = *multiprocessing drmaa sge lsf pbs</span>
<span class="sd">          .type = choice</span>
<span class="sd">          .help = &quot;The multiprocessing method to use&quot;</span>

<span class="sd">        njobs = 1</span>
<span class="sd">          .type = int(value_min=1)</span>
<span class="sd">          .help = &quot;The number of cluster jobs to use&quot;</span>

<span class="sd">        nproc = 1</span>
<span class="sd">          .type = int(value_min=1)</span>
<span class="sd">          .help = &quot;The number of processes to use per cluster job&quot;</span>

<span class="sd">        multiprocessing.n_subset_split = None</span>
<span class="sd">            .type = int(value_min=1)</span>
<span class="sd">            .help = &quot;Number of subsets to split the reflection table for integration.&quot;</span>
<span class="sd">      }</span>

<span class="sd">      summation {</span>
<span class="sd">        detector_gain = 1</span>
<span class="sd">          .type = float</span>
<span class="sd">          .help = &quot;Multiplier for variances after integration of still images.&quot;</span>
<span class="sd">                  &quot;See Leslie 1999.&quot;</span>
<span class="sd">      }</span>
<span class="sd">    }</span>
<span class="sd">  &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">process_includes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">main_scope</span> <span class="o">=</span> <span class="n">phil_scope</span><span class="o">.</span><span class="n">get_without_substitution</span><span class="p">(</span><span class="s2">&quot;integration&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_scope</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">main_scope</span> <span class="o">=</span> <span class="n">main_scope</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">main_scope</span><span class="o">.</span><span class="n">adopt_scope</span><span class="p">(</span><span class="n">dials</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">Background</span><span class="o">.</span><span class="n">phil_scope</span><span class="p">())</span>
    <span class="n">main_scope</span><span class="o">.</span><span class="n">adopt_scope</span><span class="p">(</span><span class="n">dials</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">Centroid</span><span class="o">.</span><span class="n">phil_scope</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">phil_scope</span></div>



<span class="c1"># The integration phil scope</span>
<span class="n">phil_scope</span> <span class="o">=</span> <span class="n">generate_phil_scope</span><span class="p">()</span>


<div class="viewcode-block" id="hist">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.hist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility function to print a histogram of reflections on frames.</span>

<span class="sd">    :param data: The data to histogram</span>
<span class="sd">    :param width: The number of characters in each line</span>
<span class="sd">    :param symbol: The plot symbol</span>
<span class="sd">    :param prefix: String to prefix to each line</span>
<span class="sd">    :return: The histogram string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Need &gt; 0 reflections&quot;</span>
    <span class="k">assert</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Width should be &gt; 0&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">frame</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span>
    <span class="n">max_frame</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">min_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="n">max_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">max_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Max should be &gt; 0&quot;</span>
    <span class="k">assert</span> <span class="n">min_count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Min should be &gt;= 0&quot;</span>
    <span class="k">if</span> <span class="n">max_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">num_frame_zeros</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_frame_zeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_frame</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">num_count_zeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_count</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">num_frame_zeros</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Num should be &gt; 0&quot;</span>
    <span class="k">assert</span> <span class="n">num_count_zeros</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Num should be &gt; 0&quot;</span>
    <span class="n">num_hist</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_frame_zeros</span> <span class="o">+</span> <span class="n">num_count_zeros</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">num_hist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;num_hist should be &gt; 0&quot;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%%</span><span class="s2">-</span><span class="si">%d</span><span class="s2">d [</span><span class="si">%%</span><span class="s2">-</span><span class="si">%d</span><span class="s2">d]: </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">num_frame_zeros</span><span class="p">,</span> <span class="n">num_count_zeros</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_hist</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_count</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="frame_hist">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.frame_hist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">frame_hist</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility function to print a histogram of reflections on frames.</span>

<span class="sd">    :param bbox: The bounding boxes</span>
<span class="sd">    :param width: The width of each line</span>
<span class="sd">    :param symbol: The histogram symbol</span>
<span class="sd">    :param prefix: A string to prefix to each line</span>
<span class="sd">    :return: The histogram string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">hist</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bbox</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">])],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="nframes_hist">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.nframes_hist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nframes_hist</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility function to print a histogram of number of frames.</span>

<span class="sd">    :param bbox: The bounding boxes</span>
<span class="sd">    :param width: The width of each line</span>
<span class="sd">    :param symbol: The histogram symbol</span>
<span class="sd">    :param prefix: A string to prefix to each line</span>
<span class="sd">    :return: The histogram string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">hist</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bbox</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span></div>



<div class="viewcode-block" id="Parameters">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Parameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A stack of classes to represent the integration parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Parameters.Filter">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.Filter">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Parameters.Filter.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.Filter.__init__">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_zeta</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">powder_filter</span> <span class="o">=</span> <span class="kc">None</span></div>
</div>


<div class="viewcode-block" id="Parameters.Profile">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.Profile">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Profile</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Profile parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Parameters.Profile.Validation">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.Profile.Validation">[docs]</a>
        <span class="k">class</span><span class="w"> </span><span class="nc">Validation</span><span class="p">:</span>
<div class="viewcode-block" id="Parameters.Profile.Validation.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.Profile.Validation.__init__">[docs]</a>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">number_of_partitions</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_partition_size</span> <span class="o">=</span> <span class="mi">100</span></div>
</div>


<div class="viewcode-block" id="Parameters.Profile.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.Profile.__init__">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitting</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_b_multiplier</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_foreground_threshold</span> <span class="o">=</span> <span class="mf">0.75</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">Profile</span><span class="o">.</span><span class="n">Validation</span><span class="p">()</span></div>
</div>


<div class="viewcode-block" id="Parameters.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelling</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">Filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_reference_filename</span> <span class="o">=</span> <span class="s2">&quot;reference_profiles.pickle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_reference_output</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Parameters.from_phil">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Parameters.from_phil">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_phil</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the phil parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Init the parameters</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>

        <span class="c1"># Create the multi processing parameters</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">MultiProcessing</span><span class="p">()</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">method</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">nproc</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">njobs</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">njobs</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">n_subset_split</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">n_subset_split</span>

        <span class="c1"># Set the lookup parameters</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">Lookup</span><span class="p">()</span>
        <span class="n">lookup</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">mask</span>

        <span class="c1"># Set the block parameters</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">Block</span><span class="p">()</span>
        <span class="n">block</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">size</span>
        <span class="n">block</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">units</span>
        <span class="n">block</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">threshold</span>
        <span class="n">block</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">force</span>
        <span class="n">block</span><span class="o">.</span><span class="n">max_memory_usage</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">max_memory_usage</span>

        <span class="c1"># Set the modelling processor parameters</span>
        <span class="n">result</span><span class="o">.</span><span class="n">modelling</span><span class="o">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span>
        <span class="n">result</span><span class="o">.</span><span class="n">modelling</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span>
        <span class="n">result</span><span class="o">.</span><span class="n">modelling</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">during</span> <span class="o">==</span> <span class="s2">&quot;modelling&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">modelling</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">output</span>
        <span class="n">result</span><span class="o">.</span><span class="n">modelling</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">select</span>
        <span class="n">result</span><span class="o">.</span><span class="n">modelling</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">separate_files</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Set the integration processor parameters</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">mp</span> <span class="o">=</span> <span class="n">mp</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">during</span> <span class="o">==</span> <span class="s2">&quot;integration&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">output</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">select</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">separate_files</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">separate_files</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">summation</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">summation</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">integrator</span>

        <span class="n">result</span><span class="o">.</span><span class="n">debug_reference_filename</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">result</span><span class="o">.</span><span class="n">debug_reference_output</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Profile parameters</span>
        <span class="n">result</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">sigma_b_multiplier</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">sigma_b_multiplier</span>
        <span class="n">result</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">valid_foreground_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">valid_foreground_threshold</span>
        <span class="p">)</span>

        <span class="c1"># Get the min zeta filter</span>
        <span class="n">result</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">min_zeta</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">min_zeta</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">ice_rings</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">powder_filter</span> <span class="o">=</span> <span class="n">IceRingFilter</span><span class="p">()</span>

        <span class="c1"># Get post-integration overlap filtering parameters</span>
        <span class="n">result</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">overlaps_filter</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">overlaps_filter</span>

        <span class="c1"># Set the profile fitting parameters</span>
        <span class="n">result</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">fitting</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">fitting</span>
        <span class="n">result</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">number_of_partitions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">number_of_partitions</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">min_partition_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">min_partition_size</span>
        <span class="p">)</span>

        <span class="c1"># Return the result</span>
        <span class="k">return</span> <span class="n">result</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_initialize_rotation</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pre-processing class for oscillation data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute some reflection properties</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">compute_zeta_multi</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">compute_d</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">compute_bbox</span><span class="p">(</span>
        <span class="n">experiments</span><span class="p">,</span> <span class="n">sigma_b_multiplier</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">sigma_b_multiplier</span>
    <span class="p">)</span>

    <span class="c1"># Filter the reflections by zeta</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;zeta&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">min_zeta</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">dont_integrate</span><span class="p">)</span>

    <span class="c1"># Filter the reflections by powder ring</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">powder_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">powder_filter</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">])</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">in_powder_ring</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_initialize_stills</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pre-processing class for stills data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute some reflection properties</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">compute_d</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">compute_bbox</span><span class="p">(</span>
        <span class="n">experiments</span><span class="p">,</span> <span class="n">sigma_b_multiplier</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">sigma_b_multiplier</span>
    <span class="p">)</span>

    <span class="c1"># Check the bounding boxes are all 1 frame in width</span>
    <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span><span class="o">.</span><span class="n">all_eq</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;bbox is invalid&quot;</span>

    <span class="c1"># Filter the reflections by powder ring</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">powder_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">powder_filter</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">])</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">in_powder_ring</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_finalize</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A generic post-processing function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">overlaps_scope</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">overlaps_filter</span>
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">overlaps_scope</span><span class="o">.</span><span class="n">foreground_foreground</span><span class="o">.</span><span class="n">enable</span><span class="p">,</span>
        <span class="n">overlaps_scope</span><span class="o">.</span><span class="n">foreground_background</span><span class="o">.</span><span class="n">enable</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.integration.overlaps_filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">OverlapsFilterMultiExpt</span>

        <span class="n">overlaps_filter</span> <span class="o">=</span> <span class="n">OverlapsFilterMultiExpt</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overlaps_scope</span><span class="o">.</span><span class="n">foreground_foreground</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="n">overlaps_filter</span><span class="o">.</span><span class="n">remove_foreground_foreground_overlaps</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">overlaps_scope</span><span class="o">.</span><span class="n">foreground_background</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="n">overlaps_filter</span><span class="o">.</span><span class="n">remove_foreground_background_overlaps</span><span class="p">()</span>
        <span class="n">reflections</span> <span class="o">=</span> <span class="n">overlaps_filter</span><span class="o">.</span><span class="n">refl</span>
    <span class="k">return</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_finalize_rotation</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A post-processing function for oscillation data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span> <span class="o">=</span> <span class="n">_finalize</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="c1"># Compute the corrections</span>
    <span class="n">reflections</span><span class="o">.</span><span class="n">compute_corrections</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_finalize_stills</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A post-processing function for stills data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span> <span class="o">=</span> <span class="n">_finalize</span><span class="p">(</span><span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="n">integrated</span> <span class="o">=</span> <span class="n">reflections</span>

    <span class="c1"># Select only those reflections which were integrated</span>
    <span class="k">if</span> <span class="s2">&quot;intensity.prf.variance&quot;</span> <span class="ow">in</span> <span class="n">integrated</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">integrated</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">integrated</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">integrated</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">integrated</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">integrated</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">integrated_sum</span><span class="p">)</span>
    <span class="n">integrated</span> <span class="o">=</span> <span class="n">integrated</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

    <span class="n">len_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">integrated</span><span class="p">)</span>
    <span class="n">integrated</span> <span class="o">=</span> <span class="n">integrated</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="o">~</span><span class="n">integrated</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">integrated</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">foreground_includes_bad_pixels</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Filtering </span><span class="si">%d</span><span class="s2"> reflections with at least one bad foreground pixel out of </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">len_all</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">integrated</span><span class="p">),</span>
        <span class="n">len_all</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># verify sigmas are sensible</span>
    <span class="k">if</span> <span class="s2">&quot;intensity.prf.value&quot;</span> <span class="ow">in</span> <span class="n">integrated</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.prf.variance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span>
                <span class="s2">&quot;Found negative variances (prf). Are bad pixels properly masked out?&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;intensity.sum.value&quot;</span> <span class="ow">in</span> <span class="n">integrated</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.variance&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.variance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span>
                    <span class="s2">&quot;Found negative variances (sum). Are bad pixels properly masked out?&quot;</span>
                <span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.variance&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.variance&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Filtering </span><span class="si">%d</span><span class="s2"> reflections with no integrated signal (sum and variance = 0) out of </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">n</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">integrated</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">integrated</span> <span class="o">=</span> <span class="n">integrated</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.variance&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span>
                    <span class="s2">&quot;Found reflections with variances == 0 but summed signal != 0&quot;</span>
                <span class="p">)</span>

        <span class="c1"># apply detector gain to summation variances</span>
        <span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;intensity.sum.variance&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">summation</span><span class="o">.</span><span class="n">detector_gain</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;background.sum.value&quot;</span> <span class="ow">in</span> <span class="n">integrated</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;background.sum.variance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span>
                <span class="s2">&quot;Found negative variances (background sum). Are bad pixels properly masked out?&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;background.sum.variance&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Filtering </span><span class="si">%d</span><span class="s2"> reflections with zero background variance&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;background.sum.variance&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">integrated</span> <span class="o">=</span> <span class="n">integrated</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;background.sum.variance&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># apply detector gain to background summation variances</span>
        <span class="n">integrated</span><span class="p">[</span><span class="s2">&quot;background.sum.variance&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">summation</span><span class="o">.</span><span class="n">detector_gain</span>
        <span class="p">)</span>

    <span class="n">reflections</span> <span class="o">=</span> <span class="n">integrated</span>

    <span class="k">return</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">experiments</span>


<div class="viewcode-block" id="ProfileModellerExecutor">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileModellerExecutor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProfileModellerExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class to do profile modelling calculations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__getstate_manages_dict__</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="ProfileModellerExecutor.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileModellerExecutor.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">profile_fitter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the executor</span>

<span class="sd">        :param experiments: The experiment list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span> <span class="o">=</span> <span class="n">profile_fitter</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProfileModellerExecutor.initialize">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileModellerExecutor.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the processing for a job</span>

<span class="sd">        :param frame0: The first frame in the job</span>
<span class="sd">        :param frame1: The last frame in the job</span>
<span class="sd">        :param reflections: The reflections that will be processed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Count &quot;effectively full&quot; and partial reflections N.B.</span>
        <span class="c1"># here effectively full is equivalent to area under a normal</span>
        <span class="c1"># curve to +/- 3 sigma</span>
        <span class="n">full_value</span> <span class="o">=</span> <span class="n">FULL_PARTIALITY</span> <span class="o">-</span> <span class="n">EPS</span>
        <span class="n">fully_recorded</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;partiality&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">full_value</span>
        <span class="n">npart</span> <span class="o">=</span> <span class="n">fully_recorded</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nfull</span> <span class="o">=</span> <span class="n">fully_recorded</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nice</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">in_powder_ring</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>

        <span class="c1"># Write some output</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Beginning modelling job </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Frames: </span><span class="si">%d</span><span class="s2"> -&gt; </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frame1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Number of reflections&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Partial:     </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">npart</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Full:        </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nfull</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  In ice ring: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nice</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Total:       </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ntot</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Print a histogram of reflections on frames</span>
        <span class="k">if</span> <span class="n">frame1</span> <span class="o">-</span> <span class="n">frame0</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot; The following histogram shows the number of reflections predicted&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; to have all or part of their intensity on each frame.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">frame_hist</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProfileModellerExecutor.process">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileModellerExecutor.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the data</span>

<span class="sd">        :param frame: The frame being processed</span>
<span class="sd">        :param reflections: The reflections to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if pixels are overloaded</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">is_overloaded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="c1"># Compute the shoebox mask</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="c1"># Process the data</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_background</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_centroid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_summed_intensity</span><span class="p">()</span>

        <span class="c1"># Do the profile modelling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>

        <span class="c1"># Print some info</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot; Modelled </span><span class="si">% 5d</span><span class="s2"> / </span><span class="si">% 5d</span><span class="s2"> reflection profiles on image </span><span class="si">%d</span><span class="s2">&quot;</span>
        <span class="n">nmod</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">used_in_modelling</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ntot</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProfileModellerExecutor.finalize">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileModellerExecutor.finalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ProfileModellerExecutor.data">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileModellerExecutor.data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the modeller</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__getinitargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Support for pickling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="p">)</span></div>



<div class="viewcode-block" id="ProfileValidatorExecutor">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileValidatorExecutor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProfileValidatorExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class to do profile validation calculations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__getstate_manages_dict__</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="ProfileValidatorExecutor.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileValidatorExecutor.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">profile_fitter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the executor</span>

<span class="sd">        :param experiments: The experiment list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span> <span class="o">=</span> <span class="n">profile_fitter</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProfileValidatorExecutor.initialize">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileValidatorExecutor.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the processing for a job</span>

<span class="sd">        :param frame0: The first frame in the job</span>
<span class="sd">        :param frame1: The last frame in the job</span>
<span class="sd">        :param reflections: The reflections that will be processed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get some info</span>
        <span class="n">full_value</span> <span class="o">=</span> <span class="n">FULL_PARTIALITY</span> <span class="o">-</span> <span class="n">EPS</span>
        <span class="n">fully_recorded</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;partiality&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">full_value</span>
        <span class="n">npart</span> <span class="o">=</span> <span class="n">fully_recorded</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nfull</span> <span class="o">=</span> <span class="n">fully_recorded</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nice</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">in_powder_ring</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>

        <span class="c1"># Write some output</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Beginning modelling job </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Frames: </span><span class="si">%d</span><span class="s2"> -&gt; </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Number of reflections&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Partial:     </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">npart</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Full:        </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nfull</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  In ice ring: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nice</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Total:       </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ntot</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Print a histogram of reflections on frames</span>
        <span class="k">if</span> <span class="n">frame1</span> <span class="o">-</span> <span class="n">frame0</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot; The following histogram shows the number of reflections predicted&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; to have all or part of their intensity on each frame.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">frame_hist</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ProfileValidatorExecutor.process">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileValidatorExecutor.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the data</span>

<span class="sd">        :param frame: The frame being processed</span>
<span class="sd">        :param reflections: The reflections to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if pixels are overloaded</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">is_overloaded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="c1"># Compute the shoebox mask</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="c1"># Process the data</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_background</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_centroid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_summed_intensity</span><span class="p">()</span>

        <span class="c1"># Do the profile validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>

        <span class="c1"># Print some info</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot; Validated </span><span class="si">% 5d</span><span class="s2"> / </span><span class="si">% 5d</span><span class="s2"> reflection profiles on image </span><span class="si">%d</span><span class="s2">&quot;</span>
        <span class="n">nmod</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">used_in_modelling</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ntot</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProfileValidatorExecutor.finalize">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileValidatorExecutor.finalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ProfileValidatorExecutor.data">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.ProfileValidatorExecutor.data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the modeller</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__getinitargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Support for pickling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="p">)</span></div>



<div class="viewcode-block" id="IntegratorExecutor">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorExecutor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntegratorExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class to process the integration data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__getstate_manages_dict__</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="IntegratorExecutor.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorExecutor.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">profile_fitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_foreground_threshold</span><span class="o">=</span><span class="mf">0.75</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the executor</span>

<span class="sd">        :param experiments: The experiment list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlaps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span> <span class="o">=</span> <span class="n">profile_fitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_foreground_threshold</span> <span class="o">=</span> <span class="n">valid_foreground_threshold</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>


<div class="viewcode-block" id="IntegratorExecutor.initialize">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorExecutor.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the processing for the job</span>

<span class="sd">        :param frame0: The first frame to process</span>
<span class="sd">        :param frame1: The last frame to process</span>
<span class="sd">        :param reflections: The reflections to process</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get some info</span>
        <span class="n">full_value</span> <span class="o">=</span> <span class="n">FULL_PARTIALITY</span> <span class="o">-</span> <span class="n">EPS</span>
        <span class="n">fully_recorded</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;partiality&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">full_value</span>
        <span class="n">npart</span> <span class="o">=</span> <span class="n">fully_recorded</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nfull</span> <span class="o">=</span> <span class="n">fully_recorded</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nice</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">in_powder_ring</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nint</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">dont_integrate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>

        <span class="c1"># Write some output</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Beginning integration job </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Frames: </span><span class="si">%d</span><span class="s2"> -&gt; </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Number of reflections&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Partial:     </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">npart</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Full:        </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nfull</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  In ice ring: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nice</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Integrate:   </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nint</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Total:       </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ntot</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Print a histogram of reflections on frames</span>
        <span class="k">if</span> <span class="n">frame1</span> <span class="o">-</span> <span class="n">frame0</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot; The following histogram shows the number of reflections predicted&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; to have all or part of their intensity on each frame.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">frame_hist</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Find any overlaps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlaps</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">find_overlaps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegratorExecutor.process">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorExecutor.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the reflections on a frame</span>

<span class="sd">        :param frame: The frame to process</span>
<span class="sd">        :param reflections: The reflections to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if pixels are overloaded</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">is_overloaded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="c1"># Compute the shoebox mask</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="c1"># Check for invalid pixels in foreground/background</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">contains_invalid_pixels</span><span class="p">()</span>

        <span class="c1"># Exclude reflections where a high fraction of the foreground is masked</span>
        <span class="c1"># e.g. due to a panel edge, as this will make the fitting unreliable.</span>
        <span class="n">sbox</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;shoebox&quot;</span><span class="p">]</span>
        <span class="n">nvalfg</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">count_mask_values</span><span class="p">(</span><span class="n">MaskCode</span><span class="o">.</span><span class="n">Valid</span> <span class="o">|</span> <span class="n">MaskCode</span><span class="o">.</span><span class="n">Foreground</span><span class="p">)</span>
        <span class="n">nforeg</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">count_mask_values</span><span class="p">(</span><span class="n">MaskCode</span><span class="o">.</span><span class="n">Foreground</span><span class="p">)</span>
        <span class="n">fraction_valid</span> <span class="o">=</span> <span class="n">nvalfg</span><span class="o">.</span><span class="n">as_double</span><span class="p">()</span> <span class="o">/</span> <span class="n">nforeg</span><span class="o">.</span><span class="n">as_double</span><span class="p">()</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">fraction_valid</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_foreground_threshold</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">dont_integrate</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">selection</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2"> reflections have&quot;</span>
            <span class="s2">&quot; a fraction of valid pixels below the valid foreground threshold&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Process the data</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_background</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_centroid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>

        <span class="n">reflections</span><span class="o">.</span><span class="n">compute_summed_intensity</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="p">:</span>
            <span class="n">reflections</span><span class="o">.</span><span class="n">compute_fitted_intensity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="p">)</span>

        <span class="c1"># Compute the number of background/foreground pixels</span>
        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;num_pixels.valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">count_mask_values</span><span class="p">(</span><span class="n">MaskCode</span><span class="o">.</span><span class="n">Valid</span><span class="p">)</span>
        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;num_pixels.background&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">count_mask_values</span><span class="p">(</span>
            <span class="n">MaskCode</span><span class="o">.</span><span class="n">Valid</span> <span class="o">|</span> <span class="n">MaskCode</span><span class="o">.</span><span class="n">Background</span>
        <span class="p">)</span>
        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;num_pixels.background_used&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">count_mask_values</span><span class="p">(</span>
            <span class="n">MaskCode</span><span class="o">.</span><span class="n">Valid</span> <span class="o">|</span> <span class="n">MaskCode</span><span class="o">.</span><span class="n">Background</span> <span class="o">|</span> <span class="n">MaskCode</span><span class="o">.</span><span class="n">BackgroundUsed</span>
        <span class="p">)</span>
        <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;num_pixels.foreground&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nvalfg</span>

        <span class="c1"># Print some info</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot; Integrated </span><span class="si">% 5d</span><span class="s2"> (sum) + </span><span class="si">% 5d</span><span class="s2"> (prf) / </span><span class="si">%5d</span><span class="s2"> reflections on image </span><span class="si">%d</span><span class="s2">&quot;</span>
        <span class="n">nsum</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">integrated_sum</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nprf</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">integrated_prf</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflections</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">nsum</span><span class="p">,</span> <span class="n">nprf</span><span class="p">,</span> <span class="n">ntot</span><span class="p">,</span> <span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntegratorExecutor.finalize">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorExecutor.finalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="IntegratorExecutor.data">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorExecutor.data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__getinitargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Support for pickling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_fitter</span><span class="p">)</span></div>



<div class="viewcode-block" id="Integrator">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Integrator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The integrator class</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Integrator.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the integrator</span>

<span class="sd">        :param experiments: The experiment list</span>
<span class="sd">        :param reflections: The reflections to process</span>
<span class="sd">        :param params: The parameters to use</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Save some stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="o">=</span> <span class="n">reflections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">from_phil</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Integrator.fit_profiles">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator.fit_profiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do profile fitting if appropriate.</span>

<span class="sd">        Sets self.profile_validation_report and self.profile_model_report.</span>

<span class="sd">        Returns profile_fitter (may be none)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fitting_class</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">fitting_class</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">]</span>
        <span class="n">fitting_avail</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fitting_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">fitting</span> <span class="ow">and</span> <span class="n">fitting_avail</span><span class="p">:</span>
            <span class="n">profile_fitting</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">profile_fitter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">profile_fitting</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">profile_fitter</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Do profile modelling</span>
        <span class="k">if</span> <span class="n">profile_fitting</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;Modelling reflection profiles&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Get the selection</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">get_flags</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">reference_spot</span>
            <span class="p">)</span>

            <span class="c1"># Get the reference spots</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

            <span class="c1"># Check if we need to skip</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;** Skipping profile modelling - no reference profiles given **&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to set up the validation</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">number_of_partitions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
                    <span class="n">k_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                            <span class="n">n</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">min_partition_size</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">k_max</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">number_of_partitions</span><span class="p">:</span>
                        <span class="n">num_folds</span> <span class="o">=</span> <span class="n">k_max</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">num_folds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">number_of_partitions</span>
                    <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">))</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">num_folds</span><span class="p">))</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
                        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                        <span class="n">reference</span><span class="p">[</span><span class="s2">&quot;profile.index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">size_t</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">num_folds</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_folds</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Create the profile fitter</span>
                <span class="n">profile_modellers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_folds</span><span class="p">):</span>
                    <span class="n">profile_fitter_single</span> <span class="o">=</span> <span class="n">MultiExpProfileModeller</span><span class="p">()</span>  <span class="c1"># (num_folds)</span>
                    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
                        <span class="n">profile_fitter_single</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">fitting_class</span><span class="p">()(</span><span class="n">expr</span><span class="p">))</span>
                    <span class="n">profile_modellers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile_fitter_single</span><span class="p">)</span>

                <span class="c1"># Create the data processor</span>
                <span class="n">executor</span> <span class="o">=</span> <span class="n">ProfileModellerExecutor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                    <span class="n">ValidatedMultiExpProfileModeller</span><span class="p">(</span><span class="n">profile_modellers</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">processor</span> <span class="o">=</span> <span class="n">build_processor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ProcessorClass</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                    <span class="n">reference</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">modelling</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">processor</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>

                <span class="c1"># Process the reference profiles</span>
                <span class="n">reference</span><span class="p">,</span> <span class="n">profile_fitter_list</span><span class="p">,</span> <span class="n">time_info</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

                <span class="c1"># Set the reference spots info</span>
                <span class="c1"># self.reflections.set_selected(selection, reference)</span>

                <span class="c1"># Finalize the profile models for validation</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">profile_fitter_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No profile fitters&quot;</span>
                <span class="n">profile_fitter</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="n">profile_fitter_list</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">pf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">profile_fitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">profile_fitter</span> <span class="o">=</span> <span class="n">pf</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">profile_fitter</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
                <span class="n">profile_fitter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

                <span class="c1"># Get the finalized modeller</span>
                <span class="n">finalized_profile_fitter</span> <span class="o">=</span> <span class="n">profile_fitter</span><span class="o">.</span><span class="n">finalized_model</span><span class="p">()</span>

                <span class="c1"># Dump reference profiles</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debug_reference_output</span><span class="p">:</span>
                    <span class="n">reference_debug</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finalized_profile_fitter</span><span class="p">)):</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">finalized_profile_fitter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                                        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                                        <span class="s2">&quot;coord&quot;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                                        <span class="s2">&quot;n_reflections&quot;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">n_reflections</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">reference_debug</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debug_reference_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">reference_debug</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

                <span class="c1"># Print profiles</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finalized_profile_fitter</span><span class="p">)):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">finalized_profile_fitter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Profiles for experiment </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Profile </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pprint</span><span class="o">.</span><span class="n">profile3d</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;** NO PROFILE **&quot;</span><span class="p">)</span>

                <span class="c1"># Print the modeller report</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="o">=</span> <span class="n">ProfileModelReport</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="n">finalized_profile_fitter</span><span class="p">,</span> <span class="n">reference</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span><span class="o">.</span><span class="n">as_str</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

                <span class="c1"># Print the time info</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Timing information for reference profile formation&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time_info</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># If we have more than 1 fold then do the validation</span>
                <span class="k">if</span> <span class="n">num_folds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Create the data processor</span>
                    <span class="n">executor</span> <span class="o">=</span> <span class="n">ProfileValidatorExecutor</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="n">profile_fitter</span>
                    <span class="p">)</span>
                    <span class="n">processor</span> <span class="o">=</span> <span class="n">build_processor</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ProcessorClass</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                        <span class="n">reference</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">modelling</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">processor</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>

                    <span class="c1"># Process the reference profiles</span>
                    <span class="n">reference</span><span class="p">,</span> <span class="n">validation</span><span class="p">,</span> <span class="n">time_info</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

                    <span class="c1"># Print the modeller report</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">profile_validation_report</span> <span class="o">=</span> <span class="n">ProfileValidationReport</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="n">profile_fitter</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">num_folds</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_validation_report</span><span class="o">.</span><span class="n">as_str</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

                    <span class="c1"># Print the time info</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Timing information for reference profile validation&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time_info</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Set to the finalized fitter</span>
                <span class="n">profile_fitter</span> <span class="o">=</span> <span class="n">finalized_profile_fitter</span>
        <span class="k">return</span> <span class="n">profile_fitter</span></div>


<div class="viewcode-block" id="Integrator.integrate">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator.integrate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure we get the same random sample each time</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Init the report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Heading</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;Processing reflections&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Print the summary</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot; Processing the following experiments:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Experiments: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Beams:       </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Detectors:   </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Goniometers: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Scans:       </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Crystals:    </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Imagesets:   </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">beams</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">detectors</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">goniometers</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">scans</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">imagesets</span><span class="p">()),</span>
        <span class="p">)</span>

        <span class="c1"># Initialize the reflections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_reflections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span>

        <span class="c1"># Check if we want to do some profile fitting</span>
        <span class="n">profile_fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_profiles</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;Integrating reflections&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Create the data processor</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">IntegratorExecutor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
            <span class="n">profile_fitter</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">valid_foreground_threshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># determine the max memory needed during integration</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_determine_max_memory_needed</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
            <span class="n">max_needed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">imageset</span> <span class="ow">in</span> <span class="n">experiments</span><span class="o">.</span><span class="n">imagesets</span><span class="p">():</span>
                <span class="c1"># find all experiments belonging to that imageset, as each</span>
                <span class="c1"># imageset is processed as a whole for integration.</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">identifiers</span><span class="p">()):</span>
                    <span class="n">expt_ids</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">experiment</span><span class="o">.</span><span class="n">identifier</span>
                        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">experiments</span>
                        <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span> <span class="o">==</span> <span class="n">imageset</span>
                    <span class="p">]</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">reflections</span><span class="o">.</span><span class="n">select_on_experiment_identifiers</span><span class="p">(</span><span class="n">expt_ids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">reflection_table</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">imageset</span> <span class="o">==</span> <span class="n">imageset</span><span class="p">:</span>
                            <span class="n">subset</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reflections</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">imageset</span><span class="o">.</span><span class="n">get_scan</span><span class="p">()</span> <span class="ow">or</span> <span class="n">imageset</span><span class="o">.</span><span class="n">get_scan</span><span class="p">()</span><span class="o">.</span><span class="n">is_still</span><span class="p">():</span>
                    <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">imageset</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span> <span class="o">=</span> <span class="n">imageset</span><span class="o">.</span><span class="n">get_scan</span><span class="p">()</span><span class="o">.</span><span class="n">get_array_range</span><span class="p">()</span>
                <span class="n">flatten</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;flat3d&quot;</span>
                <span class="n">max_needed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">max_memory_needed</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">frame0</span><span class="p">,</span> <span class="n">frame1</span><span class="p">,</span> <span class="n">flatten</span><span class="p">),</span>
                    <span class="n">max_needed</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">assert</span> <span class="n">max_needed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Could not determine memory requirements&quot;</span>
            <span class="k">return</span> <span class="n">max_needed</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_iterative_table_split</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">available_memory</span><span class="p">):</span>
            <span class="n">split_tables</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="n">mem_needed</span> <span class="o">=</span> <span class="n">_determine_max_memory_needed</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mem_needed</span> <span class="o">&gt;</span> <span class="n">available_memory</span><span class="p">:</span>
                    <span class="n">n_to_split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mem_needed</span> <span class="o">/</span> <span class="n">available_memory</span><span class="p">))</span>
                    <span class="n">flex</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">split_tables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">n_to_split</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">split_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_tables</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
                <span class="c1"># nothing was split, all passed memory check</span>
                <span class="k">return</span> <span class="n">split_tables</span>
            <span class="c1"># some tables were split - so need to check again that all are ok</span>
            <span class="k">return</span> <span class="n">_iterative_table_split</span><span class="p">(</span><span class="n">split_tables</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">available_memory</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_run_processor</span><span class="p">(</span><span class="n">reflections</span><span class="p">):</span>
            <span class="n">processor</span> <span class="o">=</span> <span class="n">build_processor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ProcessorClass</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                <span class="n">reflections</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
            <span class="c1"># Process the reflections</span>
            <span class="n">reflections</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">time_info</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">time_info</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;multiprocessing&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span> <span class="n">time_info</span> <span class="o">=</span> <span class="n">_run_processor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Here, don&#39;t consider nproc as the processor will reduce nproc to 1 if</span>
            <span class="c1"># necessary. Only want to split if we can&#39;t even process with nproc = 1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">n_subset_split</span><span class="p">:</span>
                <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">n_subset_split</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Need to do a memory check and decide whether to split table.</span>
                <span class="c1"># Split if its size in memory exceeds the fraction of available memory</span>
                <span class="c1"># specified by the PHIL parameter integration.block.max_memory_usage.</span>
                <span class="n">tables</span> <span class="o">=</span> <span class="n">_iterative_table_split</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                    <span class="n">MEMORY_LIMIT</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">max_memory_usage</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># will not fail a memory check in the processor, so proceed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span> <span class="n">time_info</span> <span class="o">=</span> <span class="n">_run_processor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Split the reflections and process by performing multiple</span>
                <span class="c1"># passes over each imageset</span>
                <span class="n">time_info</span> <span class="o">=</span> <span class="n">TimingInfo</span><span class="p">()</span>
                <span class="n">reflections</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">reflection_table</span><span class="p">()</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Predicted maximum memory needed exceeds available memory.</span>
<span class="sd">Splitting reflection table into %s subsets for processing</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing subset </span><span class="si">%s</span><span class="s2"> of reflection table&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">processed</span><span class="p">,</span> <span class="n">this_time_info</span> <span class="o">=</span> <span class="n">_run_processor</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="n">reflections</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
                    <span class="n">time_info</span> <span class="o">+=</span> <span class="n">this_time_info</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="o">=</span> <span class="n">reflections</span>

        <span class="c1"># Finalize the reflections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_reflections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="p">)</span>

        <span class="c1"># Create the integration report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span> <span class="o">=</span> <span class="n">IntegrationReport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span><span class="o">.</span><span class="n">as_str</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

        <span class="c1"># Print the time info</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Timing information for integration&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time_info</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Return the reflections</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span></div>


<div class="viewcode-block" id="Integrator.report">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator.report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the report of the processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Report</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Integrator.summary">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">block_size_units</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a summary of the integration stuff.&quot;&quot;&quot;</span>
        <span class="c1"># Compute the task table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments</span><span class="o">.</span><span class="n">all_stills</span><span class="p">():</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame From&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame To&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
                <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">frames</span><span class="p">()</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f0</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f1</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments</span><span class="o">.</span><span class="n">all_sequences</span><span class="p">():</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame From&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame To&quot;</span><span class="p">,</span> <span class="s2">&quot;Angle From&quot;</span><span class="p">,</span> <span class="s2">&quot;Angle To&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
                <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">frames</span><span class="p">()</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments</span><span class="p">[</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">scan</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">get_angle_from_array_index</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">get_angle_from_array_index</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">)]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Experiments must be all sequences or all stills&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Integrator3D">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Integrator3D</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrator for 3D algorithms</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initialize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_initialize_rotation</span><span class="p">)</span>
    <span class="n">ProcessorClass</span> <span class="o">=</span> <span class="n">Processor3D</span>
    <span class="n">finalize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_finalize_rotation</span><span class="p">)</span></div>



<div class="viewcode-block" id="IntegratorFlat3D">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorFlat3D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntegratorFlat3D</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrator for flattened 3D algorithms</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initialize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_initialize_rotation</span><span class="p">)</span>
    <span class="n">ProcessorClass</span> <span class="o">=</span> <span class="n">ProcessorFlat3D</span>
    <span class="n">finalize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_finalize_rotation</span><span class="p">)</span></div>



<div class="viewcode-block" id="Integrator2D">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator2D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Integrator2D</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrator for 2D algorithms</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initialize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_initialize_rotation</span><span class="p">)</span>
    <span class="n">ProcessorClass</span> <span class="o">=</span> <span class="n">Processor2D</span>
    <span class="n">finalize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_finalize_rotation</span><span class="p">)</span></div>



<div class="viewcode-block" id="IntegratorSingle2D">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorSingle2D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntegratorSingle2D</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrator for 2D algorithms on a single image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initialize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_initialize_rotation</span><span class="p">)</span>
    <span class="n">ProcessorClass</span> <span class="o">=</span> <span class="n">ProcessorSingle2D</span>
    <span class="n">finalize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_finalize_rotation</span><span class="p">)</span></div>



<div class="viewcode-block" id="IntegratorStills">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.IntegratorStills">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IntegratorStills</span><span class="p">(</span><span class="n">Integrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrator for still algorithms</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initialize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_initialize_stills</span><span class="p">)</span>
    <span class="n">ProcessorClass</span> <span class="o">=</span> <span class="n">ProcessorStills</span>
    <span class="n">finalize_reflections</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_finalize_stills</span><span class="p">)</span></div>



<div class="viewcode-block" id="Integrator3DThreaded">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Integrator3DThreaded</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrator for 3D algorithms</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Integrator3DThreaded.__init__">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the integrator</span>

<span class="sd">        :param experiments: The experiment list</span>
<span class="sd">        :param reflections: The reflections to process</span>
<span class="sd">        :param params: The parameters to use</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Save some stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="o">=</span> <span class="n">reflections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Integrator3DThreaded.initialise">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded.initialise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the integrator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute some reflection properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">compute_zeta_multi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">compute_d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">compute_bbox</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
            <span class="n">sigma_b_multiplier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">sigma_b_multiplier</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Filter the reflections by zeta</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">flex</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;zeta&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">min_zeta</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">dont_integrate</span><span class="p">)</span></div>


        <span class="c1"># Filter the reflections by powder ring</span>
        <span class="c1"># if self.params.integration.filter.powder_filter is not None:</span>
        <span class="c1">#   mask = self.params.integration.filter.powder_filter(self.reflections[&#39;d&#39;])</span>
        <span class="c1">#   self.reflections.set_flags(mask, self.reflections.flags.in_powder_ring)</span>

<div class="viewcode-block" id="Integrator3DThreaded.finalise">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded.finalise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalise the integrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute the corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="o">.</span><span class="n">compute_corrections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">)</span></div>


<div class="viewcode-block" id="Integrator3DThreaded.integrate">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded.integrate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Init the report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Heading</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;Processing reflections&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Create summary format</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot; Processing the following experiments:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Experiments: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Beams:       </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Detectors:   </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Goniometers: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Scans:       </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Crystals:    </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; Imagesets:   </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Print the summary</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">fmt</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">beams</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">detectors</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">goniometers</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">scans</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">crystals</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">imagesets</span><span class="p">()),</span>
        <span class="p">)</span>

        <span class="c1"># Do the initialisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>

        <span class="c1"># Do profile modelling</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">fitting</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;Modelling reflection profiles&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Compute the reference profiles</span>
            <span class="n">reference_calculator</span> <span class="o">=</span> <span class="n">ReferenceCalculatorProcessor</span><span class="p">(</span>
                <span class="n">experiments</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                <span class="n">reflections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get the reference profiles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_profiles</span> <span class="o">=</span> <span class="n">reference_calculator</span><span class="o">.</span><span class="n">profiles</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_profiles</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;Integrating reflections&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">integrator</span> <span class="o">=</span> <span class="n">IntegratorProcessor</span><span class="p">(</span>
            <span class="n">experiments</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
            <span class="n">reflections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_profiles</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Process the reflections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span> <span class="o">=</span> <span class="n">integrator</span><span class="o">.</span><span class="n">reflections</span><span class="p">()</span>

        <span class="c1"># Do the finalisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>

        <span class="c1"># Create the integration report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span> <span class="o">=</span> <span class="n">IntegrationReport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span><span class="o">.</span><span class="n">as_str</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

        <span class="c1"># Print the time info</span>
        <span class="c1"># logger.info(&quot;Timing information for integration&quot;)</span>
        <span class="c1"># logger.info(str(time_info))</span>
        <span class="c1"># logger.info(&quot;&quot;)</span>

        <span class="c1"># Return the reflections</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflections</span></div>


<div class="viewcode-block" id="Integrator3DThreaded.report">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded.report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the report of the processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Report</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_model_report</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integration_report</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Integrator3DThreaded.summary">
<a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.integration.html#dials.algorithms.integration.integrator.Integrator3DThreaded.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">block_size_units</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a summary of the integration stuff.&quot;&quot;&quot;</span>
        <span class="c1"># Compute the task table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments</span><span class="o">.</span><span class="n">all_stills</span><span class="p">():</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame From&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame To&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
                <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">frames</span><span class="p">()</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f0</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f1</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments</span><span class="o">.</span><span class="n">all_sequences</span><span class="p">():</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame From&quot;</span><span class="p">,</span> <span class="s2">&quot;Frame To&quot;</span><span class="p">,</span> <span class="s2">&quot;Angle From&quot;</span><span class="p">,</span> <span class="s2">&quot;Angle To&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
                <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">frames</span><span class="p">()</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments</span><span class="p">[</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">scan</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">get_angle_from_array_index</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">get_angle_from_array_index</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">)]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Experiments must be all sequences or all stills&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">create_integrator</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an integrator object with a given configuration.</span>

<span class="sd">    :param params: The input phil parameters</span>
<span class="sd">    :param experiments: The list of experiments</span>
<span class="sd">    :param reflections: The reflections to integrate</span>
<span class="sd">    :return: An integrator object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check each experiment has an imageset</span>
    <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">imageset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      One or more experiment does not contain an imageset. Access to the</span>
<span class="sd">      image data is crucial for integration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Read the mask in if necessary</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">mask</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;bytes&quot;</span><span class="p">)</span>

    <span class="c1"># Set algorithms as reflection table defaults</span>
    <span class="n">BackgroundAlgorithm</span> <span class="o">=</span> <span class="n">dials</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">Background</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">algorithm</span>
    <span class="p">)</span>
    <span class="n">flex</span><span class="o">.</span><span class="n">reflection_table</span><span class="o">.</span><span class="n">background_algorithm</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">BackgroundAlgorithm</span><span class="p">,</span> <span class="n">params</span>
    <span class="p">)</span>
    <span class="n">CentroidAlgorithm</span> <span class="o">=</span> <span class="n">dials</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">Centroid</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">algorithm</span>
    <span class="p">)</span>
    <span class="n">flex</span><span class="o">.</span><span class="n">reflection_table</span><span class="o">.</span><span class="n">centroid_algorithm</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">CentroidAlgorithm</span><span class="p">,</span> <span class="n">params</span>
    <span class="p">)</span>

    <span class="c1"># Get the classes we need</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">experiments</span><span class="o">.</span><span class="n">all_stills</span><span class="p">():</span>
            <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="s2">&quot;stills&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="s2">&quot;3d&quot;</span>
    <span class="n">IntegratorClass</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;3d&quot;</span><span class="p">:</span> <span class="n">Integrator3D</span><span class="p">,</span>
        <span class="s2">&quot;flat3d&quot;</span><span class="p">:</span> <span class="n">IntegratorFlat3D</span><span class="p">,</span>
        <span class="s2">&quot;2d&quot;</span><span class="p">:</span> <span class="n">Integrator2D</span><span class="p">,</span>
        <span class="s2">&quot;single2d&quot;</span><span class="p">:</span> <span class="n">IntegratorSingle2D</span><span class="p">,</span>
        <span class="s2">&quot;stills&quot;</span><span class="p">:</span> <span class="n">IntegratorStills</span><span class="p">,</span>
        <span class="s2">&quot;3d_threaded&quot;</span><span class="p">:</span> <span class="n">Integrator3DThreaded</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IntegratorClass</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown integration type </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">integrator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Remove scan if stills</span>
    <span class="k">if</span> <span class="n">experiments</span><span class="o">.</span><span class="n">all_stills</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
            <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Return an instantiation of the class</span>
    <span class="k">return</span> <span class="n">IntegratorClass</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">reflections</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../national_resource.html">US National Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &#169;2025, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>