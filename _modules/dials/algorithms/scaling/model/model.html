

<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dials.algorithms.scaling.model.model &#8212; DIALS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" href="../../../../../_static/dials-styles.css" type="text/css" />
    <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../../about.html" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="logoheader container">
  <a href="../../../../../index.html">
  <img class="logoheader" alt="DIALS" src="../../../../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dials.algorithms.scaling.model.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Definitions of scaling models.</span>

<span class="sd">A scaling model is a collection of scaling model components with appropriate</span>
<span class="sd">methods to define how these are composed into one model.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.metadata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">libtbx</span><span class="w"> </span><span class="kn">import</span> <span class="n">Auto</span><span class="p">,</span> <span class="n">phil</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.error_model.error_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasicErrorModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.model.components.analytical_component</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AnalyticalComponent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.model.components.scale_components</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LinearDoseDecay</span><span class="p">,</span>
    <span class="n">QuadraticDoseDecay</span><span class="p">,</span>
    <span class="n">SHScaleComponent</span><span class="p">,</span>
    <span class="n">SingleBScaleFactor</span><span class="p">,</span>
    <span class="n">SingleScaleFactor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.model.components.smooth_scale_components</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">SmoothBScaleComponent1D</span><span class="p">,</span>
    <span class="n">SmoothScaleComponent1D</span><span class="p">,</span>
    <span class="n">SmoothScaleComponent2D</span><span class="p">,</span>
    <span class="n">SmoothScaleComponent3D</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.plots</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">plot_absorption_parameters</span><span class="p">,</span>
    <span class="n">plot_absorption_plots</span><span class="p">,</span>
    <span class="n">plot_array_absorption_plot</span><span class="p">,</span>
    <span class="n">plot_array_decay_plot</span><span class="p">,</span>
    <span class="n">plot_array_modulation_plot</span><span class="p">,</span>
    <span class="n">plot_dose_decay</span><span class="p">,</span>
    <span class="n">plot_relative_Bs</span><span class="p">,</span>
    <span class="n">plot_smooth_scales</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.algorithms.scaling.scaling_utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">sph_harm_table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials.array_family</span><span class="w"> </span><span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dials_scaling_ext</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">calc_lookup_index</span><span class="p">,</span>
    <span class="n">calc_theta_phi</span><span class="p">,</span>
    <span class="n">create_sph_harm_lookup_table</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;dials&quot;</span><span class="p">)</span>

<span class="n">base_model_phil_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">correction.fix = None</span>
<span class="s2">    .type = strings</span>
<span class="s2">    .help = &quot;If specified, this correction will not be refined in this scaling run&quot;</span>
<span class="s2">analytical_correction = False</span>
<span class="s2">    .type = bool</span>
<span class="s2">    .help = &quot;If True, the &quot;analytical_correction&quot; column from the reflection table will&quot;</span>
<span class="s2">            &quot;be used as a fixed correction during scaling (in addition to any corrections&quot;</span>
<span class="s2">            &quot;specified as fixed with the option correction.fix=)&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">kb_model_phil_str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">decay_correction = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off decay correction (for physical/array/KB</span>
<span class="sd">            default models).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="o">+</span> <span class="n">base_model_phil_str</span>
<span class="p">)</span>

<span class="n">dose_decay_model_phil_str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">scale_interval = 2.0</span>
<span class="sd">    .type = float(value_min=1.0)</span>
<span class="sd">    .help = &quot;Rotation (phi) interval between model parameters for the scale&quot;</span>
<span class="sd">            &quot;component.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">relative_B_correction = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off relative B correction.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">decay_correction = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off decay correction.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">share.decay = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Share the decay model between sweeps.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">resolution_dependence = *quadratic linear</span>
<span class="sd">    .type = choice</span>
<span class="sd">    .help = &quot;Use a dose model that depends linearly or quadratically on 1/d&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">absorption_correction = False</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn on spherical harmonic absorption correction.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">lmax = 4</span>
<span class="sd">    .type = int(value_min=2)</span>
<span class="sd">    .help = &quot;Number of spherical harmonics to include for absorption&quot;</span>
<span class="sd">            &quot;correction, recommended to be no more than 6.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">surface_weight = 1e6</span>
<span class="sd">    .type = float(value_min=0.0)</span>
<span class="sd">    .help = &quot;Restraint weight applied to spherical harmonic terms in the&quot;</span>
<span class="sd">            &quot;absorption correction.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">fix_initial = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;If performing full matrix minimisation, in the final cycle,&quot;</span>
<span class="sd">            &quot;constrain the initial parameter for more reliable parameter and&quot;</span>
<span class="sd">            &quot;scale factor error estimates.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="o">+</span> <span class="n">base_model_phil_str</span>
<span class="p">)</span>


<span class="n">physical_model_phil_str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">scale_interval = auto</span>
<span class="sd">    .type = float(value_min=1.0)</span>
<span class="sd">    .help = &quot;Rotation (phi) interval between model parameters for the scale&quot;</span>
<span class="sd">            &quot;component (auto scales interval depending on oscillation range).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">decay_correction = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off decay correction.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">decay_interval = auto</span>
<span class="sd">    .type = float(value_min=1.0)</span>
<span class="sd">    .help = &quot;Rotation (phi) interval between model parameters for the decay&quot;</span>
<span class="sd">            &quot;component (auto scales interval depending on oscillation range).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">decay_restraint = 1e-1</span>
<span class="sd">    .type = float(value_min=0.0)</span>
<span class="sd">    .help = &quot;Weight to weakly restrain B-values to 0.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">absorption_correction = auto</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off absorption correction (default True if oscillation &gt; 60.0).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">absorption_level = low medium high</span>
<span class="sd">    .type = choice</span>
<span class="sd">    .help = &quot;Expected degree of relative absorption for different scattering&quot;</span>
<span class="sd">            &quot;paths through the crystal(s). If an option is selected, the&quot;</span>
<span class="sd">            &quot;scaling model parameters lmax and surface_weight will be set to&quot;</span>
<span class="sd">            &quot;appropriate values.&quot;</span>
<span class="sd">            &quot;Relative absorption increases as crystal size increases,&quot;</span>
<span class="sd">            &quot;increases as wavelength increases and is increased as the crystal&quot;</span>
<span class="sd">            &quot;dimensions become less equal (i.e. is higher for needle shaped&quot;</span>
<span class="sd">            &quot;crystals and zero for a spherical crystal).&quot;</span>
<span class="sd">            &quot;Definitions of the levels and approximate correction magnitude:&quot;</span>
<span class="sd">            &quot;low:    ~1%% relative absorption, expected for typical protein&quot;</span>
<span class="sd">            &quot;        crystals (containing no strongly absorbing atoms) on the&quot;</span>
<span class="sd">            &quot;        order of ~100um measured at ~1A wavelength.&quot;</span>
<span class="sd">            &quot;medium: ~5%% relative absorption&quot;</span>
<span class="sd">            &quot;high:   &gt;25%% relative absorption, e.g. for measurements at long&quot;</span>
<span class="sd">            &quot;        wavelength or crystals with high absorption from heavy atoms.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">lmax = auto</span>
<span class="sd">    .type = int(value_min=2)</span>
<span class="sd">    .help = &quot;Number of spherical harmonics to include for absorption&quot;</span>
<span class="sd">            &quot;correction, defaults to 4 if no absorption_level is chosen.&quot;</span>
<span class="sd">            &quot;It is recommended that the value need be no more than 6.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">surface_weight = auto</span>
<span class="sd">    .type = float(value_min=0.0)</span>
<span class="sd">    .help = &quot;Restraint weight applied to spherical harmonic terms in the&quot;</span>
<span class="sd">            &quot;absorption correction. A lower restraint allows a higher amount&quot;</span>
<span class="sd">            &quot;of absorption correction. Defaults to 5e5 if no absorption_level&quot;</span>
<span class="sd">            &quot;is chosen.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">share.absorption = False</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;If True, a common absorption correction is refined across all sweeps&quot;.</span>
<span class="sd">fix_initial = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;If performing full matrix minimisation, in the final cycle,&quot;</span>
<span class="sd">            &quot;constrain the initial parameter for more reliable parameter and&quot;</span>
<span class="sd">            &quot;scale factor error estimates.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="o">+</span> <span class="n">base_model_phil_str</span>
<span class="p">)</span>

<span class="n">array_model_phil_str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">decay_correction = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off decay correction (a 2D grid of parameters as&quot;</span>
<span class="sd">            &quot;a function of rotation and resolution (d-value)).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">decay_interval = 20.0</span>
<span class="sd">    .type = float(value_min=1.0)</span>
<span class="sd">    .help = &quot;Rotation (phi) interval between model parameters for the decay&quot;</span>
<span class="sd">            &quot;and absorption corrections.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">n_resolution_bins = 10</span>
<span class="sd">    .type = int(value_min=1)</span>
<span class="sd">    .help = &quot;Number of resolution bins to use for the decay term.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">absorption_correction = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn off absorption correction (a 3D grid of&quot;</span>
<span class="sd">            &quot;parameters as a function of rotation angle, detector-x and&quot;</span>
<span class="sd">            &quot;detector-y position).&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">n_absorption_bins = 3</span>
<span class="sd">    .type = int(value_min=1)</span>
<span class="sd">    .help = &quot;Number of bins in each dimension (applied to both x and y) for&quot;</span>
<span class="sd">            &quot;binning the detector position for the absorption term of the&quot;</span>
<span class="sd">            &quot;array model.&quot;</span>
<span class="sd">    .expert_level = 1</span>
<span class="sd">modulation_correction = False</span>
<span class="sd">    .type = bool</span>
<span class="sd">    .help = &quot;Option to turn on a detector correction for the array default&quot;</span>
<span class="sd">            &quot;model.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">n_modulation_bins = 20</span>
<span class="sd">    .type = int(value_min=1)</span>
<span class="sd">    .help = &quot;Number of bins in each dimension (applied to both x and y) for&quot;</span>
<span class="sd">            &quot;binning the detector position for the modulation correction.&quot;</span>
<span class="sd">    .expert_level = 2</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="o">+</span> <span class="n">base_model_phil_str</span>
<span class="p">)</span>

<span class="n">autos</span> <span class="o">=</span> <span class="p">[</span><span class="n">Auto</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;Auto&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="ScalingModelBase">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScalingModelBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for scaling models.&quot;&quot;&quot;</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ScalingModelBase.__init__">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the model with no components and a :obj:`configdict`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No model components created.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span> <span class="o">=</span> <span class="n">configdict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_scaled</span> <span class="o">=</span> <span class="n">is_scaled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_components</span> <span class="o">=</span> <span class="p">[]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_scaled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`bool`: Indicate whether this model has previously been refined.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_scaled</span>

<div class="viewcode-block" id="ScalingModelBase.fix_initial_parameter">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.fix_initial_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fix_initial_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fix a parameter of the scaling model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fixed_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_components</span>

    <span class="nd">@fixed_components</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fixed_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_components</span> <span class="o">=</span> <span class="n">components</span>

<div class="viewcode-block" id="ScalingModelBase.limit_image_range">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.limit_image_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">limit_image_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_image_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the model if necessary due to reducing the image range.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_image_range (tuple): The (start, end) of the new image range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ScalingModelBase.set_scaling_model_as_scaled">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.set_scaling_model_as_scaled">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_scaling_model_as_scaled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the boolean &#39;is_scaled&#39; flag as True.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_scaled</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ScalingModelBase.set_scaling_model_as_unscaled">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.set_scaling_model_as_unscaled">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_scaling_model_as_unscaled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the boolean &#39;is_scaled&#39; flag as False.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_scaled</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ScalingModelBase.configure_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.configure_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the required reflection table data to the model components.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ScalingModelBase.plot_model_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.plot_model_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_model_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of plots for plotting model components with plotly.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="ScalingModelBase.from_data">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.from_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the model from input data.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ScalingModelBase.set_valid_image_range">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.set_valid_image_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_valid_image_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the valid image range for the model in the :obj:`configdict`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_range</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">error_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`error_model`: The error model associated with the scaling model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_model</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">configdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`dict`: a dictionary of the model configuration parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`dict`: a dictionary of the model components.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`dict`: a dictionary of the model components.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="ScalingModelBase.consecutive_refinement_order">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.consecutive_refinement_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">consecutive_refinement_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`list`: a nested list of component names.</span>

<span class="sd">        This list indicates to the scaler the order to perform scaling in</span>
<span class="sd">        consecutive scaling mode.</span>
<span class="sd">        e.g. [[&#39;scale&#39;, &#39;decay&#39;], [&#39;absorption&#39;]] would cause the first cycle to</span>
<span class="sd">        refine scale and decay, and then absorption in a subsequent cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ScalingModelBase.to_dict">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize the model to a dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary representation of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__id__&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;n_parameters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">n_params</span><span class="p">,</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">),</span>
                <span class="s2">&quot;null_parameter_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">null_parameter_value</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">parameter_esds</span><span class="p">:</span>
                <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">parameter_esds</span>
                <span class="p">)</span>
        <span class="n">dictionary</span><span class="p">[</span><span class="s2">&quot;configuration_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span>
        <span class="k">return</span> <span class="n">dictionary</span></div>


<div class="viewcode-block" id="ScalingModelBase.from_dict">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a scaling model from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ScalingModelBase.update">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_params</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ScalingModelBase.load_error_model">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.load_error_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_error_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_params</span><span class="p">):</span>
        <span class="c1"># load existing model if there, but use user-specified values if given</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;error_model_type&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">error_params</span><span class="o">.</span><span class="n">reset_error_model</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;error_model_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;BasicErrorModel&quot;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;error_model_parameters&quot;</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error_params</span><span class="o">.</span><span class="n">basic</span><span class="o">.</span><span class="n">a</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error_params</span><span class="o">.</span><span class="n">basic</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_model</span> <span class="o">=</span> <span class="n">BasicErrorModel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">error_params</span><span class="o">.</span><span class="n">basic</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_model</span><span class="p">:</span>
            <span class="n">new_model</span> <span class="o">=</span> <span class="n">BasicErrorModel</span><span class="p">(</span><span class="n">basic_params</span><span class="o">=</span><span class="n">error_params</span><span class="o">.</span><span class="n">basic</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded error model: </span><span class="si">{</span><span class="n">new_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_error_model</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScalingModelBase.set_error_model">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.set_error_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_error_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate an error model with the dataset.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_model</span> <span class="o">=</span> <span class="n">error_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;error_model_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;error_model_parameters&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">error_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ScalingModelBase.record_intensity_combination_Imid">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.record_intensity_combination_Imid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">record_intensity_combination_Imid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Imid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record the intensity combination Imid value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;Imid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Imid</span></div>


<div class="viewcode-block" id="ScalingModelBase.get_shared_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ScalingModelBase.get_shared_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shared_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`str`: Return a string representation of a scaling model.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Scaling model:&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  type : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; component:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">parameter_esds</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    parameters (sigma)&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">parameter_esds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">   (</span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">   (</span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    parameters&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">component</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_add_absorption_component_to_physically_derived_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
    <span class="n">lmax</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;lmax&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reflection_table</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s2">&quot;s0c&quot;</span> <span class="ow">in</span> <span class="n">reflection_table</span>
        <span class="k">assert</span> <span class="s2">&quot;s1c&quot;</span> <span class="ow">in</span> <span class="n">reflection_table</span>
        <span class="n">theta_phi_0</span> <span class="o">=</span> <span class="n">calc_theta_phi</span><span class="p">(</span>
            <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;s0c&quot;</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># array of tuples in radians</span>
        <span class="n">theta_phi_1</span> <span class="o">=</span> <span class="n">calc_theta_phi</span><span class="p">(</span><span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;s1c&quot;</span><span class="p">])</span>
        <span class="n">s0_lookup_index</span> <span class="o">=</span> <span class="n">calc_lookup_index</span><span class="p">(</span><span class="n">theta_phi_0</span><span class="p">,</span> <span class="n">points_per_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">s1_lookup_index</span> <span class="o">=</span> <span class="n">calc_lookup_index</span><span class="p">(</span><span class="n">theta_phi_1</span><span class="p">,</span> <span class="n">points_per_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SHScaleComponent</span><span class="o">.</span><span class="n">coefficients_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">SHScaleComponent</span><span class="o">.</span><span class="n">coefficients_list</span> <span class="o">=</span> <span class="n">create_sph_harm_lookup_table</span><span class="p">(</span>
                <span class="n">lmax</span><span class="p">,</span> <span class="n">points_per_degree</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>  <span class="c1"># set the class variable and share</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">SHScaleComponent</span><span class="o">.</span><span class="n">coefficients_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">lmax</span><span class="p">)):</span>
            <span class="c1"># this (rare) case can happen if adding a new dataset with a larger lmax!</span>
            <span class="n">SHScaleComponent</span><span class="o">.</span><span class="n">coefficients_list</span> <span class="o">=</span> <span class="n">create_sph_harm_lookup_table</span><span class="p">(</span>
                <span class="n">lmax</span><span class="p">,</span> <span class="n">points_per_degree</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>  <span class="c1"># set the class variable and share</span>
        <span class="n">model</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;s0_lookup&quot;</span><span class="p">:</span> <span class="n">s0_lookup_index</span><span class="p">,</span>
            <span class="s2">&quot;s1_lookup&quot;</span><span class="p">:</span> <span class="n">s1_lookup_index</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="c1"># here just pass in good reflections</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sph_harm_table&quot;</span><span class="p">:</span> <span class="n">sph_harm_table</span><span class="p">(</span><span class="n">reflection_table</span><span class="p">,</span> <span class="n">lmax</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="n">surface_weight</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;abs_surface_weight&quot;</span><span class="p">]</span>
    <span class="n">parameter_restraints</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">parameter_restraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">parameter_restraints</span> <span class="o">*=</span> <span class="n">surface_weight</span>
    <span class="n">model</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameter_restraints</span> <span class="o">=</span> <span class="n">parameter_restraints</span>


<div class="viewcode-block" id="DoseDecay">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DoseDecay</span><span class="p">(</span><span class="n">ScalingModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A model similar to the physical model, where an exponential decay</span>
<span class="sd">    component is used plus a relative B-factor per sweep, with no absorption</span>
<span class="sd">    surface by default. Most suitable for multi-crystal datasets.&quot;&quot;&quot;</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="s2">&quot;dose_decay&quot;</span>

    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">dose_decay_model_phil_str</span><span class="p">)</span>

<div class="viewcode-block" id="DoseDecay.__init__">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the physical scaling model components.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">scale_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SmoothScaleComponent1D</span><span class="p">(</span>
                <span class="n">scale_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">scale_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">decay_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;resolution_dependence&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearDoseDecay</span><span class="p">(</span>
                    <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QuadraticDoseDecay</span><span class="p">(</span>
                    <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;relative_B&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">B_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SingleBScaleFactor</span><span class="p">(</span>
                <span class="n">B_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">B_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">absorption_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHScaleComponent</span><span class="p">(</span>
                <span class="n">absorption_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">absorption_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalyticalComponent</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([]))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">consecutive_refinement_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`list`: a nested list of component names to indicate scaling order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[[</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;relative_B&quot;</span><span class="p">,</span> <span class="s2">&quot;decay&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]]</span>

<div class="viewcode-block" id="DoseDecay.fix_initial_parameter">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.fix_initial_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fix_initial_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">dose_decay</span><span class="o">.</span><span class="n">fix_initial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix_initial_parameter</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="DoseDecay.get_shared_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.get_shared_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shared_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;shared&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;shared&quot;</span><span class="p">]</span>
                <span class="ow">and</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_components</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;decay&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DoseDecay.update">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dose_decay</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dose_decay</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span></div>


<div class="viewcode-block" id="DoseDecay.configure_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.configure_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the required reflection table data to the model components.&quot;&quot;&quot;</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;xyzobs.px.value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;s_norm_fac&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">phi</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="s2">&quot;relative_B&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">_add_absorption_component_to_physically_derived_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;correction&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;analytical_correction&quot;</span><span class="p">]</span>
            <span class="p">}</span></div>


<div class="viewcode-block" id="DoseDecay.limit_image_range">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.limit_image_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">limit_image_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_image_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the model to be suitable for a reduced image range.</span>

<span class="sd">        For this model, this involves determining whether the number of parameters</span>
<span class="sd">        should be reduced and may reduce the number of parameters in the scale and</span>
<span class="sd">        decay components.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_image_range (tuple): The (start, end) of the new image range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span>
        <span class="n">current_image_range</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">]</span>
        <span class="n">current_osc_range</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">]</span>
        <span class="c1"># calculate one osc as don&#39;t have access to scan object here</span>
        <span class="n">one_osc</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">new_osc_range</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span><span class="p">,</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">one_osc</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">n_param</span><span class="p">,</span> <span class="n">s_norm_fac</span><span class="p">,</span> <span class="n">scale_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
                <span class="n">new_osc_range</span><span class="p">,</span> <span class="n">one_osc</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;scale_rot_interval&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">n_old_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;scale_rot_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_rot_int</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;s_norm_fac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_norm_fac</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_new_offset</span><span class="p">(</span>
                <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">s_norm_fac</span><span class="p">,</span>
                <span class="n">n_old_params</span><span class="p">,</span>
                <span class="n">n_param</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n_param</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_new_parameters</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>

        <span class="n">new_osc_range_0</span> <span class="o">=</span> <span class="n">current_osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span>
        <span class="p">)</span>
        <span class="n">new_osc_range_1</span> <span class="o">=</span> <span class="n">current_osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_osc_range_0</span><span class="p">,</span> <span class="n">new_osc_range_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_valid_image_range</span><span class="p">(</span><span class="n">new_image_range</span><span class="p">)</span></div>


<div class="viewcode-block" id="DoseDecay.from_data">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.from_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the scaling model defined by the params.&quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dose_decay</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">osc_range</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_oscillation_range</span><span class="p">()</span>
        <span class="n">one_osc_width</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_oscillation</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">:</span> <span class="n">osc_range</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">share</span><span class="o">.</span><span class="n">decay</span><span class="p">:</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;shared&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]})</span>

        <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>
        <span class="n">n_scale_param</span><span class="p">,</span> <span class="n">s_norm_fac</span><span class="p">,</span> <span class="n">scale_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
            <span class="n">osc_range</span><span class="p">,</span> <span class="n">one_osc_width</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">scale_interval</span>
        <span class="p">)</span>
        <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;s_norm_fac&quot;</span><span class="p">:</span> <span class="n">s_norm_fac</span><span class="p">,</span> <span class="s2">&quot;scale_rot_interval&quot;</span><span class="p">:</span> <span class="n">scale_rot_int</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_scale_param</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">relative_B_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;relative_B&quot;</span><span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;decay&quot;</span><span class="p">)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;resolution_dependence&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">resolution_dependence</span><span class="p">})</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">absorption_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;absorption&quot;</span><span class="p">)</span>
            <span class="n">n_abs_param</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lmax</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">lmax</span>
            <span class="p">)</span>  <span class="c1"># arithmetic sum formula (a1=3, d=2)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;lmax&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">lmax</span><span class="p">})</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;abs_surface_weight&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">surface_weight</span><span class="p">})</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_abs_param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">analytical_correction</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;analytical&quot;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span>
        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="DoseDecay.from_dict">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a :obj:`DoseDecayScalingModel` from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;__id__&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expected __id__ </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__id__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">s_params</span><span class="p">,</span> <span class="n">d_params</span><span class="p">,</span> <span class="n">abs_params</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">s_params_sds</span><span class="p">,</span> <span class="n">d_params_sds</span><span class="p">,</span> <span class="n">a_params_sds</span><span class="p">,</span> <span class="n">B_sd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;configuration_parameters&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">s_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]:</span>
                <span class="n">s_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;relative_B&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">]:</span>
                <span class="n">B_sd</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">d_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]:</span>
                <span class="n">d_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">abs_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]:</span>
                <span class="n">a_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>

        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">s_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">s_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;decay&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">d_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">d_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;relative_B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">B_sd</span><span class="p">},</span>
            <span class="s2">&quot;absorption&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">abs_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">a_params_sds</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DoseDecay.plot_model_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.DoseDecay.plot_model_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_model_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">plot_dose_decay</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_absorption_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_absorption_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">d</span></div>
</div>



<div class="viewcode-block" id="determine_auto_absorption_params">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.determine_auto_absorption_params">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">determine_auto_absorption_params</span><span class="p">(</span><span class="n">absorption</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">absorption</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span>
        <span class="n">lmax</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">surface_weight</span> <span class="o">=</span> <span class="mf">5e3</span>
    <span class="k">elif</span> <span class="n">absorption</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
        <span class="n">lmax</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">surface_weight</span> <span class="o">=</span> <span class="mf">5e4</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># low</span>
        <span class="n">lmax</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">surface_weight</span> <span class="o">=</span> <span class="mf">5e5</span>
    <span class="k">return</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">surface_weight</span></div>



<div class="viewcode-block" id="PhysicalScalingModel">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PhysicalScalingModel</span><span class="p">(</span><span class="n">ScalingModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A scaling model for a physical parameterisation.&quot;&quot;&quot;</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="s2">&quot;physical&quot;</span>

    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">physical_model_phil_str</span><span class="p">)</span>

<div class="viewcode-block" id="PhysicalScalingModel.__init__">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the physical scaling model components.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">scale_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SmoothScaleComponent1D</span><span class="p">(</span>
                <span class="n">scale_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">scale_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">decay_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SmoothBScaleComponent1D</span><span class="p">(</span>
                <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">absorption_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHScaleComponent</span><span class="p">(</span>
                <span class="n">absorption_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">absorption_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalyticalComponent</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([]))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">consecutive_refinement_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`list`: a nested list of component names to indicate scaling order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[[</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;decay&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]]</span>

<div class="viewcode-block" id="PhysicalScalingModel.fix_initial_parameter">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.fix_initial_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fix_initial_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">fix_initial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix_initial_parameter</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.configure_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.configure_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the required reflection table data to the model components.&quot;&quot;&quot;</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;xyzobs.px.value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;s_norm_fac&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;d_norm_fac&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameter_restraints</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
                <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">decay_restraint</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">_add_absorption_component_to_physically_derived_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;correction&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;analytical_correction&quot;</span><span class="p">]</span>
            <span class="p">}</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.limit_image_range">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.limit_image_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">limit_image_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_image_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the model to be suitable for a reduced image range.</span>

<span class="sd">        For this model, this involves determining whether the number of parameters</span>
<span class="sd">        should be reduced and may reduce the number of parameters in the scale and</span>
<span class="sd">        decay components.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_image_range (tuple): The (start, end) of the new image range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span>
        <span class="n">current_image_range</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">]</span>
        <span class="n">current_osc_range</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">]</span>
        <span class="c1"># calculate one osc as don&#39;t have access to scan object here</span>
        <span class="n">one_osc</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">new_osc_range</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span><span class="p">,</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">one_osc</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">n_param</span><span class="p">,</span> <span class="n">s_norm_fac</span><span class="p">,</span> <span class="n">scale_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
                <span class="n">new_osc_range</span><span class="p">,</span> <span class="n">one_osc</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;scale_rot_interval&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">n_old_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;scale_rot_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_rot_int</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;s_norm_fac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_norm_fac</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_new_offset</span><span class="p">(</span>
                <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">s_norm_fac</span><span class="p">,</span>
                <span class="n">n_old_params</span><span class="p">,</span>
                <span class="n">n_param</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n_param</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_new_parameters</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">n_param</span><span class="p">,</span> <span class="n">d_norm_fac</span><span class="p">,</span> <span class="n">decay_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
                <span class="n">new_osc_range</span><span class="p">,</span> <span class="n">one_osc</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;decay_rot_interval&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">n_old_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;decay_rot_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decay_rot_int</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;d_norm_fac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_norm_fac</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_new_offset</span><span class="p">(</span>
                <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">d_norm_fac</span><span class="p">,</span>
                <span class="n">n_old_params</span><span class="p">,</span>
                <span class="n">n_param</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n_param</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_new_parameters</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>

        <span class="n">new_osc_range_0</span> <span class="o">=</span> <span class="n">current_osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span>
        <span class="p">)</span>
        <span class="n">new_osc_range_1</span> <span class="o">=</span> <span class="n">current_osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_osc_range_0</span><span class="p">,</span> <span class="n">new_osc_range_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_valid_image_range</span><span class="p">(</span><span class="n">new_image_range</span><span class="p">)</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.from_data">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.from_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the scaling model defined by the params.&quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">osc_range</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_oscillation_range</span><span class="p">()</span>
        <span class="n">one_osc_width</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_oscillation</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">:</span> <span class="n">osc_range</span><span class="p">})</span>

        <span class="n">abs_osc_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">scale_interval</span> <span class="ow">in</span> <span class="n">autos</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_interval</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">abs_osc_range</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="n">scale_interval</span><span class="p">,</span> <span class="n">decay_interval</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">abs_osc_range</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
                <span class="n">scale_interval</span><span class="p">,</span> <span class="n">decay_interval</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">abs_osc_range</span> <span class="o">&lt;</span> <span class="mf">25.0</span><span class="p">:</span>
                <span class="n">scale_interval</span><span class="p">,</span> <span class="n">decay_interval</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">abs_osc_range</span> <span class="o">&lt;</span> <span class="mf">90.0</span><span class="p">:</span>
                <span class="n">scale_interval</span><span class="p">,</span> <span class="n">decay_interval</span> <span class="o">=</span> <span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale_interval</span><span class="p">,</span> <span class="n">decay_interval</span> <span class="o">=</span> <span class="p">(</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">scale_interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
            <span class="n">scale_interval</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">scale_interval</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
            <span class="n">decay_interval</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_interval</span>

        <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>
        <span class="n">n_scale_param</span><span class="p">,</span> <span class="n">s_norm_fac</span><span class="p">,</span> <span class="n">scale_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
            <span class="n">osc_range</span><span class="p">,</span> <span class="n">one_osc_width</span><span class="p">,</span> <span class="n">scale_interval</span>
        <span class="p">)</span>
        <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;s_norm_fac&quot;</span><span class="p">:</span> <span class="n">s_norm_fac</span><span class="p">,</span> <span class="s2">&quot;scale_rot_interval&quot;</span><span class="p">:</span> <span class="n">scale_rot_int</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_scale_param</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;decay&quot;</span><span class="p">)</span>
            <span class="n">n_decay_param</span><span class="p">,</span> <span class="n">d_norm_fac</span><span class="p">,</span> <span class="n">decay_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
                <span class="n">osc_range</span><span class="p">,</span> <span class="n">one_osc_width</span><span class="p">,</span> <span class="n">decay_interval</span>
            <span class="p">)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;d_norm_fac&quot;</span><span class="p">:</span> <span class="n">d_norm_fac</span><span class="p">,</span> <span class="s2">&quot;decay_rot_interval&quot;</span><span class="p">:</span> <span class="n">decay_rot_int</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_decay_param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">absorption_correction</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">abs_osc_range</span> <span class="o">&gt;</span> <span class="mf">60.0</span><span class="p">:</span>
                <span class="n">absorption_correction</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">absorption_correction</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;s1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_s0</span><span class="p">()))</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span>
                <span class="mf">0.999</span>
            <span class="p">):</span>
                <span class="c1"># https://github.com/dials/dials/issues/2316</span>
                <span class="n">absorption_correction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">absorption_correction</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">absorption_correction</span>
        <span class="k">if</span> <span class="n">absorption_correction</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">absorption_level</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;absorption&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">share</span><span class="o">.</span><span class="n">absorption</span><span class="p">:</span>
                <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;shared&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]})</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">absorption_level</span><span class="p">:</span>
                <span class="n">lmax</span><span class="p">,</span> <span class="n">surface_weight</span> <span class="o">=</span> <span class="n">determine_auto_absorption_params</span><span class="p">(</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">absorption_level</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lmax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">surface_weight</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Using lmax, surface_weight parameters set by the absorption_level option,</span>
<span class="sd">                        rather than user specified options&quot;&quot;&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lmax</span><span class="p">,</span> <span class="n">surface_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lmax</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">surface_weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lmax</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
                    <span class="n">lmax</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">surface_weight</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
                    <span class="n">surface_weight</span> <span class="o">=</span> <span class="mf">5e5</span>
            <span class="n">n_abs_param</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lmax</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lmax</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># arithmetic sum formula (a1=3, d=2)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;lmax&quot;</span><span class="p">:</span> <span class="n">lmax</span><span class="p">})</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;abs_surface_weight&quot;</span><span class="p">:</span> <span class="n">surface_weight</span><span class="p">})</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_abs_param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">analytical_correction</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;analytical&quot;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span>
        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.from_dict">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a :obj:`PhysicalScalingModel` from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;__id__&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expected __id__ </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__id__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">s_params</span><span class="p">,</span> <span class="n">d_params</span><span class="p">,</span> <span class="n">abs_params</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">s_params_sds</span><span class="p">,</span> <span class="n">d_params_sds</span><span class="p">,</span> <span class="n">a_params_sds</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;configuration_parameters&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">s_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]:</span>
                <span class="n">s_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">d_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]:</span>
                <span class="n">d_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">abs_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]:</span>
                <span class="n">a_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>

        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">s_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">s_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;decay&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">d_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">d_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;absorption&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">abs_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">a_params_sds</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.update">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the model if new options chosen in the phil scope.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">new_lmax</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">absorption_level</span><span class="p">:</span>
                <span class="n">lmax</span><span class="p">,</span> <span class="n">surface_weight</span> <span class="o">=</span> <span class="n">determine_auto_absorption_params</span><span class="p">(</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">absorption_level</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;abs_surface_weight&quot;</span><span class="p">:</span> <span class="n">surface_weight</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">lmax</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;lmax&quot;</span><span class="p">]:</span>
                    <span class="n">new_lmax</span> <span class="o">=</span> <span class="n">lmax</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># check manually specified parameters.</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">surface_weight</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;abs_surface_weight&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">surface_weight</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">lmax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autos</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">lmax</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;lmax&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">new_lmax</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">lmax</span>
            <span class="k">if</span> <span class="n">new_lmax</span><span class="p">:</span>
                <span class="c1"># need to change the parameters for this component</span>
                <span class="n">current_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span>
                <span class="n">n_abs_param</span> <span class="o">=</span> <span class="n">new_lmax</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">new_lmax</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;lmax&quot;</span><span class="p">:</span> <span class="n">new_lmax</span><span class="p">})</span>
                <span class="n">new_parameters</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_abs_param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="c1"># copy across matching parameters:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_abs_param</span><span class="p">,</span> <span class="n">current_parameters</span><span class="o">.</span><span class="n">size</span><span class="p">())):</span>
                    <span class="n">new_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHScaleComponent</span><span class="p">(</span>
                    <span class="n">new_parameters</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">n_abs_param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">physical</span><span class="o">.</span><span class="n">share</span><span class="o">.</span><span class="n">absorption</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;shared&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]})</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.plot_model_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.plot_model_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_model_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">plot_smooth_scales</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_absorption_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_absorption_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="PhysicalScalingModel.get_shared_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.PhysicalScalingModel.get_shared_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shared_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;shared&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;shared&quot;</span><span class="p">]</span>
                <span class="ow">and</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_components</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;absorption&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="ArrayScalingModel">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArrayScalingModel</span><span class="p">(</span><span class="n">ScalingModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A scaling model for an array-based parameterisation.&quot;&quot;&quot;</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="s2">&quot;array&quot;</span>

    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">array_model_phil_str</span><span class="p">)</span>

<div class="viewcode-block" id="ArrayScalingModel.__init__">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the array scaling model components.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">,</span> <span class="s2">&quot;absorption&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Array model must have at least one of decay or absorption corrections&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">decay_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SmoothScaleComponent2D</span><span class="p">(</span>
                <span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_res_param&quot;</span><span class="p">],</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_time_param&quot;</span><span class="p">]),</span>
                <span class="n">parameter_esds</span><span class="o">=</span><span class="n">decay_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">abs_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SmoothScaleComponent3D</span><span class="p">(</span>
                <span class="n">abs_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_x_param&quot;</span><span class="p">],</span>
                    <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_y_param&quot;</span><span class="p">],</span>
                    <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_time_param&quot;</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="n">parameter_esds</span><span class="o">=</span><span class="n">abs_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;modulation&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">mod_setup</span> <span class="o">=</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SmoothScaleComponent2D</span><span class="p">(</span>
                <span class="n">mod_setup</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_x_mod_param&quot;</span><span class="p">],</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;n_y_mod_param&quot;</span><span class="p">]),</span>
                <span class="n">parameter_esds</span><span class="o">=</span><span class="n">mod_setup</span><span class="p">[</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalyticalComponent</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([]))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">consecutive_refinement_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`list`: a nested list of component names to indicate scaling order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[[</span><span class="s2">&quot;decay&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">]]</span>

<div class="viewcode-block" id="ArrayScalingModel.update">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span></div>


<div class="viewcode-block" id="ArrayScalingModel.configure_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.configure_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the required reflection table data to the model components.&quot;&quot;&quot;</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;xyzobs.px.value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">()</span>
        <span class="n">norm_time</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;time_norm_fac&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span>
            <span class="n">norm_res</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;resmin&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;res_bin_width&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">norm_res</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">norm_time</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">norm_x_abs</span> <span class="o">=</span> <span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span>
                <span class="s2">&quot;x_bin_width&quot;</span>
            <span class="p">]</span>
            <span class="n">norm_y_abs</span> <span class="o">=</span> <span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span>
                <span class="s2">&quot;y_bin_width&quot;</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">norm_x_abs</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">norm_y_abs</span><span class="p">,</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">norm_time</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;modulation&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">norm_x_det</span> <span class="o">=</span> <span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span>
                <span class="s2">&quot;x_det_bin_width&quot;</span>
            <span class="p">]</span>
            <span class="n">norm_y_det</span> <span class="o">=</span> <span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span><span class="p">[</span>
                <span class="s2">&quot;y_det_bin_width&quot;</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">norm_x_det</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">norm_y_det</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;correction&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;analytical_correction&quot;</span><span class="p">]</span>
            <span class="p">}</span></div>


<div class="viewcode-block" id="ArrayScalingModel.limit_image_range">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.limit_image_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">limit_image_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_image_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the model to be suitable for a reduced image range.</span>

<span class="sd">        For this model, this involves determining whether the number of parameters</span>
<span class="sd">        should be reduced and may reduce the number of parameters in the absorption</span>
<span class="sd">        and decay components.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_image_range (tuple): The (start, end) of the new image range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configdict</span>
        <span class="n">current_image_range</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">]</span>
        <span class="n">current_osc_range</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">]</span>
        <span class="c1"># calculate one osc as don&#39;t have access to scan object here</span>
        <span class="n">one_osc</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;valid_image_range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">new_osc_range</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span><span class="p">,</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">one_osc</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">n_param</span><span class="p">,</span> <span class="n">time_norm_fac</span><span class="p">,</span> <span class="n">time_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
            <span class="n">new_osc_range</span><span class="p">,</span> <span class="n">one_osc</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;time_rot_interval&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">n_old_time_params</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_x_params</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_old_time_params</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_x_params</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_y_params</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_new_offset</span><span class="p">(</span>
            <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">time_norm_fac</span><span class="p">,</span>
            <span class="n">n_old_time_params</span><span class="p">,</span>
            <span class="n">n_param</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span>
            <span class="n">n_x_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_x_params</span>
            <span class="n">n_y_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_y_params</span>
            <span class="c1"># can&#39;t do simple slice as 3-dim array</span>
            <span class="n">time_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="n">n_x_params</span> <span class="o">*</span> <span class="n">n_y_params</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span>
                <span class="n">time_offset</span> <span class="p">:</span> <span class="n">time_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_param</span> <span class="o">*</span> <span class="n">n_x_params</span> <span class="o">*</span> <span class="n">n_y_params</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_new_parameters</span><span class="p">(</span>
                <span class="n">new_params</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_x_params</span><span class="p">,</span> <span class="n">n_y_params</span><span class="p">,</span> <span class="n">n_param</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span>
            <span class="n">n_decay_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_x_params</span>
            <span class="c1"># can&#39;t do simple slice as 2-dim array</span>
            <span class="n">decay_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="n">n_decay_params</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span>
                <span class="n">decay_offset</span> <span class="p">:</span> <span class="n">decay_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_param</span> <span class="o">*</span> <span class="n">n_decay_params</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_new_parameters</span><span class="p">(</span>
                <span class="n">new_params</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_decay_params</span><span class="p">,</span> <span class="n">n_param</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;n_time_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;time_norm_fac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_norm_fac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;time_rot_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_rot_int</span>
        <span class="n">new_osc_range_0</span> <span class="o">=</span> <span class="n">current_osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span>
        <span class="p">)</span>
        <span class="n">new_osc_range_1</span> <span class="o">=</span> <span class="n">current_osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">new_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_image_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">one_osc</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configdict</span><span class="p">[</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_osc_range_0</span><span class="p">,</span> <span class="n">new_osc_range_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_valid_image_range</span><span class="p">(</span><span class="n">new_image_range</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArrayScalingModel.from_data">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.from_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;create an array-based scaling model.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">array</span>
        <span class="n">reflections</span> <span class="o">=</span> <span class="n">reflection_table</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="c1"># First initialise things common to more than one correction.</span>
        <span class="n">one_osc_width</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_oscillation</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">osc_range</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_oscillation_range</span><span class="p">()</span>
        <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;valid_osc_range&quot;</span><span class="p">:</span> <span class="n">osc_range</span><span class="p">})</span>
        <span class="n">n_time_param</span><span class="p">,</span> <span class="n">time_norm_fac</span><span class="p">,</span> <span class="n">time_rot_int</span> <span class="o">=</span> <span class="n">initialise_smooth_input</span><span class="p">(</span>
            <span class="n">osc_range</span><span class="p">,</span> <span class="n">one_osc_width</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_interval</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvalues</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;xyzobs.px.value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">()</span>
        <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xvalues</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xvalues</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yvalues</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yvalues</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span>

        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">decay_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;decay&quot;</span><span class="p">)</span>
            <span class="n">resmax</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-6</span>
            <span class="n">resmin</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">reflections</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1e-6</span>
            <span class="n">n_res_bins</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_resolution_bins</span>
            <span class="n">n_res_param</span><span class="p">,</span> <span class="n">res_bin_width</span> <span class="o">=</span> <span class="n">calc_n_param_from_bins</span><span class="p">(</span>
                <span class="n">resmin</span><span class="p">,</span> <span class="n">resmax</span><span class="p">,</span> <span class="n">n_res_bins</span>
            <span class="p">)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;n_res_param&quot;</span><span class="p">:</span> <span class="n">n_res_param</span><span class="p">,</span>
                    <span class="s2">&quot;n_time_param&quot;</span><span class="p">:</span> <span class="n">n_time_param</span><span class="p">,</span>
                    <span class="s2">&quot;resmin&quot;</span><span class="p">:</span> <span class="n">resmin</span><span class="p">,</span>
                    <span class="s2">&quot;res_bin_width&quot;</span><span class="p">:</span> <span class="n">res_bin_width</span><span class="p">,</span>
                    <span class="s2">&quot;time_norm_fac&quot;</span><span class="p">:</span> <span class="n">time_norm_fac</span><span class="p">,</span>
                    <span class="s2">&quot;time_rot_interval&quot;</span><span class="p">:</span> <span class="n">time_rot_int</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">((</span><span class="n">n_time_param</span> <span class="o">*</span> <span class="n">n_res_param</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">absorption_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;absorption&quot;</span><span class="p">)</span>
            <span class="n">nxbins</span> <span class="o">=</span> <span class="n">nybins</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_absorption_bins</span>
            <span class="n">n_x_param</span><span class="p">,</span> <span class="n">x_bin_width</span> <span class="o">=</span> <span class="n">calc_n_param_from_bins</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">nxbins</span><span class="p">)</span>
            <span class="n">n_y_param</span><span class="p">,</span> <span class="n">y_bin_width</span> <span class="o">=</span> <span class="n">calc_n_param_from_bins</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">nybins</span><span class="p">)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;n_x_param&quot;</span><span class="p">:</span> <span class="n">n_x_param</span><span class="p">,</span>
                    <span class="s2">&quot;n_y_param&quot;</span><span class="p">:</span> <span class="n">n_y_param</span><span class="p">,</span>
                    <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="n">xmin</span><span class="p">,</span>
                    <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="n">ymin</span><span class="p">,</span>
                    <span class="s2">&quot;x_bin_width&quot;</span><span class="p">:</span> <span class="n">x_bin_width</span><span class="p">,</span>
                    <span class="s2">&quot;y_bin_width&quot;</span><span class="p">:</span> <span class="n">y_bin_width</span><span class="p">,</span>
                    <span class="s2">&quot;n_time_param&quot;</span><span class="p">:</span> <span class="n">n_time_param</span><span class="p">,</span>
                    <span class="s2">&quot;time_norm_fac&quot;</span><span class="p">:</span> <span class="n">time_norm_fac</span><span class="p">,</span>
                    <span class="s2">&quot;time_rot_interval&quot;</span><span class="p">:</span> <span class="n">time_rot_int</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">((</span><span class="n">n_x_param</span> <span class="o">*</span> <span class="n">n_y_param</span> <span class="o">*</span> <span class="n">n_time_param</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">modulation_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;modulation&quot;</span><span class="p">)</span>
            <span class="n">nx_det_bins</span> <span class="o">=</span> <span class="n">ny_det_bins</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_modulation_bins</span>
            <span class="n">n_x_mod_param</span><span class="p">,</span> <span class="n">x_det_bw</span> <span class="o">=</span> <span class="n">calc_n_param_from_bins</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">nx_det_bins</span><span class="p">)</span>
            <span class="n">n_y_mod_param</span><span class="p">,</span> <span class="n">y_det_bw</span> <span class="o">=</span> <span class="n">calc_n_param_from_bins</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ny_det_bins</span><span class="p">)</span>
            <span class="n">configdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;n_x_mod_param&quot;</span><span class="p">:</span> <span class="n">n_x_mod_param</span><span class="p">,</span>
                    <span class="s2">&quot;n_y_mod_param&quot;</span><span class="p">:</span> <span class="n">n_y_mod_param</span><span class="p">,</span>
                    <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="n">xmin</span><span class="p">,</span>
                    <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="n">ymin</span><span class="p">,</span>
                    <span class="s2">&quot;x_det_bin_width&quot;</span><span class="p">:</span> <span class="n">x_det_bw</span><span class="p">,</span>
                    <span class="s2">&quot;y_det_bin_width&quot;</span><span class="p">:</span> <span class="n">y_det_bw</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">((</span><span class="n">n_x_mod_param</span> <span class="o">*</span> <span class="n">n_y_mod_param</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">analytical_correction</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;analytical&quot;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span>
        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="ArrayScalingModel.from_dict">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an :obj:`ArrayScalingModel` from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;__id__&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expected __id__ </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__id__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;configuration_parameters&quot;</span><span class="p">]</span>
        <span class="p">(</span><span class="n">dec_params</span><span class="p">,</span> <span class="n">abs_params</span><span class="p">,</span> <span class="n">mod_params</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">d_params_sds</span><span class="p">,</span> <span class="n">a_params_sds</span><span class="p">,</span> <span class="n">m_params_sds</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">dec_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]:</span>
                <span class="n">d_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">abs_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">]:</span>
                <span class="n">a_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;absorption&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;modulation&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">mod_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">]:</span>
                <span class="n">m_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;modulation&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>

        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;decay&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">dec_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">d_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;absorption&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">abs_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">a_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;modulation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">mod_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">m_params_sds</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArrayScalingModel.plot_model_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.ArrayScalingModel.plot_model_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_model_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;absorption&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_array_absorption_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_array_decay_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;modulation&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_array_modulation_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">d</span></div>
</div>



<div class="viewcode-block" id="KBScalingModel">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.KBScalingModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KBScalingModel</span><span class="p">(</span><span class="n">ScalingModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A scaling model for a KB parameterisation.&quot;&quot;&quot;</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="s2">&quot;KB&quot;</span>

    <span class="n">phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">kb_model_phil_str</span><span class="p">)</span>

<div class="viewcode-block" id="KBScalingModel.__init__">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.KBScalingModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the KB scaling model components.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SingleScaleFactor</span><span class="p">(</span>
                <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
                <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SingleBScaleFactor</span><span class="p">(</span>
                <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
                <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;parameter_esds&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalyticalComponent</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([]))</span></div>


<div class="viewcode-block" id="KBScalingModel.configure_components">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.KBScalingModel.configure_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the required reflection table data to the model components.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;analytical&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="s2">&quot;analytical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;correction&quot;</span><span class="p">:</span> <span class="n">reflection_table</span><span class="p">[</span><span class="s2">&quot;analytical_correction&quot;</span><span class="p">]</span>
            <span class="p">}</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">consecutive_refinement_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:obj:`list`: a nested list of component names to indicate scaling order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[[</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;decay&quot;</span><span class="p">]]</span>

<div class="viewcode-block" id="KBScalingModel.update">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.KBScalingModel.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">KB</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">KB</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span></div>


<div class="viewcode-block" id="KBScalingModel.from_dict">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.KBScalingModel.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an :obj:`KBScalingModel` from a dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;__id__&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expected __id__ </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;__id__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;configuration_parameters&quot;</span><span class="p">]</span>
        <span class="p">(</span><span class="n">s_params</span><span class="p">,</span> <span class="n">d_params</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">s_params_sds</span><span class="p">,</span> <span class="n">d_params_sds</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">s_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]:</span>
                <span class="n">s_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;decay&quot;</span> <span class="ow">in</span> <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]:</span>
            <span class="n">d_params</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;est_standard_devs&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]:</span>
                <span class="n">d_params_sds</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">][</span><span class="s2">&quot;est_standard_devs&quot;</span><span class="p">])</span>

        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">s_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">s_params_sds</span><span class="p">},</span>
            <span class="s2">&quot;decay&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">d_params</span><span class="p">,</span> <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="n">d_params_sds</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">,</span> <span class="n">is_scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="KBScalingModel.from_data">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.KBScalingModel.from_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">reflection_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the :obj:`KBScalingModel` from data.&quot;&quot;&quot;</span>
        <span class="n">configdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corrections&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">parameters_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">KB</span><span class="o">.</span><span class="n">decay_correction</span><span class="p">:</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;decay&quot;</span><span class="p">)</span>
            <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;decay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
                <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>
        <span class="n">parameters_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
            <span class="s2">&quot;parameter_esds&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">KB</span><span class="o">.</span><span class="n">analytical_correction</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;analytical_correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reflection_table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The reflection table must contain the column &#39;analytical_correction&#39;&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">when using the option analytical_correction=True.&quot;</span>
                <span class="p">)</span>
            <span class="n">configdict</span><span class="p">[</span><span class="s2">&quot;corrections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;analytical&quot;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">,</span> <span class="n">configdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">KB</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fixed_components</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">KB</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">fix</span>
        <span class="k">return</span> <span class="n">model</span></div>
</div>



<div class="viewcode-block" id="calculate_new_offset">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.calculate_new_offset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_new_offset</span><span class="p">(</span>
    <span class="n">current_image_0</span><span class="p">,</span> <span class="n">new_image_0</span><span class="p">,</span> <span class="n">new_norm_fac</span><span class="p">,</span> <span class="n">n_old_param</span><span class="p">,</span> <span class="n">n_new_param</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the parameter offset for the new image range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: An offset to apply when selecting the new parameters from the</span>
<span class="sd">          existing parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_old_param</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># can&#39;t have less than two params</span>
    <span class="n">batch_difference</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_image_0</span> <span class="o">-</span> <span class="n">current_image_0</span><span class="p">)</span> <span class="o">*</span> <span class="n">new_norm_fac</span>
    <span class="n">n_to_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_difference</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_difference</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">n_to_shift</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_old_param</span> <span class="o">-</span> <span class="n">n_new_param</span><span class="p">,</span> <span class="n">n_to_shift</span><span class="p">)</span>  <span class="c1"># can&#39;t shift by more</span></div>

    <span class="c1"># than difference between old and new</span>


<div class="viewcode-block" id="initialise_smooth_input">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.initialise_smooth_input">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initialise_smooth_input</span><span class="p">(</span><span class="n">osc_range</span><span class="p">,</span> <span class="n">one_osc_width</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the required smoother parameters.</span>

<span class="sd">    Using information about the sequence and the chosen parameterisation</span>
<span class="sd">    interval, the required parameters for the smoother are determined.</span>

<span class="sd">    Args:</span>
<span class="sd">        osc_range (tuple): The (start, stop) of an oscillation in degrees.</span>
<span class="sd">        one_osc_width (float): The oscillation width of a single image in degrees.</span>
<span class="sd">        interval (float): The required maximum separation between parameters</span>
<span class="sd">            in degrees.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: 3-element tuple containing;</span>
<span class="sd">            n_params (:obj:`int`): The number of parameters to use.</span>
<span class="sd">            norm_fac (:obj:`float`): The degrees to parameters space normalisation factor.</span>
<span class="sd">            interval (:obj:`float`): The actual interval in degrees between the parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">+=</span> <span class="mf">0.00001</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">interval</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">interval</span><span class="p">:</span>
            <span class="n">rot_int</span> <span class="o">=</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n_param</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rot_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">n_param</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">rot_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">osc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">osc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)</span>
        <span class="n">n_param</span> <span class="o">=</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">norm_fac</span> <span class="o">=</span> <span class="mf">0.999</span> <span class="o">*</span> <span class="n">one_osc_width</span> <span class="o">/</span> <span class="n">rot_int</span>  <span class="c1"># to make sure normalise values</span>
    <span class="c1"># fall within range of smoother.</span>
    <span class="k">return</span> <span class="n">n_param</span><span class="p">,</span> <span class="n">norm_fac</span><span class="p">,</span> <span class="n">rot_int</span></div>



<div class="viewcode-block" id="calc_n_param_from_bins">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.calc_n_param_from_bins">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_n_param_from_bins</span><span class="p">(</span><span class="n">value_min</span><span class="p">,</span> <span class="n">value_max</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the correct number of bins for initialising the gaussian</span>
<span class="sd">    smoothers.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">n_bins</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">value_max</span> <span class="o">-</span> <span class="n">value_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_bins</span>
    <span class="k">if</span> <span class="n">n_bins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n_param</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">n_bins</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">n_param</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_param</span> <span class="o">=</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">n_param</span><span class="p">,</span> <span class="n">bin_width</span></div>



<span class="n">model_phil_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">_dxtbx_scaling_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ep</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">ep</span>
    <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;dxtbx.scaling_model_ext&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">assert</span> <span class="n">_dxtbx_scaling_models</span><span class="p">,</span> <span class="p">(</span>
    <span class="s2">&quot;No models registered with dxtbx.scaling_model_ext entry point&quot;</span>
<span class="p">)</span>
<span class="n">model_phil_scope</span><span class="o">.</span><span class="n">adopt_scope</span><span class="p">(</span>
    <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
        <span class="s2">&quot;model =&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dxtbx_scaling_models</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    .type = choice&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    .help = Set scaling model to be applied to input datasets&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    .expert_level = 0&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">entry_point_name</span><span class="p">,</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="n">_dxtbx_scaling_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ext_master_scope</span> <span class="o">=</span> <span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> .expert_level=1 </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entry_point_name</span><span class="p">)</span>
    <span class="n">ext_phil_scope</span> <span class="o">=</span> <span class="n">ext_master_scope</span><span class="o">.</span><span class="n">get_without_substitution</span><span class="p">(</span><span class="n">entry_point_name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_phil_scope</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">ext_phil_scope</span> <span class="o">=</span> <span class="n">ext_phil_scope</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ext_phil_scope</span><span class="o">.</span><span class="n">adopt_scope</span><span class="p">(</span><span class="n">entry_point</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">phil_scope</span><span class="p">)</span>
    <span class="n">model_phil_scope</span><span class="o">.</span><span class="n">adopt_scope</span><span class="p">(</span><span class="n">ext_master_scope</span><span class="p">)</span>


<div class="viewcode-block" id="plot_scaling_models">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.plot_scaling_models">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_scaling_models</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reflection_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a dict of component plots for the model for plotting with plotly.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">plot_model_components</span><span class="p">(</span><span class="n">reflection_table</span><span class="o">=</span><span class="n">reflection_table</span><span class="p">)</span></div>



<div class="viewcode-block" id="make_combined_plots">
<a class="viewcode-back" href="../../../../../documentation/library_reference/algorithms/dials.algorithms.scaling.html#dials.algorithms.scaling.model.model.make_combined_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_combined_plots</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make any plots that require evaluation of all models.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">id_</span> <span class="o">==</span> <span class="s2">&quot;dose_decay&quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">relative_Bs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">d</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;relative_B&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">plot_relative_Bs</span><span class="p">(</span><span class="n">relative_Bs</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{}</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../national_resource.html">US National Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../../../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../../../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &#169;2025, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>