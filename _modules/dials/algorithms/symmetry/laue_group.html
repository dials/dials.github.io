


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dials.algorithms.symmetry.laue_group &#8212; DIALS  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/dials-styles.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="logoheader container">
  <a href="../../../../index.html">
  <img class="logoheader" alt="DIALS" src="../../../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dials.algorithms.symmetry.laue_group</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Algorithms for determination of Laue group symmetry.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">dials.util</span>
<span class="kn">import</span> <span class="nn">libtbx</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">sgtbx</span>
<span class="kn">from</span> <span class="nn">dials.algorithms.symmetry</span> <span class="kn">import</span> <span class="n">symmetry_base</span>
<span class="kn">from</span> <span class="nn">scitbx.array_family</span> <span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span> <span class="nn">scitbx.math</span> <span class="kn">import</span> <span class="n">five_number_summary</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="LaueGroupAnalysis"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.LaueGroupAnalysis">[docs]</a><span class="k">class</span> <span class="nc">LaueGroupAnalysis</span><span class="p">(</span><span class="n">symmetry_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determination of Laue group symmetry using algorithms similar to POINTLESS.</span>

<span class="sd">    See also:</span>
<span class="sd">      `Evans, P. (2006). Acta Cryst. D62, 72-82</span>
<span class="sd">      &lt;https://doi.org/10.1107/S0907444905036693&gt;`_ and</span>
<span class="sd">      `Evans, P. R. (2011). Acta Cryst. D67, 282-292</span>
<span class="sd">      &lt;https://doi.org/10.1107/S090744491003982X&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">intensities</span><span class="p">,</span>
        <span class="n">normalisation</span><span class="o">=</span><span class="s2">&quot;ml_aniso&quot;</span><span class="p">,</span>
        <span class="n">lattice_symmetry_max_delta</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">d_min</span><span class="o">=</span><span class="n">libtbx</span><span class="o">.</span><span class="n">Auto</span><span class="p">,</span>
        <span class="n">min_i_mean_over_sigma_mean</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">min_cc_half</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">relative_length_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">absolute_angle_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">best_monoclinic_beta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Intialise a LaueGroupAnalysis object.</span>

<span class="sd">        Args:</span>
<span class="sd">          intensities (cctbx.miller.array): The intensities on which to perform</span>
<span class="sd">            symmetry anaylsis.</span>
<span class="sd">          normalisation (str): The normalisation method to use. Possible choices are</span>
<span class="sd">            &#39;kernel&#39;, &#39;quasi&#39;, &#39;ml_iso&#39; and &#39;ml_aniso&#39;. Set to None to switch off</span>
<span class="sd">            normalisation altogether.</span>
<span class="sd">          lattice_symmetry_max_delta (float): The maximum value of delta for</span>
<span class="sd">            determining the lattice symmetry using the algorithm of Le Page (1982).</span>
<span class="sd">          d_min (float): Optional resolution cutoff to be applied to the input</span>
<span class="sd">            intensities. If set to :data:`libtbx.Auto` then d_min will be</span>
<span class="sd">            automatically determined according to the parameters</span>
<span class="sd">            ``min_i_mean_over_sigma_mean`` and ``min_cc_half``.</span>
<span class="sd">          min_i_mean_over_sigma_mean (float): minimum value of |I|/|sigma(i)| for</span>
<span class="sd">            automatic determination of resolution cutoff.</span>
<span class="sd">          min_cc_half (float): minimum value of CC1/2 for automatic determination of</span>
<span class="sd">            resolution cutoff.</span>
<span class="sd">          relative_length_tolerance (float): Relative length tolerance in checking</span>
<span class="sd">            consistency of input unit cells against the median unit cell.</span>
<span class="sd">          absolute_angle_tolerance (float): Absolute angle tolerance in checking</span>
<span class="sd">            consistency of input unit cells against the median unit cell.</span>
<span class="sd">          best_monoclinic_beta (bool): If True, then for monoclinic centered cells, I2</span>
<span class="sd">            will be preferred over C2 if it gives a more oblique cell (i.e. smaller</span>
<span class="sd">            beta angle).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LaueGroupAnalysis</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">intensities</span><span class="p">,</span>
            <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span>
            <span class="n">lattice_symmetry_max_delta</span><span class="o">=</span><span class="n">lattice_symmetry_max_delta</span><span class="p">,</span>
            <span class="n">d_min</span><span class="o">=</span><span class="n">d_min</span><span class="p">,</span>
            <span class="n">min_i_mean_over_sigma_mean</span><span class="o">=</span><span class="n">min_i_mean_over_sigma_mean</span><span class="p">,</span>
            <span class="n">min_cc_half</span><span class="o">=</span><span class="n">min_cc_half</span><span class="p">,</span>
            <span class="n">relative_length_tolerance</span><span class="o">=</span><span class="n">relative_length_tolerance</span><span class="p">,</span>
            <span class="n">absolute_angle_tolerance</span><span class="o">=</span><span class="n">absolute_angle_tolerance</span><span class="p">,</span>
            <span class="n">best_monoclinic_beta</span><span class="o">=</span><span class="n">best_monoclinic_beta</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_cc_sig_fac</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_cc_true</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score_symmetry_elements</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score_laue_groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_estimate_cc_sig_fac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimation of sigma(CC) as a function of sample size.</span>

<span class="sd">        Estimate the error in the correlation coefficient, sigma(CC) by using</span>
<span class="sd">        pairs of reflections at similar resolutions that are not related by</span>
<span class="sd">        potential symmetry. Using pairs of unrelated reflections at similar</span>
<span class="sd">        resolutions, calculate sigma(CC) == rms(CC) for groups of size N = 3..200.</span>
<span class="sd">        The constant CCsigFac is obtained from a linear fit of</span>
<span class="sd">        sigma(CC) to 1/N^(1/2), i.e.:</span>
<span class="sd">            sigma(CC) = CCsigFac/N^(1/2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_bins</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">reflections_per_bin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">200</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="n">max_bins</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">binner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">setup_binner_counting_sorted</span><span class="p">(</span>
            <span class="n">reflections_per_bin</span><span class="o">=</span><span class="n">reflections_per_bin</span>
        <span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">ma_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">customized_copy</span><span class="p">(</span>
            <span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">crystal</span><span class="o">.</span><span class="n">symmetry</span><span class="p">(</span>
                <span class="n">space_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice_group</span><span class="p">,</span>
                <span class="n">unit_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
                <span class="n">assert_is_compatible_unit_cell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">map_to_asu</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binner</span><span class="o">.</span><span class="n">n_bins_all</span><span class="p">()):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">binner</span><span class="o">.</span><span class="n">counts</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">bin_isel</span> <span class="o">=</span> <span class="n">binner</span><span class="o">.</span><span class="n">array_indices</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">random_permutation</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">count</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span>  <span class="c1"># ensure even count</span>
            <span class="n">ma_a</span> <span class="o">=</span> <span class="n">ma_tmp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bin_isel</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span> <span class="n">count</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="n">ma_b</span> <span class="o">=</span> <span class="n">ma_tmp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bin_isel</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">count</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]))</span>
            <span class="c1"># only choose pairs of reflections that don&#39;t have the same indices</span>
            <span class="c1"># in the asu of the lattice group</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">ma_a</span><span class="o">.</span><span class="n">indices</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ma_b</span><span class="o">.</span><span class="n">indices</span><span class="p">()</span>
            <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ma_a</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
            <span class="n">b</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ma_b</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>

        <span class="n">perm</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">random_selection</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">20000</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">corr_unrelated</span> <span class="o">=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">n_pairs</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">min_num_groups</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minimum number of groups</span>
        <span class="n">max_n_group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">n_pairs</span> <span class="o">/</span> <span class="n">min_num_groups</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>  <span class="c1"># maximum number in group</span>
        <span class="n">min_n_group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_n_group</span><span class="p">))</span>  <span class="c1"># minimum number in group</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">max_n_group</span> <span class="o">-</span> <span class="n">min_n_group</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="n">mean_ccs</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">rms_ccs</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_n_group</span><span class="p">,</span> <span class="n">max_n_group</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">ccs</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
                <span class="n">isel</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">random_selection</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">n</span><span class="p">)</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span> <span class="n">b</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">))</span>
                <span class="n">ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">coefficient</span><span class="p">())</span>

            <span class="n">mean_ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ccs</span><span class="p">))</span>
            <span class="n">rms_ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">ccs</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">flex</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rms_ccs</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">linear_regression</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fit</span><span class="o">.</span><span class="n">is_well_defined</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">slope</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_estimate_cc_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># A1.2. Estimation of E(CC; S).</span>

        <span class="c1"># (i)</span>

        <span class="n">var_intensities</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">mean_and_variance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">unweighted_sample_variance</span><span class="p">()</span>
        <span class="n">var_sigmas</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">mean_and_variance</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">sigmas</span><span class="p">()))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E_cc_true</span> <span class="o">=</span> <span class="n">var_intensities</span> <span class="o">/</span> <span class="p">(</span><span class="n">var_intensities</span> <span class="o">+</span> <span class="n">var_sigmas</span><span class="p">)</span>

        <span class="c1"># (ii)</span>

        <span class="n">reindexed_intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span>
            <span class="n">sgtbx</span><span class="o">.</span><span class="n">change_of_basis_op</span><span class="p">(</span><span class="s2">&quot;-x,-y,-z&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">map_to_asu</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">common_sets</span><span class="p">(</span>
            <span class="n">reindexed_intensities</span><span class="p">,</span> <span class="n">assert_is_similar_symmetry</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_identity</span> <span class="o">=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>

        <span class="n">min_sd</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">min_sample</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">sigma_1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_sd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span> <span class="o">/</span> <span class="mi">200</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">sigma_1</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sigma_1</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_identity</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">min_sample</span><span class="p">:</span>
            <span class="n">sigma_2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_sd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_identity</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sigma_2</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">w1</span> <span class="o">+</span> <span class="n">w2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_cc_true</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_identity</span><span class="o">.</span><span class="n">coefficient</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">w1</span> <span class="o">+</span> <span class="n">w2</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cc_true = w1 * E_cc_true + w2 * cc_identity)/(w1 + w2)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;w1: </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;w2: </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;E_cc_true: </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_cc_true</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cc_identity: </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_identity</span><span class="o">.</span><span class="n">coefficient</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cc_true: </span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_true</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_score_symmetry_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_op_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">smx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_group</span><span class="o">.</span><span class="n">smx</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">smx</span><span class="o">.</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">sense</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sym_op_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ScoreSymmetryElement</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="p">,</span> <span class="n">smx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_score_laue_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">subgroup_scores</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ScoreSubGroup</span><span class="p">(</span><span class="n">subgrp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op_scores</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subgrp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="o">.</span><span class="n">result_groups</span>
        <span class="p">]</span>
        <span class="n">total_likelihood</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">subgroup_scores</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">subgroup_scores</span><span class="p">:</span>
            <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">/=</span> <span class="n">total_likelihood</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">subgroup_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">score</span><span class="p">:</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># The &#39;confidence&#39; scores are derived from the total probability of the best</span>
        <span class="c1"># solution p_best and that for the next best solution p_next:</span>
        <span class="c1">#   confidence = [p_best * (p_best - p_next)]^1/2.</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup_scores</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">next_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_scores</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">next_score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lgc</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">*</span> <span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">-</span> <span class="n">next_score</span><span class="o">.</span><span class="n">likelihood</span><span class="p">)</span>
                <span class="n">confidence</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lgc</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">lgc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">confidence</span> <span class="o">=</span> <span class="o">-</span><span class="n">confidence</span>
                <span class="n">score</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="n">confidence</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of the results.</span>

<span class="sd">        Returns:</span>
<span class="sd">          str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Input crystal symmetry:&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">()</span>
                <span class="o">.</span><span class="n">customized_copy</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">median_unit_cell</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Change of basis op to minimum cell: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_op_inp_min</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Crystal symmetry in minimum cell:&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">()))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Lattice point group: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_group</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Overall CC for </span><span class="si">%i</span><span class="s2"> unrelated pairs: </span><span class="si">%.3f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_unrelated</span><span class="o">.</span><span class="n">n</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_unrelated</span><span class="o">.</span><span class="n">coefficient</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;Estimated expectation value of true correlation coefficient E(CC) = </span><span class="si">%.3f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_cc_true</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Estimated sd(CC) = </span><span class="si">%.3f</span><span class="s2"> / sqrt(N)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Too few reflections to estimate sd(CC).&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;Estimated E(CC) of true correlation coefficient from identity = </span><span class="si">%.3f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_true</span>
        <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span> <span class="s2">&quot;Z-CC&quot;</span><span class="p">,</span> <span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Operator&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op_scores</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">elif</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">elif</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">z_cc</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
                    <span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">n_refs</span><span class="p">,</span>
                    <span class="n">stars</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">sym_op</span><span class="o">.</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Scoring individual symmetry elements</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dials</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">))</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Patterson group&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Likelihood&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NetZcc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Zcc+&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Zcc-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CC-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Reindex operator&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_scores</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">elif</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">elif</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;best_subsym&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
                    <span class="n">stars</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">% .2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">z_cc_net</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">% .2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">z_cc_for</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">% .2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">z_cc_against</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">% .2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">cc_for</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
                    <span class="s2">&quot;</span><span class="si">% .2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">cc_against</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
                    <span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">score</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;max_angular_difference&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;cb_op_inp_best&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Scoring all possible sub-groups</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dials</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">))</span>

        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best solution: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;best_subsym&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;Unit cell: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;best_subsym&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;Reindex operator: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;cb_op_inp_best&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Laue group probability: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span><span class="o">.</span><span class="n">likelihood</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Laue group confidence: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span><span class="o">.</span><span class="n">confidence</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<div class="viewcode-block" id="LaueGroupAnalysis.as_dict"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.LaueGroupAnalysis.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary representation of the results.</span>

<span class="sd">        Returns:</span>
<span class="sd">          dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;input_symmetry&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;hall_symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">.</span><span class="n">space_group</span><span class="p">()</span>
                <span class="o">.</span><span class="n">type</span><span class="p">()</span>
                <span class="o">.</span><span class="n">hall_symbol</span><span class="p">(),</span>
                <span class="s2">&quot;unit_cell&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_unit_cell</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
            <span class="p">},</span>
            <span class="s2">&quot;cb_op_inp_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_op_inp_min</span><span class="o">.</span><span class="n">as_xyz</span><span class="p">(),</span>
            <span class="s2">&quot;lattice_point_group&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_group</span><span class="o">.</span><span class="n">type</span><span class="p">()</span><span class="o">.</span><span class="n">hall_symbol</span><span class="p">(),</span>
            <span class="s2">&quot;cc_unrelated_pairs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_unrelated</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
            <span class="s2">&quot;n_unrelated_pairs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_unrelated</span><span class="o">.</span><span class="n">n</span><span class="p">(),</span>
            <span class="s2">&quot;E_cc_true&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_cc_true</span><span class="p">,</span>
            <span class="s2">&quot;cc_sig_fac&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_sig_fac</span><span class="p">,</span>
            <span class="s2">&quot;cc_true&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_true</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sym_op_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op_scores</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;subgroup_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_scores</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="LaueGroupAnalysis.as_json"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.LaueGroupAnalysis.as_json">[docs]</a>    <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a json representation of the results.</span>

<span class="sd">        Args:</span>
<span class="sd">          filename (str): Optional filename to export the json representation of</span>
<span class="sd">            the results.</span>
<span class="sd">          indent (int): The indent level for pretty-printing of the json. If ``None``</span>
<span class="sd">            is the most compact representation.</span>

<span class="sd">        Returns:</span>
<span class="sd">          str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_str</span></div></div>


<div class="viewcode-block" id="ScoreCorrelationCoefficient"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.ScoreCorrelationCoefficient">[docs]</a><span class="k">class</span> <span class="nc">ScoreCorrelationCoefficient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">sigma_cc</span><span class="p">,</span> <span class="n">expected_cc</span><span class="p">,</span> <span class="n">lower_bound</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cc</span> <span class="o">=</span> <span class="n">sigma_cc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_cc</span> <span class="o">=</span> <span class="n">expected_cc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lower_bound</span> <span class="o">=</span> <span class="n">lower_bound</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_upper_bound</span> <span class="o">=</span> <span class="n">upper_bound</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_p_cc_given_s</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_p_cc_given_not_s</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_p_cc_given_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_s</span> <span class="o">=</span> <span class="n">trunccauchy_pdf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lower_bound</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_upper_bound</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expected_cc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cc</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_p_cc_given_not_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sump</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numerator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sumw</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denominator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_not_s</span> <span class="o">=</span> <span class="n">sump</span> <span class="o">/</span> <span class="n">sumw</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p_cc_given_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Probability of observing this CC if the sym op is present, p(CC; S).</span>

<span class="sd">        Modelled by a Cauchy distribution centred on cc_true and width gamma = sigma_cc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p_cc_given_not_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Probability of observing this CC if the sym op is NOT present, p(CC; !S).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_not_s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p_s_given_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The likelihood of this symmetry element being present.</span>

<span class="sd">        p(S; CC) = p(CC; S) / (p(CC; S) + p(CC; !S))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_s</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_cc_given_not_s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_p_mu_power_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nb">pow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_numerator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">trunccauchy_pdf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower_bound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upper_bound</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_cc</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_mu_power_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_denominator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_mu_power_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScoreSymmetryElement"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.ScoreSymmetryElement">[docs]</a><span class="k">class</span> <span class="nc">ScoreSymmetryElement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyse intensities for presence of a given symmetry operation.</span>

<span class="sd">    1) Calculate the correlation coefficient, CC, for the given sym op.</span>

<span class="sd">    2) Calculate the probability of observing this CC if the sym op is present,</span>
<span class="sd">       p(CC; S), modelled by a Cauchy distribution centred on cc_true and width</span>
<span class="sd">       gamma = sigma_cc.</span>

<span class="sd">    3) Calculate the probability of observing this CC if the sym op is</span>
<span class="sd">       NOT present, p(CC; !S).</span>

<span class="sd">    4) Calculate the likelihood of symmetry element being present,</span>
<span class="sd">       p(S; CC) = p(CC; S) / (p(CC; S) + p(CC; !S))</span>

<span class="sd">    See appendix A1 of `Evans, P. R. (2011). Acta Cryst. D67, 282-292.</span>
<span class="sd">    &lt;https://doi.org/10.1107/S090744491003982X&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">sym_op</span><span class="p">,</span> <span class="n">cc_true</span><span class="p">,</span> <span class="n">cc_sig_fac</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise a ScoreSymmetryElement object.</span>

<span class="sd">        Args:</span>
<span class="sd">          intensities (cctbx.miller.array): The intensities on which to perform</span>
<span class="sd">            symmetry anaylsis.</span>
<span class="sd">          sym_op (cctbx.sgtbx.rt_mx): The symmetry operation for analysis.</span>
<span class="sd">          cc_true (float): the expected value of CC if the symmetry element is present,</span>
<span class="sd">            E(CC; S)</span>
<span class="sd">          cc_sig_fac (float): Estimation of sigma(CC) as a function of sample size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span> <span class="o">=</span> <span class="n">sym_op</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="o">.</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">sense</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">()</span>
        <span class="n">cb_op</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">change_of_basis_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="p">)</span>
        <span class="n">cb_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">cb_op</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="o">.</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">order</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># include inverse symmetry operation</span>
            <span class="n">cb_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb_op</span><span class="o">.</span><span class="n">inverse</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">cb_op</span> <span class="ow">in</span> <span class="n">cb_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cb_op</span><span class="o">.</span><span class="n">is_identity_op</span><span class="p">():</span>
                <span class="n">cb_op</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">change_of_basis_op</span><span class="p">(</span><span class="s2">&quot;-x,-y,-z&quot;</span><span class="p">)</span>
            <span class="n">reindexed_intensities</span> <span class="o">=</span> <span class="n">intensities</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">cb_op</span><span class="p">)</span><span class="o">.</span><span class="n">map_to_asu</span><span class="p">()</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">intensities</span><span class="o">.</span><span class="n">common_sets</span><span class="p">(</span>
                <span class="n">reindexed_intensities</span><span class="p">,</span> <span class="n">assert_is_similar_symmetry</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">space_group</span><span class="p">()</span><span class="o">.</span><span class="n">expand_smx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="p">)</span><span class="o">.</span><span class="n">epsilon</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">indices</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>

            <span class="n">outliers</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">()),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">iqr_multiplier</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># very generous tolerance</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">data</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
                    <span class="n">min_x</span><span class="p">,</span> <span class="n">q1_x</span><span class="p">,</span> <span class="n">med_x</span><span class="p">,</span> <span class="n">q3_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">five_number_summary</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="n">iqr_x</span> <span class="o">=</span> <span class="n">q3_x</span> <span class="o">-</span> <span class="n">q1_x</span>
                    <span class="n">cut_x</span> <span class="o">=</span> <span class="n">iqr_multiplier</span> <span class="o">*</span> <span class="n">iqr_x</span>
                    <span class="n">outliers</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">col</span> <span class="o">&gt;</span> <span class="n">q3_x</span> <span class="o">+</span> <span class="n">cut_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">outliers</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">col</span> <span class="o">&lt;</span> <span class="n">q1_x</span> <span class="o">-</span> <span class="n">cut_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outliers</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Rejecting </span><span class="si">%s</span><span class="s2"> outlier value</span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">libtbx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plural_s</span><span class="p">(</span><span class="n">outliers</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)))</span>
                <span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">~</span><span class="n">outliers</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">~</span><span class="n">outliers</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">+=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">n</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_refs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cc_sig_fac</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_refs</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">coefficient</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cc</span>
        <span class="n">score_cc</span> <span class="o">=</span> <span class="n">ScoreCorrelationCoefficient</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_cc</span><span class="p">,</span> <span class="n">cc_true</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_cc_given_s</span> <span class="o">=</span> <span class="n">score_cc</span><span class="o">.</span><span class="n">p_cc_given_s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_cc_given_not_s</span> <span class="o">=</span> <span class="n">score_cc</span><span class="o">.</span><span class="n">p_cc_given_not_s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">score_cc</span><span class="o">.</span><span class="n">p_s_given_cc</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of the symmetry element scoring.</span>

<span class="sd">        Returns:</span>
<span class="sd">          str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%i</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_refs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="o">.</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ScoreSymmetryElement.as_dict"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.ScoreSymmetryElement.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary representation of the symmetry element scoring.</span>

<span class="sd">        The dictionary will contain the following keys:</span>
<span class="sd">          - likelihood: The likelihood of the symmetry element being present</span>
<span class="sd">          - z_cc: The Z-score for the correlation coefficent</span>
<span class="sd">          - cc: The correlation coefficient for the symmetry element</span>
<span class="sd">          - n_ref: The number of reflections contributing to the correlation</span>
<span class="sd">            coefficient</span>
<span class="sd">          - operator: The xyz representation of the symmetry element</span>

<span class="sd">        Returns:</span>
<span class="sd">          dict:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span>
            <span class="s2">&quot;z_cc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cc</span><span class="p">,</span>
            <span class="s2">&quot;cc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
            <span class="s2">&quot;n_ref&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_refs</span><span class="p">,</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_op</span><span class="o">.</span><span class="n">as_xyz</span><span class="p">(),</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="ScoreSubGroup"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.ScoreSubGroup">[docs]</a><span class="k">class</span> <span class="nc">ScoreSubGroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score the probability of a given subgroup being the true subgroup.</span>

<span class="sd">    1) Calculates the combined correlation coefficients for symmetry operations</span>
<span class="sd">       present/absent from the subgroup.</span>

<span class="sd">    2) Calculates overall Zcc scores for symmetry elements present/absent from</span>
<span class="sd">       the subgroup.</span>

<span class="sd">    3) Calculates the overall likelihood for this subgroup.</span>

<span class="sd">    See appendix A2 of `Evans, P. R. (2011). Acta Cryst. D67, 282-292.</span>
<span class="sd">    &lt;https://doi.org/10.1107/S090744491003982X&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subgroup</span><span class="p">,</span> <span class="n">sym_op_scores</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise a ScoreSubGroup object.</span>

<span class="sd">        Args:</span>
<span class="sd">          subgroup (dict): A dictionary describing the subgroup as generated by</span>
<span class="sd">            :class:`cctbx.sgtbx.lattice_symmetry.metric_subgroups`.</span>
<span class="sd">          sym_op_scores (list): A list of :class:`ScoreSymmetryElement` objects for each</span>
<span class="sd">            symmetry element possibly in the lattice symmetry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Combined correlation coefficients for symmetry operations</span>
        <span class="c1"># present/absent from subgroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span> <span class="o">=</span> <span class="n">subgroup</span>
        <span class="n">patterson_group</span> <span class="o">=</span> <span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;subsym&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">space_group</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_for</span> <span class="o">=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_against</span> <span class="o">=</span> <span class="n">CorrelationCoefficientAccumulator</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">sym_op_scores</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">sym_op</span> <span class="ow">in</span> <span class="n">patterson_group</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cc_for</span> <span class="o">+=</span> <span class="n">score</span><span class="o">.</span><span class="n">cc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cc_against</span> <span class="o">+=</span> <span class="n">score</span><span class="o">.</span><span class="n">cc</span>

        <span class="c1"># Overall Zcc scores for symmetry elements present/absent from subgroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_for</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_against</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">PL_for</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">PL_against</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">power</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">sym_op_scores</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">n_refs</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">sym_op</span> <span class="ow">in</span> <span class="n">patterson_group</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span> <span class="o">+=</span> <span class="n">score</span><span class="o">.</span><span class="n">z_cc</span> <span class="o">**</span> <span class="n">power</span>
                <span class="n">n_for</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">PL_for</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">p_cc_given_s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span> <span class="o">+=</span> <span class="n">score</span><span class="o">.</span><span class="n">z_cc</span> <span class="o">**</span> <span class="n">power</span>
                <span class="n">n_against</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">PL_against</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">p_cc_given_not_s</span><span class="p">)</span>

        <span class="c1"># Overall likelihood for this subgroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">PL_for</span> <span class="o">+</span> <span class="n">PL_against</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_against</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span> <span class="o">/</span> <span class="n">n_against</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">power</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_for</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span> <span class="o">/</span> <span class="n">n_for</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">power</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of the subgroup scores.</span>

<span class="sd">        Returns:</span>
<span class="sd">          str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%.3f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;best_subsym&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_net</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_for</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_against</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ScoreSubGroup.as_dict"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.ScoreSubGroup.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary representation of the subgroup scoring.</span>

<span class="sd">        The dictionary will contain the following keys:</span>
<span class="sd">          - patterson_group: The current subgroup</span>
<span class="sd">          - likelihood: The likelihood of the subgroup being correct</span>
<span class="sd">          - confidence: The confidence of the subgroup being correct</span>
<span class="sd">          - z_cc_for: The combined Z-scores for all symmetry elements present in the</span>
<span class="sd">            subgroup</span>
<span class="sd">          - z_cc_against: The combined Z-scores for all symmetry elements present in</span>
<span class="sd">            the lattice group but not in the subgroup</span>
<span class="sd">          - z_cc_net: The net Z-score, i.e. z_cc_for - z_cc_against</span>
<span class="sd">          - cc_for: The overall correlation coefficient for all symmetry elements</span>
<span class="sd">            present in the subgroup</span>
<span class="sd">          - cc_against: The overall correlation coefficient for all symmetry</span>
<span class="sd">            elements present in the lattice group but not in the subgroup</span>
<span class="sd">          - max_angular_difference: The maximum angular difference between the</span>
<span class="sd">            symmetrised unit cell and the P1 unit cell.</span>
<span class="sd">          - cb_op: The change of basis operation from the input unit cell to the</span>
<span class="sd">            &#39;best&#39; unit cell.</span>

<span class="sd">        Returns:</span>
<span class="sd">          dict:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;patterson_group&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;best_subsym&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">space_group</span><span class="p">()</span>
            <span class="o">.</span><span class="n">type</span><span class="p">()</span>
            <span class="o">.</span><span class="n">hall_symbol</span><span class="p">(),</span>
            <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
            <span class="s2">&quot;z_cc_net&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_net</span><span class="p">,</span>
            <span class="s2">&quot;z_cc_for&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_for</span><span class="p">,</span>
            <span class="s2">&quot;z_cc_against&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cc_against</span><span class="p">,</span>
            <span class="s2">&quot;cc_for&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_for</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
            <span class="s2">&quot;cc_against&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_against</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(),</span>
            <span class="s2">&quot;max_angular_difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;max_angular_difference&quot;</span><span class="p">],</span>
            <span class="s2">&quot;cb_op&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup</span><span class="p">[</span><span class="s2">&quot;cb_op_inp_best&quot;</span><span class="p">]),</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="CorrelationCoefficientAccumulator"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.CorrelationCoefficientAccumulator">[docs]</a><span class="k">class</span> <span class="nc">CorrelationCoefficientAccumulator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for incremental computation of correlation coefficients.</span>

<span class="sd">    Uses the single-pass formula for Pearson correlation coefficient:</span>
<span class="sd">      https://en.wikipedia.org/wiki/Pearson_correlation_coefficient#For_a_sample</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise a CorrelationCoefficientAccumulator object.</span>

<span class="sd">        Args:</span>
<span class="sd">          x (list): Optional list of `x` values to initialise the accumulator.</span>
<span class="sd">          y (list): Optional list of `y` values to initialise the accumulator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_xy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x_sq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y_sq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<div class="viewcode-block" id="CorrelationCoefficientAccumulator.accumulate"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.CorrelationCoefficientAccumulator.accumulate">[docs]</a>    <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accumulate the `x` and `y` values provided.</span>

<span class="sd">        Args:</span>
<span class="sd">          x (list): The list of `x` values to accumulate.</span>
<span class="sd">          y (list): The list of `y` values to accumulate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x</span> <span class="o">+=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y</span> <span class="o">+=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_xy</span> <span class="o">+=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x_sq</span> <span class="o">+=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y_sq</span> <span class="o">+=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">y</span><span class="p">))</span></div>

<div class="viewcode-block" id="CorrelationCoefficientAccumulator.coefficient"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.CorrelationCoefficientAccumulator.coefficient">[docs]</a>    <span class="k">def</span> <span class="nf">coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the correlation coefficient.</span>

<span class="sd">        Returns:</span>
<span class="sd">          float: The correlation coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numerator</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">denominator</span><span class="p">()</span></div>

<div class="viewcode-block" id="CorrelationCoefficientAccumulator.n"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.CorrelationCoefficientAccumulator.n">[docs]</a>    <span class="k">def</span> <span class="nf">n</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of values contributing to the correlation coefficient.</span>

<span class="sd">        Returns:</span>
<span class="sd">          n (int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span></div>

<div class="viewcode-block" id="CorrelationCoefficientAccumulator.numerator"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.CorrelationCoefficientAccumulator.numerator">[docs]</a>    <span class="k">def</span> <span class="nf">numerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the numerator of the correlation coefficient formula.</span>

<span class="sd">        .. math:: n \sum{x y} - \sum{x} \sum{y}</span>

<span class="sd">        Returns:</span>
<span class="sd">          float: The value of the numerator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_xy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y</span></div>

<div class="viewcode-block" id="CorrelationCoefficientAccumulator.denominator"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.CorrelationCoefficientAccumulator.denominator">[docs]</a>    <span class="k">def</span> <span class="nf">denominator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the denominator of the correlation coefficient formula.</span>

<span class="sd">        .. math:: \sqrt{n \sum{x^2} - \sum{x}^2} \sqrt{n \sum{y^2} - \sum{y}^2}</span>

<span class="sd">        Returns:</span>
<span class="sd">          float: The value of the denominator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x_sq</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y_sq</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add together two instances of :class:`CorrelationCoefficientAccumulator`.</span>

<span class="sd">        Args:</span>
<span class="sd">          other (CorrelationCoefficientAccumulator):</span>
<span class="sd">            The :class:`CorrelationCoefficientAccumualator` to add to the current object.</span>

<span class="sd">        Returns:</span>
<span class="sd">          self (CorrelationCoefficientAccumulator): The current object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_sum_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_sum_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_xy</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_sum_xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_x_sq</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_sum_x_sq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_y_sq</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">_sum_y_sq</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="trunccauchy_pdf"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.laue_group.trunccauchy_pdf">[docs]</a><span class="k">def</span> <span class="nf">trunccauchy_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate a truncated Cauchy probability density function.</span>

<span class="sd">    Args:</span>
<span class="sd">      x (float): The point at which to calculate the PDF.</span>
<span class="sd">      a (float): The lower bound of the truncated distribution.</span>
<span class="sd">      b (float): The upper bound of the truncated distribution.</span>
<span class="sd">      loc (float): The location parameter for the Cauchy distribution.</span>
<span class="sd">      scale (float): The scale parameter for the Cauchy distribution.</span>

<span class="sd">    Returns:</span>
<span class="sd">      float: The value of the probability density function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">a</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rv</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference external" href="https://dials.github.io/kb">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &copy;2020, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>